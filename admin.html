<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Castle Crew</title>
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        brand: { 
                            red: '#f00000', 
                            black: '#0a0a0a', 
                            dark: '#121212' 
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: white; }

        /* Preloader Styles */
        #preloader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Glow animation for preloader logo */
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="p-8 max-w-7xl mx-auto">

    <div id="preloader"
        class="fixed inset-0 z-[9999] bg-[#050505] flex items-center justify-center transition-opacity duration-700 ease-out">
        <div class="flex flex-col items-center gap-6">
            <div class="relative w-16 h-16 flex items-center justify-center">
                <div class="absolute inset-0 bg-brand-red opacity-50 blur-xl rounded-full animate-pulse-glow"></div>
                <img src="assets/img/logo.png" alt="Castle Cards Logo" class="relative w-12 h-12 z-10" />
            </div>
            <div class="font-black text-xl tracking-[0.2em] text-white animate-pulse">
                ADMIN PANEL
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-10">
        <h1 class="text-3xl font-black uppercase">Admin <span class="text-brand-red">Dashboard</span></h1>
        <div class="flex gap-4">
            <button onclick="loadAdminData()" class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded">Refresh</button>
            <a href="dashboard.html" class="text-sm bg-brand-red px-4 py-2 rounded font-bold">Back to App</a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Total Users</h3>
            <p id="total-users" class="text-4xl font-black mt-2">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Pro/Exec Members</h3>
            <p id="paid-users" class="text-4xl font-black mt-2 text-brand-red">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Enterprise Accounts</h3>
            <p id="enterprise-count" class="text-4xl font-black mt-2 text-blue-500">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">System Status</h3>
            <p class="text-4xl font-black mt-2 text-green-500">Active</p>
        </div>
    </div>

    <h2 class="text-2xl font-black uppercase mb-6 mt-12 text-blue-500">Enterprise Management</h2>

    <div id="enterprise-management-panel" class="bg-brand-dark rounded-xl border border-gray-800 overflow-hidden mb-12">
        <div class="p-4 bg-black flex justify-between items-center border-b border-gray-800">
            <h3 class="text-white font-bold text-lg">Super Admin Accounts</h3>
            <button onclick="openCreateEnterpriseModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-blue-600 transition">
                + CREATE NEW ENTERPRISE
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-400">
                <thead class="bg-black text-white uppercase text-xs font-bold">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">Company Name</th>
                        <th class="p-4">Super Admin Email</th>
                        <th class="p-4">Total Staff</th>
                        <th class="p-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="enterprise-list">
                    <tr><td class="p-4" colspan="5">Loading enterprise accounts...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <h2 class="text-2xl font-black uppercase mb-6 mt-12 text-brand-red">Individual Users</h2>

    <div class="bg-brand-dark rounded-xl border border-gray-800 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-400">
                <thead class="bg-black text-white uppercase text-xs font-bold">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">Email</th>
                        <th class="p-4">Castle Link (Slug)</th> 
                        <th class="p-4">Plan</th>
                        <th class="p-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <tr><td class="p-4" colspan="5">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-[#111] w-full max-w-sm p-6 rounded-2xl border border-gray-800 shadow-2xl relative">
            <h2 class="text-xl font-bold mb-1">Manage User</h2>
            <p id="modal-email" class="text-xs text-gray-500 mb-6">user@email.com</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-2">Change Plan</label>
                    <select id="plan-select" class="w-full bg-black border border-gray-700 rounded p-2 text-sm focus:border-brand-red focus:outline-none">
                        <option value="starter">Starter (Free)</option>
                        <option value="professional">Professional</option>
                        <option value="executive">Executive</option>
                        <option value="enterprise">Enterprise</option> </select>
                </div>

                <button onclick="saveUserChanges()" class="w-full bg-brand-red text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">SAVE CHANGES</button>
                
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <button onclick="deleteUser()" class="w-full text-red-500 text-xs font-bold hover:text-red-400">DELETE USER PERMANENTLY</button>
                </div>
            </div>

            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">✕</button>
        </div>
    </div>

    <script>
        // *** SIMULATED DATA FOR ENTERPRISE (API needed for real data) ***
        let enterpriseAccounts = [
            { id: 101, companyName: 'Acme Corp.', superAdminEmail: 'ceo@acmecorp.com', totalStaff: 45 },
            { id: 102, companyName: 'Global Solutions', superAdminEmail: 'admin@globalsol.net', totalStaff: 12 },
        ];

        // *** START SCRIPT LOGIC ***
        let currentUserId = null;

        // Preloader Logic
        document.addEventListener('DOMContentLoaded', () => {
            const preloader = document.getElementById('preloader');
            setTimeout(() => {
                preloader.classList.add('fade-out');
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 700);
            }, 800);
            loadAdminData(); // Initial load when DOM is ready
        });

        // Helper function for plan badges
        function getPlanBadge(plan) {
            if(plan === 'enterprise') return 'bg-blue-500/20 text-blue-500 px-2 py-1 rounded text-xs uppercase font-bold';
            if(plan === 'executive') return 'bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded text-xs uppercase font-bold';
            if(plan === 'professional') return 'bg-brand-red/20 text-brand-red px-2 py-1 rounded text-xs uppercase font-bold';
            return 'bg-gray-800 text-gray-400 px-2 py-1 rounded text-xs uppercase font-bold';
        }

        // 1. Fetch Users & Populate Tables (Integrated with your existing APIs)
        async function loadAdminData() {
            try {
                // *** 1. INDIVIDUAL USERS TABLE & STATS ***
                // Fetches data from your existing /api/admin/users endpoint (users.js)
                const usersRes = await fetch('/api/admin/users');
                
                if (!usersRes.ok) {
                    throw new Error(`Failed to fetch users: ${usersRes.status}`);
                }
                
                const users = await usersRes.json(); // Array of user objects

                if (!users || !users.length) {
                     document.getElementById('user-list').innerHTML = '<tr><td class="p-4" colspan="5">No individual users found.</td></tr>';
                }

                document.getElementById('total-users').innerText = users.length || 0;
                const paidCount = users.filter(u => u.plan === 'professional' || u.plan === 'executive').length;
                document.getElementById('paid-users').innerText = paidCount;
                
                const userHtml = users.map(user => `
                    <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                        <td class="p-4 font-mono text-xs">#${user.id}</td>
                        <td class="p-4 text-white font-bold">${user.email}</td>
                        <td class="p-4">
                            ${user.slug 
                                ? `<a href="/${user.slug}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i class="bi bi-box-arrow-up-right"></i> /${user.slug}</a>` 
                                : '<span class="text-gray-600">Not set</span>'}
                        </td>
                        <td class="p-4">
                            <span class="${getPlanBadge(user.plan)}">${user.plan || 'starter'}</span>
                        </td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="loginAsUser(${user.id})" title="Login as User" class="bg-gray-800 text-white w-8 h-8 rounded flex items-center justify-center hover:bg-white hover:text-black transition">
                                <i class="bi bi-key-fill"></i>
                            </button>
                            <button onclick="openModal(${user.id}, '${user.email}', '${user.plan || 'starter'}')" class="bg-brand-red/10 text-brand-red px-3 py-1.5 rounded text-xs font-bold hover:bg-brand-red/20 transition">
                                MANAGE
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('user-list').innerHTML = userHtml;
                
                // *** 2. ENTERPRISE ACCOUNTS TABLE & STATS ***
                // Using simulated data until a new API (e.g., /api/admin/enterprises) is ready
                const enterprises = enterpriseAccounts; 
                
                document.getElementById('enterprise-count').innerText = enterprises.length;
                
                const enterpriseHtml = enterprises.map(ent => `
                    <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                        <td class="p-4 font-mono text-xs">#${ent.id}</td>
                        <td class="p-4 text-white font-bold">${ent.companyName}</td>
                        <td class="p-4">${ent.superAdminEmail}</td>
                        <td class="p-4 text-center">${ent.totalStaff}</td>
                        <td class="p-4 text-right flex justify-end gap-2">
                            <button onclick="loginAsEnterprise(${ent.id})" title="Login as Enterprise Super Admin" class="bg-blue-500 text-white w-8 h-8 rounded flex items-center justify-center hover:bg-blue-600 transition">
                                <i class="bi bi-buildings-fill"></i>
                            </button>
                            <button onclick="openManageEnterpriseModal(${ent.id})" class="bg-brand-red/10 text-brand-red px-3 py-1.5 rounded text-xs font-bold hover:bg-brand-red/20 transition">
                                MANAGE
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('enterprise-list').innerHTML = enterpriseHtml;


            } catch(e) {
                console.error("Failed to load admin data:", e);
                // Ensure users see loading failure message
                document.getElementById('user-list').innerHTML = '<tr><td class="p-4 text-red-500" colspan="5">Failed to load individual users. Please check your deployment/API connectivity.</td></tr>';
                document.getElementById('enterprise-list').innerHTML = '<tr><td class="p-4 text-red-500" colspan="5">Failed to load enterprises. (Simulated/API Check)</td></tr>';
            }
        }

        // *** ENTERPRISE PLACEHOLDER FUNCTIONS ***
        function openCreateEnterpriseModal() {
            alert("Functionality to create a new Enterprise Super Admin will be implemented here.");
        }

        function openManageEnterpriseModal(id) {
            alert("Functionality to manage Enterprise ID #" + id + "'s settings will be implemented here (Requires new API endpoint, e.g., /api/admin/update-enterprise).");
        }

        async function loginAsEnterprise(id) {
            if(!confirm("Are you sure you want to log in as Enterprise Super Admin #" + id + "? You will be signed out of Main Admin.")) return;
            // NOTE: This will require a new API endpoint, e.g., /api/admin/login-as-enterprise
            console.log("Simulating login as Enterprise Super Admin ID:", id);
            // window.location.href = 'enterprise_super_admin_dashboard.html'; 
        }
        
        // *** INDIVIDUAL USER FUNCTIONS (Uses existing backend files) ***
        async function loginAsUser(id) {
            if(!confirm("Are you sure you want to log in as user #" + id + "? You will be signed out of Admin.")) return;
            
            // NOTE: Uses existing backend file: api/admin/login-as.js
            try {
                const res = await fetch('/api/admin/login-as', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: id })
                });
                const data = await res.json();

                if (data.success) {
                    // Set token and redirect
                    localStorage.setItem('castle_token', data.token);
                    window.location.href = 'dashboard.html'; // Go to their dashboard
                } else {
                    alert("Failed to generate token");
                }
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        function openModal(id, email, plan) {
            currentUserId = id;
            document.getElementById('modal-email').innerText = email;
            document.getElementById('plan-select').value = plan;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            currentUserId = null;
        }

        async function saveUserChanges() {
            if(!currentUserId) return;
            const newPlan = document.getElementById('plan-select').value;
            const btn = document.querySelector('#edit-modal button.bg-brand-red');
            const originalText = btn.innerText;
            btn.innerText = "SAVING...";

            // NOTE: Uses existing backend file: api/admin/update-user.js
            try {
                const res = await fetch('/api/admin/update-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, plan: newPlan })
                });

                if(res.ok) {
                    alert("Plan Updated Successfully!");
                    closeModal();
                    loadAdminData(); 
                } else {
                    alert("Failed to update.");
                }
            } catch(e) { alert("Error"); }
            btn.innerText = originalText;
        }

        async function deleteUser() {
            if(!confirm("Are you sure? This will delete the user and their card forever.")) return;
            
            // NOTE: Uses existing backend file: api/admin/update-user.js
            try {
                const res = await fetch('/api/admin/update-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, action: 'delete' })
                });

                if(res.ok) {
                    alert("User Deleted.");
                    closeModal();
                    loadAdminData();
                } else {
                    alert("Failed to delete.");
                }
            } catch(e) { alert("Error"); }
        }
    </script>

</body>
</html>