<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castle Crew Profile</title>
    <meta name="theme-color" content="#0a0a0a">
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { red: '#f00000', black: '#0a0a0a' } },
                    animation: { 'fade-in-up': 'fadeInUp 0.8s ease-out forwards' },
                    keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>body { background-color: #050505; color: white; -webkit-tap-highlight-color: transparent; }</style>
</head>
<body class="min-h-screen flex justify-center bg-[#111]">

    <div class="w-full max-w-md bg-[#050505] min-h-screen shadow-2xl relative flex flex-col">
        
        <!-- HEADER -->
        <div class="h-48 bg-gradient-to-br from-brand-red/30 to-black relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-brand-red blur-[80px] opacity-50"></div>
            <div class="absolute top-6 right-6 text-brand-red font-bold tracking-tighter text-xs flex items-center gap-1 opacity-80">
                <div class="w-2 h-2 bg-brand-red rotate-45"></div>
                CASTLE
            </div>
        </div>

        <!-- PROFILE CONTENT -->
        <div class="px-8 -mt-20 relative z-10 flex-1 pb-12">
            
            <!-- Avatar -->
            <div class="w-36 h-36 rounded-full border-4 border-[#050505] bg-gray-800 overflow-hidden mb-6 shadow-2xl relative z-20 animate-fade-in-up">
                <img id="p-avatar" src="assets/img/logo.png" class="w-full h-full object-cover">
            </div>

            <!-- Text Info -->
            <div class="animate-fade-in-up" style="animation-delay: 0.1s;">
                <h1 id="p-name" class="text-4xl font-black uppercase leading-[0.9] mb-2 tracking-tight">Loading...</h1>
                <p id="p-job" class="text-brand-red font-bold text-base mb-6 tracking-wide">...</p>
                <p id="p-bio" class="text-gray-400 text-sm leading-relaxed mb-8 border-l-2 border-gray-800 pl-4">...</p>
            </div>

            <!-- BUTTONS -->
            <div class="grid grid-cols-2 gap-4 mb-10 animate-fade-in-up" style="animation-delay: 0.2s;">
                <button onclick="downloadVCF()" class="bg-white text-black py-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition shadow-lg active:scale-95">
                    Save Contact
                </button>
                <button onclick="toggleModal(true)" class="bg-brand-red text-white py-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-700 transition shadow-lg active:scale-95">
                    Exchange
                </button>
            </div>

            <!-- LINKS -->
            <div class="space-y-4 animate-fade-in-up" style="animation-delay: 0.3s;">
                <a id="link-email" href="#" class="group flex items-center gap-5 p-5 bg-[#111] rounded-2xl border border-gray-900/50 hidden">
                    <div class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-xl">✉</div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold">Email</div><div id="p-email" class="text-base font-medium">...</div></div>
                </a>
                <a id="link-phone" href="#" class="group flex items-center gap-5 p-5 bg-[#111] rounded-2xl border border-gray-900/50 hidden">
                    <div class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-xl">📞</div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold">Phone</div><div id="p-phone" class="text-base font-medium">...</div></div>
                </a>
                <a id="link-web" href="#" target="_blank" class="group flex items-center gap-5 p-5 bg-[#111] rounded-2xl border border-gray-900/50 hidden">
                    <div class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-xl">🌐</div>
                    <div><div class="text-[10px] text-gray-500 uppercase font-bold">Website</div><div id="p-web" class="text-base font-medium">...</div></div>
                </a>
            </div>

        </div>
    </div>
    
    <!-- Exchange Modal (Hidden) -->
    <div id="exchange-modal" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden">
        <div onclick="toggleModal(false)" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="bg-[#111] w-full max-w-sm rounded-2xl border border-gray-800 p-6 relative z-10 shadow-2xl">
            <button onclick="toggleModal(false)" class="absolute top-4 right-4 text-gray-500">✕</button>
            <h2 class="text-2xl font-black uppercase mb-1">Share Info</h2>
            <p class="text-gray-400 text-xs mb-6">Connect with <span id="modal-name">us</span>.</p>
            <form onsubmit="event.preventDefault(); alert('Lead Sent!'); toggleModal(false);" class="space-y-4">
                <input type="text" placeholder="Your Name" class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-sm focus:border-brand-red focus:outline-none">
                <input type="email" placeholder="Email" class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-sm focus:border-brand-red focus:outline-none">
                <button class="w-full bg-white text-black font-bold py-3 rounded-lg">SEND</button>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // Global object to store fetched data for VCF
        let cardData = {};

        // 1. Fetch Data on Load
        window.addEventListener('load', async () => {
            
            // --- NEW URL DETECTION LOGIC ---
            // 1. Try to get slug from path (e.g. /venura)
            let slug = window.location.pathname.replace(/^\/+|\/+$/g, ''); 

            // 2. If path is a system file (like card.html) or empty, check for ?id= query param
            if (!slug || slug.includes('.html') || slug === 'index') {
                const urlParams = new URLSearchParams(window.location.search);
                slug = urlParams.get('id');
            }

            // 3. If no slug found, show error
            if (!slug) {
                document.getElementById('p-name').innerHTML = "User Not Found";
                document.getElementById('p-bio').innerHTML = "Please check the URL.";
                return;
            }

            try {
                // Call the API with the dynamic slug
                const response = await fetch(`/api/public/${slug}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                cardData = data; // Store for VCF

                // Update UI
                document.title = (data.full_name || "Profile") + " - Castle Cards";
                document.getElementById('p-name').innerHTML = (data.full_name || "").replace(' ', '<br>');
                
                const jobInfo = [data.job_title, data.company].filter(Boolean).join(" • ");
                document.getElementById('p-job').textContent = jobInfo;
                
                document.getElementById('p-bio').textContent = data.bio || "";
                document.getElementById('modal-name').textContent = data.full_name || "us";

                // Update Links (Only show if data exists)
                if (data.email) {
                    document.getElementById('p-email').textContent = data.email;
                    document.getElementById('link-email').href = "mailto:" + data.email;
                    document.getElementById('link-email').classList.remove('hidden');
                    document.getElementById('link-email').classList.add('flex');
                }

                if (data.phone) {
                    document.getElementById('p-phone').textContent = data.phone;
                    document.getElementById('link-phone').href = "tel:" + data.phone;
                    document.getElementById('link-phone').classList.remove('hidden');
                    document.getElementById('link-phone').classList.add('flex');
                }

                if (data.website) {
                    document.getElementById('p-web').textContent = data.website.replace(/^https?:\/\//, '');
                    document.getElementById('link-web').href = data.website.startsWith('http') ? data.website : 'https://' + data.website;
                    document.getElementById('link-web').classList.remove('hidden');
                    document.getElementById('link-web').classList.add('flex');
                }

            } catch (err) {
                console.error("Error loading profile", err);
                document.getElementById('p-name').innerHTML = "Not Found";
                document.getElementById('p-job').innerHTML = "This profile does not exist.";
                document.getElementById('p-bio').innerHTML = "";
            }
        });

        // 2. VCF Logic
        function downloadVCF() {
            if (!cardData.full_name) return; // Wait for data

            const vcard = [
                "BEGIN:VCARD", "VERSION:3.0", 
                `FN:${cardData.full_name || ""}`, 
                `ORG:${cardData.company || ""}`,
                `TITLE:${cardData.job_title || ""}`, 
                `TEL;TYPE=CELL:${cardData.phone || ""}`,
                `EMAIL;TYPE=WORK:${cardData.email || ""}`, 
                `URL:${cardData.website || ""}`, 
                "END:VCARD"
            ].join("\n");

            const blob = new Blob([vcard], { type: "text/vcard" });
            const url = URL.createObjectURL(blob);
            const newLink = document.createElement('a');
            newLink.download = (cardData.full_name || "contact").replace(' ', '_') + ".vcf";
            newLink.href = url;
            newLink.click();
        }

        function toggleModal(show) {
            const modal = document.getElementById('exchange-modal');
            modal.classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>