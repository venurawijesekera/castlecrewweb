<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Super Admin - Acme Corp</title>
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { red: '#f00000', black: '#0a0a0a', dark: '#121212' } }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: white;
        }

        /* Preloader Styles */
        #preloader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .hidden-element {
            display: none !important;
        }
    </style>
</head>

<body class="p-8 max-w-7xl mx-auto">

    <div id="preloader"
        class="fixed inset-0 z-[9999] bg-[#050505] flex items-center justify-center transition-opacity duration-700 ease-out">
        <div class="flex flex-col items-center gap-6">
            <div class="relative w-16 h-16 flex items-center justify-center">
                <div class="absolute inset-0 bg-brand-red opacity-50 blur-xl rounded-full animate-pulse-glow"></div>
                <img src="assets/img/logo.png" alt="Castle Cards Logo" class="relative w-12 h-12 z-10" />
            </div>
            <div class="font-black text-xl tracking-[0.2em] text-white animate-pulse">
                ENTERPRISE DASHBOARD
            </div>
        </div>
    </div>

    <div class="flex justify-between items-center mb-10">
        <h1 class="text-3xl font-black uppercase"><span id="company-name">Acme Corp</span> <span
                class="text-blue-500">Dashboard</span></h1>
        <div class="flex gap-4">
            <button onclick="loadDashboardData()"
                class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded">Refresh</button>
            <a href="profile.html" class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded font-bold">Back to
                Profile</a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Total Staff Licenses</h3>
            <p id="total-licenses" class="text-4xl font-black mt-2 text-blue-500">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Active Staff Cards</h3>
            <p id="active-staff" class="text-4xl font-black mt-2">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Total Card Views</h3>
            <p id="total-views" class="text-4xl font-black mt-2 text-brand-red">...</p>
        </div>
        <div class="bg-brand-dark p-6 rounded-xl border border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase">Leads Generated</h3>
            <p id="total-leads" class="text-4xl font-black mt-2 text-green-500">...</p>
        </div>
    </div>

    <h2 class="text-2xl font-black uppercase mb-6 mt-12">Delegated <span class="text-brand-red">Admins</span></h2>

    <div class="bg-brand-dark rounded-xl border border-gray-800 overflow-hidden mb-12">
        <div class="p-4 bg-black flex justify-between items-center border-b border-gray-800">
            <h3 class="text-white font-bold text-lg">Admin Accounts</h3>
            <button onclick="openCreateAdminModal()"
                class="bg-brand-red text-white px-3 py-1.5 rounded text-sm font-bold hover:bg-red-700 transition">
                + ADD NEW ADMIN
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-400">
                <thead class="bg-black text-white uppercase text-xs font-bold">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">Email / Name</th>
                        <th class="p-4">Staff Managed</th>
                        <th class="p-4">Last Login</th>
                        <th class="p-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-list">
                    <tr>
                        <td class="p-4" colspan="5">Loading admins...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <h2 class="text-2xl font-black uppercase mb-6 mt-12">All <span class="text-blue-500">Staff Users</span></h2>

    <div class="bg-brand-dark rounded-xl border border-gray-800 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-400">
                <thead class="bg-black text-white uppercase text-xs font-bold">
                    <tr>
                        <th class="p-4">ID</th>
                        <th class="p-4">Email / Name</th>
                        <th class="p-4">Link (Slug)</th>
                        <th class="p-4">Assigned Admin</th>
                        <th class="p-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="staff-user-list">
                    <tr>
                        <td class="p-4" colspan="5">Loading staff users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="create-admin-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden-element flex items-center justify-center z-50">
        <div class="bg-[#111] w-full max-w-sm p-6 rounded-2xl border border-gray-800 shadow-2xl relative">
            <h2 class="text-xl font-bold mb-6">Create New Admin</h2>

            <form onsubmit="event.preventDefault(); createAdmin();" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Full Name</label>
                    <input type="text" id="new-admin-name" required
                        class="w-full bg-brand-dark border border-gray-800 rounded px-3 py-2 text-white focus:border-brand-red focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email Address</label>
                    <input type="email" id="new-admin-email" required
                        class="w-full bg-brand-dark border border-gray-800 rounded px-3 py-2 text-white focus:border-brand-red focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label>
                    <input type="password" id="new-admin-password" required
                        class="w-full bg-brand-dark border border-gray-800 rounded px-3 py-2 text-white focus:border-brand-red focus:outline-none">
                </div>

                <div class="pt-2">
                    <button type="submit" id="btn-create-admin"
                        class="w-full bg-brand-red text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">
                        CREATE ADMIN
                    </button>
                    <p id="create-admin-error" class="text-red-500 text-xs mt-2 hidden"></p>
                </div>
            </form>
            <button onclick="closeCreateAdminModal()"
                class="absolute top-4 right-4 text-gray-500 hover:text-white">✕</button>
        </div>
    </div>

    <div id="manage-admin-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden-element flex items-center justify-center z-50">
        <div class="bg-[#111] w-full max-w-sm p-6 rounded-2xl border border-gray-800 shadow-2xl relative">
            <h2 class="text-xl font-bold mb-1">Manage Admin</h2>
            <p id="admin-modal-email" class="text-xs text-gray-500 mb-6">admin@email.com</p>

            <div class="space-y-4">
                <p class="text-sm text-gray-400">Manage their access permissions here.</p>
                <button onclick="saveAdminChanges()"
                    class="w-full bg-brand-red text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">SAVE
                    CHANGES</button>
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <button onclick="deleteAdmin()"
                        class="w-full text-red-500 text-xs font-bold hover:text-red-400">REMOVE ADMIN
                        PERMANENTLY</button>
                </div>
            </div>
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">✕</button>
        </div>
    </div>

    <script>
        // *** CORE DASHBOARD LOGIC ***

        // *** CORE DASHBOARD LOGIC ***

        document.addEventListener('DOMContentLoaded', () => {
            // Remove preloader
            const preloader = document.getElementById('preloader');
            setTimeout(() => {
                preloader.classList.add('fade-out');
                setTimeout(() => { preloader.style.display = 'none'; }, 700);
            }, 500);

            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const res = await fetch('/api/enterprise/dashboard');
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) window.location.href = 'login.html';
                    throw new Error("Failed to fetch data");
                }
                const data = await res.json();

                // 1. Company Info
                document.getElementById('company-name').innerText = data.company.name;

                // 2. Stats
                document.getElementById('total-licenses').innerText = data.company.license_count;
                document.getElementById('active-staff').innerText = data.stats.active_staff_count;
                document.getElementById('total-views').innerText = data.stats.total_views.toLocaleString();
                document.getElementById('total-leads').innerText = data.stats.total_leads.toLocaleString();

                // 3. Admins List
                const admins = data.admins || [];
                if (admins.length === 0) {
                    document.getElementById('admin-list').innerHTML = '<tr><td class="p-4" colspan="5">No delegated admins found.</td></tr>';
                } else {
                    const adminHtml = admins.map(admin => `
                        <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                            <td class="p-4 font-mono text-xs">#${admin.id}</td>
                            <td class="p-4 text-white font-bold">${admin.name || 'No Name'}<br><span class="text-xs text-gray-500">${admin.email}</span></td>
                            <td class="p-4">${admin.staff_managed}</td>
                            <td class="p-4">${admin.last_login}</td>
                            <td class="p-4 text-right">
                                <button onclick="openManageAdminModal(${admin.id}, '${admin.email}')" class="bg-brand-red/10 text-brand-red px-3 py-1.5 rounded text-xs font-bold hover:bg-brand-red/20 transition">
                                    MANAGE
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    document.getElementById('admin-list').innerHTML = adminHtml;
                }

                // 4. Staff List
                const staff = data.staff || [];
                if (staff.length === 0) {
                    document.getElementById('staff-user-list').innerHTML = '<tr><td class="p-4" colspan="5">No staff users found.</td></tr>';
                } else {
                    const staffHtml = staff.map(user => `
                        <tr class="border-b border-gray-800 hover:bg-white/5 transition">
                            <td class="p-4 font-mono text-xs">#${user.id}</td>
                            <td class="p-4 text-white font-bold">${user.name || 'No Name'}<br><span class="text-xs text-gray-500">${user.email}</span></td>
                            <td class="p-4">
                                ${user.slug ? `<a href="/${user.slug}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i class="bi bi-box-arrow-up-right"></i> /${user.slug}</a>` : '<span class="text-gray-600">No Card</span>'}
                            </td>
                            <td class="p-4">${admins.find(a => a.id === user.assigned_admin_id)?.name || 'Unassigned'}</td>
                            <td class="p-4 text-right">
                                <button onclick="manageStaffUser(${user.id})" class="bg-brand-red/10 text-brand-red px-3 py-1.5 rounded text-xs font-bold hover:bg-brand-red/20 transition">
                                    MANAGE
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    document.getElementById('staff-user-list').innerHTML = staffHtml;
                }

            } catch (e) {
                console.error("Failed to load Enterprise data:", e);
                // alert("Failed to load dashboard data. Check API.");
            }
        }


        // *** ADMIN MANAGEMENT MODAL LOGIC ***
        function openCreateAdminModal() {
            document.getElementById('create-admin-modal').classList.remove('hidden-element');
        }

        function closeCreateAdminModal() {
            document.getElementById('create-admin-modal').classList.add('hidden-element');
            document.getElementById('new-admin-name').value = '';
            document.getElementById('new-admin-email').value = '';
            document.getElementById('new-admin-password').value = '';
            document.getElementById('create-admin-error').innerText = '';
            document.getElementById('create-admin-error').classList.add('hidden');
        }

        async function createAdmin() {
            const btn = document.getElementById('btn-create-admin');
            const errorMsg = document.getElementById('create-admin-error');
            const name = document.getElementById('new-admin-name').value;
            const email = document.getElementById('new-admin-email').value;
            const password = document.getElementById('new-admin-password').value;

            btn.disabled = true;
            btn.innerText = "Creating...";
            errorMsg.classList.add('hidden');

            try {
                const res = await fetch('/api/enterprise/create-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json();

                if (data.success) {
                    closeCreateAdminModal();
                    loadDashboardData(); // Refresh list
                    alert("Admin created successfully!");
                } else {
                    throw new Error(data.error || "Failed to create admin");
                }
            } catch (e) {
                errorMsg.innerText = e.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = "CREATE ADMIN";
            }
        }

        function openManageAdminModal(id, email) {
            currentAdminId = id;
            document.getElementById('admin-modal-email').innerText = email;
            document.getElementById('manage-admin-modal').classList.remove('hidden-element');
        }

        function closeAdminModal() {
            document.getElementById('manage-admin-modal').classList.add('hidden-element');
            currentAdminId = null;
        }

        async function saveAdminChanges() {
            if (!currentAdminId) return;
            alert(`Simulating save changes for Admin #${currentAdminId}. (Requires new API endpoint: /api/enterprise/update-admin)`);
            closeAdminModal();
            loadDashboardData();
        }

        async function deleteAdmin() {
            if (!confirm("Are you sure? This will remove the delegated Admin role.")) return;
            alert(`Simulating deletion of Admin #${currentAdminId}. (Requires new API endpoint: /api/enterprise/update-admin)`);
            closeAdminModal();
            loadDashboardData();
        }

        // *** STAFF USER MANAGEMENT LOGIC ***
        function manageStaffUser(id) {
            alert(`Managing Staff User #${id}. This would link to a detailed page or open a modal allowing the Super Admin to update user details, plan, or reassign them to a Delegated Admin.`);
            // In a real app, this would redirect to a user-specific management page:
            // window.location.href = `enterprise_staff_user_management.html?id=${id}`;
        }
    </script>

</body>

</html>