<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Car Finance Offer</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: { 'card': '0 20px 40px -10px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .car-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Preloader -->
    <div id="preloader"
        class="fixed inset-0 bg-white flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="animate-pulse flex flex-col items-center">
            <div class="w-12 h-12 bg-gray-200 rounded-full mb-4"></div>
            <div class="h-4 w-32 bg-gray-200 rounded"></div>
        </div>
    </div>

    <div id="card-container" class="w-full max-w-sm car-card opacity-0 transition-opacity duration-700">

        <!-- Hero Image Part -->
        <div class="relative h-72 bg-gray-100">
            <img id="p-image" src="assets/img/logo.png" class="w-full h-full object-cover">

            <!-- Floating Badge (e.g. Best Seller) -->
            <div id="badge"
                class="absolute top-4 left-4 bg-black/80 backdrop-blur text-white text-[10px] font-bold px-3 py-1.5 rounded-full uppercase tracking-wider">
                Special Offer
            </div>

            <!-- Agent/Company Logo (Small, Top Right) -->
            <div class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white p-1 shadow-lg">
                <img src="assets/img/logo.png" class="w-full h-full object-contain rounded-full">
            </div>
        </div>

        <!-- Details Part -->
        <div class="p-6 relative">

            <!-- Paginator Dots (Visual only for now) -->
            <div class="flex justify-center gap-1.5 mb-6 absolute -top-4 left-0 right-0">
                <div class="w-1.5 h-1.5 rounded-full bg-white shadow"></div>
                <div class="w-1.5 h-1.5 rounded-full bg-white/50 shadow"></div>
                <div class="w-1.5 h-1.5 rounded-full bg-white/50 shadow"></div>
            </div>

            <div class="mb-6">
                <h1 id="p-title" class="text-2xl font-black text-gray-900 leading-tight mb-1">Loading...</h1>
                <p id="p-subtitle" class="text-gray-500 font-medium">...</p>
            </div>

            <div class="mb-8">
                <p id="p-desc" class="text-gray-400 text-sm leading-relaxed">...</p>
            </div>

            <!-- Price & Action -->
            <div class="flex items-center justify-between">
                <div>
                    <span id="p-price" class="block text-2xl font-black text-gray-900">$0</span>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Monthly Payment</span>
                </div>
                <button onclick="toggleModal(true)"
                    class="bg-black text-white px-6 py-3 rounded-full font-bold text-sm hover:scale-105 active:scale-95 transition flex items-center gap-2">
                    Get Offer <i class="bi bi-arrow-up-right"></i>
                </button>
            </div>

            <!-- Contact/Broker Footer -->
            <div class="mt-8 pt-6 border-t border-gray-100 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-100 overflow-hidden">
                    <!-- This could be the broker's avatar -->
                    <img id="broker-avatar" src="assets/img/logo.png" class="w-full h-full object-cover">
                </div>
                <div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Financing Agent</p>
                    <p id="broker-name" class="text-xs font-bold text-gray-900">...</p>
                </div>
                <div class="ml-auto flex gap-2">
                    <a id="btn-call" href="#"
                        class="w-8 h-8 rounded-full bg-gray-50 text-gray-600 flex items-center justify-center hover:bg-black hover:text-white transition"><i
                            class="bi bi-telephone-fill"></i></a>
                    <a id="btn-wa" href="#" target="_blank"
                        class="w-8 h-8 rounded-full bg-gray-50 text-gray-600 flex items-center justify-center hover:bg-[#25D366] hover:text-white transition"><i
                            class="bi bi-whatsapp"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="exchange-modal"
        class="fixed inset-0 z-50 flex items-end sm:items-center justify-center px-0 sm:px-4 hidden">
        <div onclick="toggleModal(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity">
        </div>
        <div
            class="bg-white w-full sm:max-w-sm sm:rounded-3xl rounded-t-3xl p-6 relative z-10 shadow-2xl animate-fade-in-up">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>

            <h2 class="text-xl font-black text-gray-900 mb-1">Get Finance Quote</h2>
            <p class="text-gray-400 text-xs mb-6">Leave your details for a personalized offer.</p>

            <form onsubmit="submitLead(event)" class="space-y-3">
                <input type="text" id="lead-name" required placeholder="Your Name"
                    class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:border-black focus:outline-none transition">
                <input type="tel" id="lead-phone" required placeholder="Phone Number"
                    class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm focus:border-black focus:outline-none transition">
                <button type="submit"
                    class="w-full bg-black text-white font-bold py-4 rounded-xl hover:bg-gray-900 transition shadow-lg active:scale-95">Request
                    Call Back</button>
            </form>
        </div>
    </div>

    <script>
        let currentSlug = "";

        window.addEventListener('load', async () => {
            let slug = window.location.pathname.replace(/^\/+|\/+$/g, '');
            if (!slug || slug === 'theme-car') {
                const urlParams = new URLSearchParams(window.location.search);
                slug = urlParams.get('id');
            }
            if (!slug) return;
            currentSlug = slug;

            try {
                // Fetch Data
                const response = await fetch(`/api/public/${slug}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Populate Fields
                // MAPPING: Full Name -> Title (Car Model), Job -> Subtitle (Trim), Company -> Price/Mo
                document.getElementById('p-title').innerText = data.full_name || "Untitled Product";
                document.getElementById('p-subtitle').innerText = data.job_title || "Special Edition";
                document.getElementById('p-desc').innerText = data.bio || "No description available.";
                document.getElementById('p-price').innerText = data.company || "$0"; // Price mapped to Company field

                // Images
                if (data.avatar_url) {
                    document.getElementById('p-image').src = data.avatar_url;
                    document.getElementById('broker-avatar').src = data.avatar_url; // Reuse for now or fetch agent?
                    // Actually, for a product card, the "Avatar" is essentially the Main Product Image.
                    // The "Broker" might be the underlying USER profile?
                    // The API returns the CARD data.
                    // If this is a product card created by a user, 'data' is that card.
                    // We might need to fetch the PARENT user for the broker info if we want that separation.
                    // For now, let's just use the card's data.
                }

                // Broker Name (We might not have this if we re-purposed keys. 
                // Wait, if Name=Car, who is the broker?
                // The API /api/public/${slug} returns the card row.
                // We might need to handle this mapping better in Editor.
                // For now, let's statically set Broker Name to "Castle Finance" or hide it?)
                // Or we can use the 'Company Name' of the PARENT enterprise?
                document.getElementById('broker-name').innerText = "Verified Agent";

                // Contacts
                const phones = JSON.parse(data.phones || '[]');
                if (data.phone) phones.push({ value: data.phone });
                if (phones.length > 0) document.getElementById('btn-call').href = `tel:${phones[0].value}`;

                const socials = JSON.parse(data.socials || '{}');
                if (socials.whatsapp) {
                    document.getElementById('btn-wa').href = `https://wa.me/${socials.whatsapp.replace(/\D/g, '')}`;
                } else {
                    document.getElementById('btn-wa').classList.add('hidden');
                }

                // Show Card
                document.getElementById('preloader').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('card-container').classList.remove('opacity-0');

            } catch (e) {
                console.error(e);
                document.getElementById('p-title').innerText = "Not Found";
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('card-container').classList.remove('opacity-0');
            }
        });

        function toggleModal(show) {
            const m = document.getElementById('exchange-modal');
            if (show) { m.classList.remove('hidden'); }
            else { m.classList.add('hidden'); }
        }

        async function submitLead(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const oldLink = btn.innerText;
            btn.innerText = "Sending...";

            const payload = {
                slug: currentSlug,
                name: document.getElementById('lead-name').value,
                phone: document.getElementById('lead-phone').value,
                message: "Interested in this car offer."
            };

            await fetch('/api/exchange', { method: 'POST', body: JSON.stringify(payload) });
            alert("Request Sent!");
            toggleModal(false);
            btn.innerText = oldLink;
        }
    </script>
</body>

</html>