<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Super Admin - Castle Cards</title>
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- jsVectorMap for Analytics Map -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap/dist/css/jsvectormap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/js/jsvectormap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            red: '#f00000',
                            black: '#0a0a0a',
                            dark: '#121212'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            /* Gray-100 */
            color: #111827;
            /* Gray-900 */
        }

        /* Custom Scrollbar for the main content area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Preloader Styles */
        #preloader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .hidden-element {
            display: none !important;
        }

        /* Custom Tooltip Styles */
        .tooltip-container {
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #0a0a0a;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 11px;
            font-weight: 500;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(10px);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0a0a0a transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-sm">

    <!-- Preloader -->
    <div id="preloader"
        class="fixed inset-0 z-[9999] bg-[#050505] flex items-center justify-center transition-opacity duration-700 ease-out">
        <div class="flex flex-col items-center gap-6">
            <div class="relative w-16 h-16 flex items-center justify-center">
                <div class="absolute inset-0 bg-brand-red opacity-50 blur-xl rounded-full"></div>
                <img src="assets/img/logo.png" alt="Castle Cards Logo" class="relative w-12 h-12 z-10" />
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20">
        <!-- Logo Area -->
        <div class="h-20 flex items-center px-8 border-b border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-black rounded-lg flex items-center justify-center text-white font-bold">
                    <img src="assets/img/logo.png" class="w-5 h-5" alt="Logo">
                </div>
                <span class="font-bold text-lg tracking-tight">Castle<span class="text-brand-red">Crew</span></span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
            <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Main Menu</p>

            <a href="#" onclick="switchView('dashboard'); return false;" id="nav-dashboard"
                class="flex items-center gap-3 px-4 py-3 bg-brand-black text-white rounded-xl transition-all shadow-lg shadow-gray-200">
                <i class="bi bi-grid-fill text-brand-red"></i>
                <span class="font-semibold">Dashboard</span>
            </a>

            <a href="#" onclick="switchView('admins'); return false;" id="nav-admins"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                <i class="bi bi-shield-lock"></i>
                <span class="font-medium">Admins</span>
            </a>

            <a href="#" onclick="switchView('staff'); return false;" id="nav-staff"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                <i class="bi bi-people"></i>
                <span class="font-medium">Staff Members</span>
            </a>

            <a href="#" onclick="switchView('products'); return false;" id="nav-products"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                <i class="bi bi-qr-code"></i>
                <span class="font-medium">Products</span>
            </a>

            <a href="#" onclick="switchView('analytics'); return false;" id="nav-analytics"
                class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                <i class="bi bi-bar-chart"></i>
                <span class="font-medium">Analytics</span>
            </a>

            <div class="pt-6 mt-6 border-t border-gray-100">
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Settings</p>
                <a href="#" onclick="openEditEnterpriseModal()"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-building-gear"></i>
                    <span class="font-medium">Company Settings</span>
                </a>
                <a href="#" onclick="switchView('requests-history'); return false;" id="nav-requests-history"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-envelope-exclamation"></i>
                    <span class="font-medium">Open Requests</span>
                </a>
                <a href="profile.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-person-circle"></i>
                    <span class="font-medium">My Profile</span>
                </a>
            </div>

            <div class="pt-6 mt-6 border-t border-gray-100">
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                <a href="#" onclick="switchView('messaging'); return false;" id="nav-messaging"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-chat-left-dots"></i>
                    <span class="font-medium">Message</span>
                </a>
                <a href="#" onclick="switchView('qr-generator'); return false;" id="nav-qr-generator"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-qr-code-scan"></i>
                    <span class="font-medium">Generate QR</span>
                </a>
                <a href="#" onclick="switchView('authenticator'); return false;" id="nav-authenticator"
                    class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 rounded-xl transition-all">
                    <i class="bi bi-shield-lock"></i>
                    <span class="font-medium">Authenticator</span>
                </a>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-gray-100">
            <div class="bg-gray-50 rounded-xl p-4 flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-brand-red/10 text-brand-red flex items-center justify-center font-bold text-xs">
                    SA
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-gray-900 truncate">Super Admin</p>
                    <p class="text-[10px] text-gray-500 truncate">Enterprise Mode</p>
                </div>
                <button onclick="window.location.reload()" class="text-gray-400 hover:text-gray-600">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-[#f8f9fa]">

        <!-- Header -->
        <header
            class="h-20 bg-white border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-[500]">
            <!-- Breadcrumbs / Mobile Toggle -->
            <div class="flex items-center gap-4">
                <button class="md:hidden text-gray-500 text-xl">
                    <i class="bi bi-list"></i>
                </button>
                <div class="hidden md:flex flex-col">
                    <span class="text-gray-400 text-xs font-medium">Overview</span>
                    <h1 class="text-lg font-bold text-gray-900">Enterprise Super Admin Panel</h1>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-6">
                <!-- Search -->
                <div class="relative hidden md:block" id="main-search-container">
                    <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="main-search-input" placeholder="Search anything (Name, ID, Product)..."
                        oninput="handleMainSearch(this.value)"
                        class="pl-10 pr-4 py-2 bg-gray-50 border-none rounded-lg text-sm w-80 focus:ring-2 focus:ring-brand-red/20 focus:bg-white transition-all">

                    <!-- Search Results Dropdown -->
                    <div id="main-search-results"
                        class="hidden absolute top-full left-0 right-0 mt-3 bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden z-[1000] w-[450px]">
                        <div class="p-3 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                            <span class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Search
                                Results</span>
                            <button onclick="document.getElementById('main-search-results').classList.add('hidden')"
                                class="text-gray-400 hover:text-gray-600 transition"><i
                                    class="bi bi-x-lg text-xs"></i></button>
                        </div>
                        <div class="max-h-[450px] overflow-y-auto custom-scrollbar" id="search-results-content">
                            <!-- Results injected here -->
                        </div>
                        <div class="p-3 bg-gray-50 border-t border-gray-100 text-center">
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Search for Admins,
                                Staff Members or Product Cards</p>
                        </div>
                    </div>
                </div>

                <!-- Need Help Mini Card -->
                <div
                    class="hidden lg:flex items-center gap-3 bg-blue-600 rounded-lg px-3 py-1 shadow-md hover:shadow-lg transition-shadow">
                    <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-white text-xs">
                        <i class="bi bi-question-lg"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-blue-100 font-bold uppercase leading-none mb-0.5">Need Help?</p>
                        <a href="mailto:support@castlecrew.cc"
                            class="text-white text-xs font-bold hover:underline leading-none">Contact Support</a>
                    </div>
                </div>

                <!-- Notifications -->
                <button onclick="switchView('messaging')"
                    class="relative bg-white w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-500 hover:text-brand-red hover:border-brand-red/30 transition-all">
                    <i class="bi bi-bell"></i>
                    <span id="notification-badge"
                        class="hidden-element absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>

                <!-- Profile Pill -->
                <div class="relative flex items-center gap-3 pl-4 border-l border-gray-100">
                    <button onclick="toggleProfileDropdown()"
                        class="flex items-center gap-3 hover:bg-gray-50 rounded-full p-1 pr-4 transition-colors">
                        <img id="header-profile-img" src="assets/img/logo.png" alt="Profile"
                            class="w-10 h-10 rounded-full object-cover border border-gray-200">
                        <div class="text-left hidden md:block">
                            <p id="header-profile-name" class="text-sm font-bold text-gray-900 leading-none mb-1">Super
                                Admin</p>
                            <p id="header-profile-role"
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-wide leading-none">
                                Enterprise Mode</p>
                        </div>
                        <i class="bi bi-chevron-down text-gray-400 text-xs ml-2"></i>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="profile-dropdown"
                        class="hidden absolute right-0 top-full mt-2 w-64 bg-white rounded-xl shadow-2xl border border-gray-100 py-2 z-[100] ring-1 ring-gray-900/5 transform origin-top-right transition-all duration-200">

                        <div class="px-4 py-3 border-b border-gray-100 mb-2 md:hidden">
                            <p class="text-sm font-bold text-gray-900">Super Admin</p>
                            <p class="text-xs text-gray-500">Enterprise Mode</p>
                        </div>

                        <a href="profile.html"
                            class="group block px-4 py-2.5 text-sm text-gray-600 hover:bg-gray-50 hover:text-brand-black font-medium transition flex items-center gap-3">
                            <i class="bi bi-grid-fill text-gray-400 group-hover:text-brand-red transition"></i>
                            <span>My Profile Dashboard</span>
                        </a>
                        <a id="link-visit-profile" href="#" target="_blank"
                            class="group block px-4 py-2.5 text-sm text-gray-600 hover:bg-gray-50 hover:text-brand-black font-medium transition flex items-center gap-3">
                            <i class="bi bi-person-circle text-gray-400 group-hover:text-brand-red transition"></i>
                            <span>Visit My Profile</span>
                        </a>
                        <a id="link-edit-card" href="#"
                            class="group block px-4 py-2.5 text-sm text-gray-600 hover:bg-gray-50 hover:text-brand-black font-medium transition flex items-center gap-3">
                            <i class="bi bi-pencil-square text-gray-400 group-hover:text-brand-red transition"></i>
                            <span>Edit Profile Card</span>
                        </a>

                        <div class="border-t border-gray-100 my-1"></div>

                        <button onclick="localStorage.removeItem('castle_token'); window.location.href='index.html'"
                            class="w-full text-left group block px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 font-medium transition flex items-center gap-3">
                            <i class="bi bi-box-arrow-right text-red-400 group-hover:text-red-600 transition"></i>
                            <span>Sign Out</span>
                        </button>
                    </div>
                </div>

            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">

            <!-- QR GENERATOR VIEW -->
            <div id="qr-generator-view" class="hidden transition-opacity duration-300">
                <div
                    class="bg-white rounded-2xl p-8 mb-8 shadow-sm border border-gray-100 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-2">QR Code Generator</h2>
                        <p class="text-gray-500 max-w-lg">Create custom QR codes for your enterprise assets.</p>
                    </div>
                    <div
                        class="w-12 h-12 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-2xl relative z-10">
                        <i class="bi bi-qr-code-scan"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Configuration -->
                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 h-fit">
                        <h3 class="text-lg font-bold text-gray-900 mb-6">Configuration</h3>

                        <div class="space-y-6">
                            <div>
                                <label
                                    class="block text-[10px] font-black uppercase text-gray-400 tracking-widest mb-2 px-1">Content
                                    URL / Text</label>
                                <input type="text" id="qr-input-text" placeholder="https://castlecrew.cc/..."
                                    class="w-full bg-gray-50 border border-gray-100 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-100 focus:border-blue-500 focus:outline-none transition">
                            </div>

                            <div>
                                <label
                                    class="block text-[10px] font-black uppercase text-gray-400 tracking-widest mb-2 px-1">Color
                                    Theme</label>
                                <div class="flex gap-3">
                                    <button onclick="setQRColor('#000000')"
                                        class="w-10 h-10 rounded-full bg-black border-2 border-transparent hover:scale-110 transition focus:ring-2 ring-offset-2 ring-gray-300"></button>
                                    <button onclick="setQRColor('#f00000')"
                                        class="w-10 h-10 rounded-full bg-[#f00000] border-2 border-transparent hover:scale-110 transition focus:ring-2 ring-offset-2 ring-red-300"></button>
                                    <button onclick="setQRColor('#2563eb')"
                                        class="w-10 h-10 rounded-full bg-blue-600 border-2 border-transparent hover:scale-110 transition focus:ring-2 ring-offset-2 ring-blue-300"></button>
                                    <button onclick="setQRColor('#16a34a')"
                                        class="w-10 h-10 rounded-full bg-green-600 border-2 border-transparent hover:scale-110 transition focus:ring-2 ring-offset-2 ring-green-300"></button>
                                    <button onclick="setQRColor('#9333ea')"
                                        class="w-10 h-10 rounded-full bg-purple-600 border-2 border-transparent hover:scale-110 transition focus:ring-2 ring-offset-2 ring-purple-300"></button>
                                    <div class="relative w-10 h-10 rounded-full overflow-hidden cursor-pointer hover:scale-110 transition shadow-sm ring-1 ring-gray-200"
                                        style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);">
                                        <input type="color" id="qr-custom-color"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer p-0 border-0"
                                            onchange="setQRColor(this.value)">
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <input type="checkbox" id="qr-include-logo"
                                    class="w-5 h-5 rounded border-gray-300 text-brand-black focus:ring-brand-black/20 cursor-pointer accent-brand-black">
                                <label for="qr-include-logo"
                                    class="text-xs font-bold text-gray-700 cursor-pointer select-none">Include
                                    Enterprise
                                    Logo</label>
                            </div>

                            <button onclick="generateCustomQR()"
                                class="w-full bg-brand-black text-white font-black py-4 rounded-xl hover:bg-gray-800 transition shadow-lg mt-4">
                                GENERATE QR CODE
                            </button>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div
                        class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 flex flex-col items-center justify-center min-h-[400px]">
                        <div id="qr-preview-box" class="mb-8 p-4 bg-white rounded-xl">
                            <div id="custom-qr-container" class="opacity-50 grayscale"></div>
                        </div>

                        <div id="qr-actions" class="flex gap-4 hidden">
                            <button onclick="downloadCustomQR('png')"
                                class="px-6 py-3 bg-gray-50 text-gray-900 font-bold text-xs rounded-xl hover:bg-gray-100 transition border border-gray-200">
                                <i class="bi bi-download mr-2"></i> DOWNLOAD PNG
                            </button>
                            <button onclick="downloadCustomQR('pdf')"
                                class="px-6 py-3 bg-gray-50 text-gray-900 font-bold text-xs rounded-xl hover:bg-gray-100 transition border border-gray-200">
                                <i class="bi bi-file-pdf-fill mr-2"></i> DOWNLOAD PDF
                            </button>
                        </div>
                        <p id="qr-placeholder-text" class="text-gray-400 text-sm font-medium">Enter content to generate
                            preview</p>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="analytics-view" class="hidden transition-opacity duration-300">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-black text-gray-900 mb-2">Enterprise Analytics</h2>
                        <p class="text-gray-500">Real-time data insights across your entire organization.</p>
                    </div>
                    <div
                        class="flex flex-wrap items-center gap-2 bg-white rounded-lg p-1 border border-gray-100 shadow-sm">
                        <button onclick="setAnalyticsRange('24h')" id="btn-range-24h"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold text-gray-500 hover:bg-gray-50 rounded transition">Last
                            24H</button>
                        <button onclick="setAnalyticsRange('7d')" id="btn-range-7d"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold text-gray-500 hover:bg-gray-50 rounded transition">1
                            Week</button>
                        <button onclick="setAnalyticsRange('30d')" id="btn-range-30d"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold bg-black text-white rounded shadow-sm">1
                            Month</button>
                        <button onclick="setAnalyticsRange('90d')" id="btn-range-90d"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold text-gray-500 hover:bg-gray-50 rounded transition">3
                            Month</button>
                        <button onclick="setAnalyticsRange('6m')" id="btn-range-6m"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold text-gray-500 hover:bg-gray-50 rounded transition">6
                            Month</button>
                        <button onclick="setAnalyticsRange('1y')" id="btn-range-1y"
                            class="analy-range-btn px-3 py-1.5 text-xs font-bold text-gray-500 hover:bg-gray-50 rounded transition">1
                            Year</button>
                    </div>
                </div>

                <!-- Bento Grid Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stat 1 -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-lg">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <span id="analy-profile-trend"
                                class="text-green-500 text-xs font-bold flex items-center gap-1">--- <i
                                    class="bi bi-dash"></i></span>
                        </div>
                        <h3 class="text-3xl font-black text-gray-900 mb-1" id="analy-profile-visits">0</h3>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Total Profile Visitors</p>
                    </div>

                    <!-- Stat 2 -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-lg">
                                <i class="bi bi-qr-code-scan"></i>
                            </div>
                            <span id="analy-product-trend"
                                class="text-green-500 text-xs font-bold flex items-center gap-1">--- <i
                                    class="bi bi-dash"></i></span>
                        </div>
                        <h3 class="text-3xl font-black text-gray-900 mb-1" id="analy-product-visits">0</h3>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Total Product Visitors</p>
                    </div>

                    <!-- Stat 3 -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center text-lg">
                                <i class="bi bi-cursor-fill"></i>
                            </div>
                            <span id="analy-actions-trend"
                                class="text-red-500 text-xs font-bold flex items-center gap-1">--- <i
                                    class="bi bi-dash"></i></span>
                        </div>
                        <h3 class="text-3xl font-black text-gray-900 mb-1" id="analy-actions">42,109</h3>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Total Actions</p>
                    </div>

                    <!-- Stat 4 -->
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-lg">
                                <i class="bi bi-stopwatch-fill"></i>
                            </div>
                            <span id="analy-engagement-trend"
                                class="text-green-500 text-xs font-bold flex items-center gap-1">--- <i
                                    class="bi bi-dash"></i></span>
                        </div>
                        <h3 class="text-3xl font-black text-gray-900 mb-1" id="analy-engagement">1m 42s</h3>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Avg. Engagement</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Main Traffic Chart -->
                    <div class="lg:col-span-2 bg-white p-8 rounded-2xl border border-gray-100 shadow-sm h-[400px]">
                        <h4 class="font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <i class="bi bi-graph-up text-brand-red"></i> Traffic Overview
                        </h4>
                        <div class="h-[300px] w-full">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Cards Leaderboard -->
                    <div
                        class="bg-white p-0 rounded-2xl border border-gray-100 shadow-sm h-[400px] flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                            <h4 class="font-bold text-gray-900 flex items-center gap-2">
                                <i class="bi bi-trophy-fill text-yellow-500"></i> Top Performing Cards
                            </h4>
                        </div>
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-2" id="top-cards-list">
                            <!-- Dynamic Content -->
                            <div class="p-4 text-center text-gray-400 text-xs">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Device Breakdown & Locations Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="flex flex-col gap-6 h-[600px]">
                        <!-- Device Breakdown -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col h-[380px]">
                            <h4 class="font-bold text-gray-900 text-sm mb-2">Device Breakdown</h4>
                            <div class="h-[180px] w-full flex items-center justify-center mb-4">
                                <canvas id="deviceChart"></canvas>
                            </div>
                            <div class="flex-1 overflow-hidden flex flex-col">
                                <h5
                                    class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 pb-2 border-b border-gray-100">
                                    Latest Devices</h5>
                                <div id="device-models-list"
                                    class="overflow-y-auto custom-scrollbar flex-1 space-y-2 pr-2">
                                    <div class="text-center text-xs text-gray-400 py-4">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Performing Profiles -->
                        <div
                            class="bg-white p-0 rounded-2xl border border-gray-100 shadow-sm flex-1 flex flex-col overflow-hidden">
                            <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                                <h4 class="font-bold text-gray-900 flex items-center gap-2 text-sm">
                                    <i class="bi bi-person-badge-fill text-indigo-500"></i> Top Profiles
                                </h4>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-2" id="top-profiles-list">
                                <!-- Dynamic Content -->
                                <div class="p-4 text-center text-gray-400 text-xs">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Locations (Map + List) -->
                    <div
                        class="lg:col-span-2 bg-white p-8 rounded-2xl border border-gray-100 shadow-sm h-[600px] flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-gray-900">Recent Activity Locations</h4>
                            <button onclick="resetMap()" class="text-xs font-bold text-blue-600 hover:underline">Reset
                                View</button>
                        </div>

                        <!-- Map Container -->
                        <div id="world-map-markers"
                            class="w-full flex-1 mb-6 rounded-xl overflow-hidden bg-gray-50 border border-gray-100">
                        </div>

                        <!-- Stats List -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="location-stats-grid">
                            <!-- Static Placeholders for now, populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUTHENTICATOR VIEW -->
            <div id="authenticator-view" class="hidden transition-opacity duration-300">
                <div
                    class="bg-white rounded-2xl p-8 mb-8 shadow-sm border border-gray-100 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-3xl font-black text-gray-900 mb-2">Authenticator Vault</h2>
                        <p class="text-gray-500 max-w-lg">Securely manage 2FA codes for your enterprise
                            applications.
                            <span
                                class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded ml-2 font-bold">Client-Side
                                Vault</span>
                        </p>
                    </div>
                    <div
                        class="w-12 h-12 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-2xl relative z-10">
                        <i class="bi bi-shield-lock"></i>
                    </div>
                </div>

                <!-- Active Codes Grid -->
                <div id="auth-codes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Dynamic Content -->
                </div>

                <!-- Empty State (Hidden if items exist) -->
                <div id="auth-empty-state" class="text-center py-12 hidden">
                    <div
                        class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300 text-2xl">
                        <i class="bi bi-safe"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">No Connected Apps</h3>
                    <p class="text-gray-500 text-sm max-w-sm mx-auto mb-6">Add your first Two-Factor Authentication
                        account to start generating secure codes.</p>
                </div>

                <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-bold text-gray-900">Add New Connection</h4>
                        <button onclick="openAddAuthAccountModal()"
                            class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition flex items-center gap-2">
                            <i class="bi bi-plus-lg"></i> Add Account
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Enter the Secret Key provided by the third-party service (e.g., Facebook, Google, AWS).
                        Keys are stored locally in your browser for this demo.
                    </p>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="dashboard-view" class="transition-opacity duration-300">
                <!-- Greeting Section -->
                <div
                    class="bg-white rounded-2xl p-8 mb-8 shadow-sm border border-gray-100 flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
                    <!-- Decorative Background -->
                    <div
                        class="absolute right-0 top-0 h-full w-1/3 bg-gradient-to-l from-gray-50 to-transparent pointer-events-none">
                    </div>

                    <div class="relative">
                        <div class="flex items-center gap-3 mb-2 text-gray-500 text-sm font-medium">
                            <img id="company-logo" src="" class="h-6 w-auto object-contain hidden" alt="Company Logo">
                            <span id="company-name" class="uppercase tracking-wide font-bold">Loading...</span>
                        </div>
                        <h2 class="text-3xl font-black text-gray-900 mb-2">Welcome back! 👋</h2>
                        <p class="text-gray-500 max-w-lg">Here's what's happening with your enterprise licenses and
                            staff
                            today.</p>
                    </div>

                    <div class="relative z-10 flex gap-3 items-center">

                        <div class="flex flex-col items-end mr-4">
                            <span class="text-xs text-gray-400 font-bold uppercase">License Status</span>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span class="font-bold text-green-600">Active</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Profile Licenses -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-xl">
                                <i class="bi bi-award"></i>
                            </div>
                            <div class="tooltip-container">
                                <span class="text-gray-300 cursor-help">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                                <span class="tooltip-text">Total seats available for Admins and Staff accounts
                                    within
                                    your enterprise plan.</span>
                            </div>
                        </div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Profile Licenses
                        </h3>
                        <p id="lic-total" class="text-3xl font-black text-gray-900">...</p>
                    </div>

                    <!-- Sub Licenses -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center text-xl">
                                <i class="bi bi-qr-code"></i>
                            </div>
                            <div class="tooltip-container">
                                <span class="text-gray-300 cursor-help">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                                <span class="tooltip-text">Additional product card slots (sub-licenses) that have
                                    been
                                    distributed among your staff.</span>
                            </div>
                        </div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Sub Licenses</h3>
                        <p id="lic-assigned" class="text-3xl font-black text-gray-900">...</p>
                    </div>

                    <!-- Active Staff -->
                    <div
                        class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-xl">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="tooltip-container flex -space-x-2" id="active-staff-avatars">
                                <!-- Random avatars injected here -->
                                <span class="tooltip-text">Current number of unique staff members who have at least
                                    one
                                    active digital card.</span>
                            </div>
                        </div>
                        <h3 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Active Staff</h3>
                        <p id="active-cards" class="text-3xl font-black text-gray-900">...</p>
                    </div>

                    <!-- Active Products -->
                    <div
                        class="bg-black p-6 rounded-xl border border-gray-900 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-gray-800 text-white flex items-center justify-center text-xl">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="tooltip-container">
                                <span
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wide cursor-help">Status</span>
                                <span class="tooltip-text">Total number of digital product cards currently active
                                    and
                                    accessible across your entire organization.</span>
                            </div>
                        </div>
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Active Products
                        </h3>
                        <p id="unassigned-seats" class="text-3xl font-black text-white">...</p>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">

                    <!-- Left Column (Tables) -->
                    <div class="xl:col-span-2 space-y-8">

                        <!-- Admins Table -->
                        <div id="admins" class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-900">Delegated Admins</h3>
                                    <p class="text-xs text-gray-500">Manage admin access and permissions.</p>
                                </div>
                                <button onclick="switchView('admins')"
                                    class="text-sm text-gray-500 hover:text-brand-black font-semibold flex items-center gap-2">
                                    <span id="total-admins-count"
                                        class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold">0</span>
                                    <span>View All</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[280px] overflow-y-auto custom-scrollbar">
                                <table class="w-full text-left text-sm">
                                    <thead
                                        class="bg-gray-50 text-gray-600 font-semibold uppercase text-[11px] tracking-wider sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="p-4 pl-6">Admin User</th>
                                            <th class="p-4">Digital Card</th>
                                            <th class="p-4">Staff Managed</th>
                                            <th class="p-4">Last Login</th>
                                            <th class="p-4 text-right pr-6">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-list" class="divide-y divide-gray-50">
                                        <tr>
                                            <td class="p-6 text-center text-gray-400" colspan="4">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Staff Table -->
                        <div id="staff" class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-900">Staff Members</h3>
                                    <p class="text-xs text-gray-500">All users associated with this enterprise.</p>
                                </div>
                                <button onclick="switchView('staff')"
                                    class="text-sm text-gray-500 hover:text-brand-black font-semibold flex items-center gap-2">
                                    <span id="total-staff-count"
                                        class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold">0</span>
                                    <span>View All</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[280px] overflow-y-auto custom-scrollbar">
                                <table class="w-full text-left text-sm">
                                    <thead
                                        class="bg-gray-50 text-gray-600 font-semibold uppercase text-[11px] tracking-wider sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="p-4 pl-6">Staff Member</th>
                                            <th class="p-4">Digital Card</th>
                                            <th class="p-4">Assigned Admin</th>
                                            <th class="p-4">Sub Licenses</th>
                                            <th class="p-4 text-right pr-6">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-user-list" class="divide-y divide-gray-50">
                                        <tr>
                                            <td class="p-6 text-center text-gray-400" colspan="4">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>


                        <!-- Active Products Table -->
                        <div id="active-products"
                            class="bg-black text-white rounded-xl border border-gray-800 shadow-sm overflow-hidden mt-6">
                            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-white">Active Products</h3>
                                    <p class="text-xs text-gray-400">Product cards and sub-licenses.</p>
                                </div>
                                <button onclick="switchView('products')"
                                    class="text-sm text-gray-400 hover:text-white font-semibold flex items-center gap-2">
                                    <span id="total-products"
                                        class="bg-brand-red text-white px-2 py-0.5 rounded-full text-[10px] font-bold">0</span>
                                    <span>View All</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-[280px] overflow-y-auto custom-scrollbar">
                                <table class="w-full text-left text-sm">
                                    <thead
                                        class="bg-gray-900/50 text-gray-400 font-semibold uppercase text-[11px] tracking-wider sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="p-4 pl-6">Card Identity</th>
                                            <th class="p-4">Assigned Staff</th>
                                            <th class="p-4 text-right pr-6">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="active-products-list" class="divide-y divide-gray-800">
                                        <tr>
                                            <td class="p-6 text-center text-gray-500" colspan="3">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Unassigned Products Table (New) -->
                        <div id="unassigned-products"
                            class="bg-zinc-900 text-white rounded-xl border border-zinc-800 shadow-sm overflow-hidden mt-6 hidden">
                            <div class="p-6 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50">
                                <div>
                                    <h3 class="font-bold text-lg text-white">Unassigned Products</h3>
                                    <p class="text-xs text-orange-400">Orphan cards needing reassignment.</p>
                                </div>
                                <div class="flex gap-2">
                                    <span class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold"
                                        id="total-unassigned-products">0</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead
                                        class="bg-zinc-800/50 text-gray-400 font-semibold uppercase text-[11px] tracking-wider">
                                        <tr>
                                            <th class="p-4 pl-6">Card Identity</th>
                                            <th class="p-4">Created Date</th>
                                            <th class="p-4 text-right pr-6">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unassigned-products-list" class="divide-y divide-zinc-800">
                                        <!-- Populated via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- Right Column (Widgets) -->
                    <div class="space-y-6">

                        <!-- Quick Actions -->
                        <div
                            class="bg-gradient-to-br from-brand-black to-gray-900 rounded-2xl p-6 text-white text-center shadow-xl">
                            <div
                                class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl backdrop-blur-sm">
                                <i class="bi bi-lightning-charge-fill text-yellow-400"></i>
                            </div>
                            <h3 class="font-bold text-lg mb-2">Enterprise Actions</h3>
                            <p class="text-white/60 text-xs mb-6">Quickly manage your enterprise settings and
                                preferences.
                            </p>

                            <div class="space-y-3">
                                <button onclick="openEditEnterpriseModal()"
                                    class="w-full bg-white text-black font-bold py-3 rounded-xl text-sm hover:bg-gray-100 transition-colors">
                                    Edit Company Details
                                </button>

                                <div id="account-creation-area">
                                    <button id="btn-create-account" onclick="openCreateAccountModal()"
                                        class="w-full bg-white/10 text-white font-bold py-3 rounded-xl text-sm hover:bg-white/20 transition-colors border border-white/10">
                                        Create New Account
                                    </button>
                                </div>

                                <div id="license-warning"
                                    class="hidden-element bg-red-500/10 border border-red-500/20 rounded-xl p-4 mt-2">
                                    <p class="text-red-400 text-[10px] font-bold uppercase mb-2">License Limit
                                        Reached
                                    </p>
                                    <p class="text-white/70 text-xs mb-3 text-left">Your account has used all
                                        available
                                        profile licenses. Please upgrade to add more staff.</p>
                                    <button onclick="window.open('https://castlecrew.cc/contact', '_blank')"
                                        class="w-full bg-brand-red text-white font-bold py-2 rounded-lg text-xs hover:bg-red-600 transition-colors">
                                        REQUEST MORE LICENSES
                                    </button>
                                </div>

                                <div id="sub-license-warning"
                                    class="hidden-element bg-purple-500/10 border border-purple-500/20 rounded-xl p-4 mt-2">
                                    <p class="text-purple-400 text-[10px] font-bold uppercase mb-2">Sub-License
                                        Limit
                                        Reached
                                    </p>
                                    <p class="text-white/70 text-xs mb-3 text-left">Your account has allocated all
                                        available
                                        sub-license slots. Please upgrade to add more product cards.</p>
                                    <button onclick="window.open('https://castlecrew.cc/contact', '_blank')"
                                        class="w-full bg-purple-600 text-white font-bold py-2 rounded-lg text-xs hover:bg-purple-700 transition-colors">
                                        REQUEST MORE SLOTS
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Logs / Activity Feed -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden flex flex-col"
                            style="max-height: 480px;">
                            <div
                                class="p-6 border-b border-gray-100 bg-white sticky top-0 z-10 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-gray-900">Recent Activity</h3>
                                    <p class="text-xs text-gray-500">Real-time enterprise logs.</p>
                                </div>
                                <button onclick="downloadLogsPDF()" class="text-gray-400 hover:text-gray-900 transition"
                                    title="Download Logs">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>

                            <div id="activity-logs"
                                class="overflow-y-auto p-0 custom-scrollbar divide-y divide-gray-50">
                                <!-- Logs will be populated here -->
                                <div class="p-6 text-center text-gray-400 text-xs">Loading logs...</div>
                            </div>
                        </div>



                        <!-- Hidden Stats ID placeholders to prevent JS errors if they were used elsewhere -->
                        <div class="hidden">
                            <span id="active-staff"></span>
                        </div>

                    </div>
                </div>

                <!-- End Dashboard View -->
            </div>

            <!-- REQUESTS HISTORY VIEW -->
            <div id="requests-history-view" class="hidden-element transition-opacity duration-300">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-black text-gray-900 uppercase tracking-tight">Request History</h2>
                        <p class="text-gray-500 text-sm font-medium mt-1">Track your license and system enhancement
                            requests.</p>
                    </div>
                    <button onclick="openRequestModal()"
                        class="bg-blue-600 text-white font-black py-3 px-8 rounded-2xl text-xs uppercase tracking-widest hover:bg-blue-700 transition-all shadow-xl shadow-blue-600/20 active:scale-95 flex items-center gap-2">
                        <i class="bi bi-plus-lg"></i>
                        <span>New Request</span>
                    </button>
                </div>

                <div
                    class="bg-white rounded-[2rem] border border-gray-100 shadow-xl shadow-gray-200/50 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50/50 border-b border-gray-100">
                                    <th
                                        class="p-6 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] pl-10">
                                        Request Identity</th>
                                    <th class="p-6 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">
                                        Type
                                    </th>
                                    <th
                                        class="p-6 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-center">
                                        Amount</th>
                                    <th class="p-6 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">
                                        Application Date</th>
                                    <th
                                        class="p-6 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-center">
                                        Status</th>
                                </tr>
                            </thead>
                            <tbody id="requests-history-list" class="divide-y divide-gray-50">
                                <!-- Requests populated by JS -->
                                <tr>
                                    <td colspan="5" class="p-20 text-center">
                                        <div class="flex flex-col items-center gap-4 opacity-20">
                                            <i class="bi bi-clock-history text-5xl"></i>
                                            <p class="text-[10px] font-black uppercase tracking-widest">
                                                Synchronizing
                                                Request Chain...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMINS VIEW -->
            <div id="admins-view" class="hidden transition-opacity duration-300">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Enterprise Admins</h2>
                        <p class="text-gray-500 text-sm mt-1">Manage all administrators in your enterprise.</p>
                    </div>
                    <!-- Reuse Create Account button logic if needed, or just keep it simple -->
                    <button onclick="openCreateAccountModal()"
                        class="bg-brand-black text-white font-bold py-2.5 px-6 rounded-xl text-sm hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200 flex items-center gap-2">
                        <i class="bi bi-plus-lg"></i>
                        <span>Add New Admin</span>
                    </button>
                </div>

                <!-- Admins Grid -->
                <div id="admins-grid-container"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Cards will be populated here -->
                </div>
            </div>

            <!-- PRODUCTS VIEW (New) -->
            <div id="products-view" class="hidden-element transition-opacity duration-300">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">All Products</h2>
                        <p class="text-gray-500 text-sm">Manage all digital product cards and sub-licenses.</p>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="products-grid-container"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Cards will be populated here -->
                </div>
            </div>
            <div id="staff-view" class="hidden transition-opacity duration-300">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Enterprise Staff</h2>
                        <p class="text-gray-500 text-sm mt-1">Manage all staff members in your enterprise.</p>
                    </div>
                </div>

                <!-- Staff Grid -->
                <div id="staff-grid-container"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Cards will be populated here -->
                </div>
            </div>

            <!-- MESSAGING VIEW -->
            <div id="messaging-view" class="hidden transition-opacity duration-300">
                <div class="flex flex-col h-[calc(100vh-160px)]">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Support Messages</h2>
                            <p class="text-gray-500 text-sm mt-1">Direct communication with Castle Crew System
                                Admin.
                            </p>
                        </div>
                    </div>

                    <div
                        class="flex-1 bg-white rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                        <!-- Chat Header -->
                        <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full bg-brand-red flex items-center justify-center text-white text-lg rounded-xl">
                                    <i class="bi bi-headset"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900">Castle Crew Support</h4>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                        <span
                                            class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Secure
                                            Admin Link Active</span>
                                    </div>
                                </div>
                            </div>
                            <div class="hidden md:flex items-center gap-2">
                                <span
                                    class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-wider">Priority
                                    Support</span>
                            </div>
                        </div>

                        <!-- Chat Area -->
                        <div id="support-messaging-history"
                            class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar bg-gray-50/30">
                            <!-- Messages will be loaded here -->
                            <div class="flex items-center justify-center h-full">
                                <div class="flex flex-col items-center gap-2 opacity-20">
                                    <i class="bi bi-chat-left-dots text-4xl"></i>
                                    <p class="text-xs font-bold uppercase tracking-widest">Loading Conversation...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="p-4 bg-white border-t border-gray-100">
                            <div class="relative flex items-center gap-2">
                                <button
                                    class="w-10 h-10 rounded-xl bg-gray-50 text-gray-400 hover:text-gray-900 transition flex items-center justify-center">
                                    <i class="bi bi-paperclip text-lg"></i>
                                </button>
                                <div class="flex-1 relative">
                                    <input type="text" id="support-chat-input" placeholder="Type your message here..."
                                        onkeypress="if(event.key === 'Enter') handleSendMessage()"
                                        class="w-full bg-gray-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-red/20 focus:bg-white transition-all pr-12">
                                    <button onclick="handleSendMessage()"
                                        class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-brand-black text-white flex items-center justify-center hover:bg-gray-800 transition shadow-lg">
                                        <i class="bi bi-send-fill text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MODALS (Restyled to match new theme) -->

    <!-- Edit Enterprise Modal -->
    <div id="edit-enterprise-modal"
        class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[1000] backdrop-blur-sm transition-all duration-300">
        <div
            class="bg-white w-full max-w-md p-0 rounded-2xl shadow-2xl scale-100 transform transition-all overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-900">Edit Enterprise</h3>
                <button onclick="closeEditEnterpriseModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="p-8">
                <form id="edit-enterprise-form" onsubmit="saveEnterpriseDetails(event)">
                    <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Company Name</label>
                        <input type="text" id="edit-ent-name" required
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-900 text-sm focus:border-brand-black focus:ring-0 focus:outline-none transition-colors"
                            placeholder="Enter company name">
                    </div>

                    <div class="mb-8">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Company Logo</label>
                        <div class="relative group cursor-pointer">
                            <input type="file" id="edit-ent-logo" accept="image/png, image/jpeg"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                onchange="previewLogo(this)">
                            <div
                                class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg px-4 py-8 text-center group-hover:border-gray-400 transition-all">
                                <div class="mb-2">
                                    <i
                                        class="fas fa-cloud-upload-alt text-gray-400 text-2xl group-hover:text-brand-black transition-colors"></i>
                                </div>
                                <p class="text-gray-500 text-xs font-bold uppercase">Click to Upload Logo</p>
                                <p id="file-name-display" class="text-gray-400 text-[10px] mt-1 truncate">No file
                                    selected</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="closeEditEnterpriseModal()"
                            class="flex-1 bg-white border border-gray-200 text-gray-700 py-3 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 bg-brand-black text-white py-3 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-800 shadow-lg shadow-gray-200">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div id="create-account-modal"
        class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[1000] backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-0 rounded-2xl shadow-2xl relative overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-900">Create New Account</h3>
                <button onclick="closeCreateAccountModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>

            <div class="p-6">
                <form onsubmit="event.preventDefault(); createAccount();" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Account Type</label>
                        <select id="new-account-type" onchange="toggleAccountFields()"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                            <option value="admin">Enterprise Admin</option>
                            <option value="staff">Staff Member</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Full Name</label>
                        <input type="text" id="new-account-name" required
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email Address</label>
                        <input type="email" id="new-account-email" required
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                    </div>

                    <div id="field-password">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Password</label>
                        <input type="password" id="new-account-password"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                    </div>

                    <div id="field-employee-id">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Employee ID
                            (Optional)</label>
                        <input type="text" id="new-account-employee-id"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                    </div>

                    <div id="field-assign-admin" class="hidden">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Assign Admin
                            (Optional)</label>
                        <select id="new-account-assign-admin"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none text-sm">
                            <option value="">Unassigned</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div id="field-licenses" class="hidden">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Sub-Licenses
                            (Optional)</label>
                        <input type="number" id="new-account-licenses" value="0" min="0"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 focus:border-brand-black focus:outline-none">
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="btn-create-account"
                            class="w-full bg-brand-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">
                            CREATE ACCOUNT
                        </button>
                        <p id="create-account-error" class="text-red-500 text-xs mt-2 text-center hidden"></p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Manage Admin Modal -->
    <div id="manage-admin-modal"
        class="fixed inset-0 bg-black/60 hidden-element flex items-center justify-center z-[1000] backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl relative">
            <h2 class="text-xl font-bold mb-1 text-gray-900">Manage Admin</h2>
            <p id="admin-modal-email" class="text-xs text-gray-500 mb-6">admin@email.com</p>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Manage their access permissions here.</p>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Employee ID</label>
                    <input type="text" id="admin-modal-employee-id"
                        class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-sm text-gray-900 focus:border-brand-black focus:outline-none">
                </div>

                <button onclick="saveAdminChanges()"
                    class="w-full bg-brand-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">SAVE
                    CHANGES</button>

                <div class="mt-4">
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Reset Password</label>
                    <div class="flex gap-2">
                        <input type="text" id="admin-new-password" readonly placeholder="********"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs text-gray-600 focus:outline-none">
                        <button id="btn-reset-admin-password" onclick="resetPassword('admin')"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs font-bold whitespace-nowrap transition">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button onclick="copyPassword('admin')"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs font-bold transition">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4 mt-4 space-y-3">
                    <button id="btn-suspend-admin" onclick="suspendAdmin()"
                        class="w-full text-yellow-600 text-xs font-bold hover:text-yellow-700 bg-yellow-50 py-3 rounded-lg">SUSPEND
                        ACCOUNT</button>
                    <button onclick="deleteAdmin()"
                        class="w-full text-red-500 text-xs font-bold hover:text-red-600 bg-red-50 py-3 rounded-lg">DELETE
                        ACCOUNT</button>
                </div>
            </div>
            <button onclick="closeAdminModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">✕</button>
        </div>
    </div>
    </div>

    <!-- Manage Product Modal -->
    <div id="manage-product-modal"
        class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/60 backdrop-blur-xl hidden-element">
        <div class="bg-[#111] w-full max-w-md rounded-2xl shadow-2xl overflow-hidden border border-gray-800">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white">Manage Product</h3>
                    <p class="text-gray-500 text-sm mt-1">/<span id="manage-product-slug-title"
                            class="text-brand-red"></span></p>
                </div>
                <button onclick="closeManageProductModal()" class="text-gray-500 hover:text-white transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <!-- Reassign Section -->
                <div class="space-y-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest">Reassign Card</label>
                    <p class="text-xs text-gray-400 mb-2">Move this card to another staff member's account.</p>

                    <div class="relative">
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input type="text" id="manage-product-staff-search"
                                    onfocus="toggleReassignDropdown(true)" onkeyup="filterReassignOptions()"
                                    placeholder="Search & Select Staff Member..." autocomplete="off"
                                    class="w-full bg-[#1a1a1a] border border-gray-800 text-white text-sm rounded-lg pl-3 pr-10 py-2.5 focus:ring-brand-red focus:border-brand-red placeholder-gray-600 cursor-text">
                                <i
                                    class="bi bi-chevron-down absolute right-3 top-3 text-gray-500 pointer-events-none"></i>

                                <!-- Dropdown List -->
                                <div id="reassign-dropdown-list"
                                    class="hidden absolute left-0 right-0 mt-1 max-h-60 overflow-y-auto bg-[#1a1a1a] border border-gray-800 rounded-lg shadow-2xl z-[2100] custom-scrollbar">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <button onclick="saveProductReassignment()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg px-4 py-2.5 text-sm transition-colors whitespace-nowrap">
                                Move
                            </button>
                        </div>
                        <input type="hidden" id="manage-product-reassign-id" value="">
                    </div>
                </div>

                <div class="border-t border-gray-800"></div>

                <!-- Actions Section -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Suspend -->
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-gray-800">
                        <div
                            class="w-10 h-10 rounded-full bg-orange-500/10 text-orange-500 flex items-center justify-center mb-3">
                            <i class="bi bi-pause-circle-fill text-xl"></i>
                        </div>
                        <h4 class="text-white font-bold text-sm mb-1">Suspend Card</h4>
                        <p class="text-gray-500 text-[10px] mb-3">Temporarily disable access to this card.</p>
                        <button id="btn-suspend-card" onclick="toggleCardSuspension()"
                            class="w-full py-2 rounded-lg bg-orange-500/10 text-orange-500 text-xs font-bold hover:bg-orange-500 hover:text-white transition-colors">
                            Suspend
                        </button>
                    </div>

                    <!-- Delete -->
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-red-900/30">
                        <div
                            class="w-10 h-10 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center mb-3">
                            <i class="bi bi-trash-fill text-xl"></i>
                        </div>
                        <h4 class="text-white font-bold text-sm mb-1">Delete Card</h4>
                        <p class="text-gray-500 text-[10px] mb-3">Permanently remove this card.</p>
                        <button onclick="deleteProductCard()"
                            class="w-full py-2 rounded-lg bg-red-500/10 text-red-500 text-xs font-bold hover:bg-red-500 hover:text-white transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay within Modal -->
            <div id="manage-product-loading"
                class="absolute inset-0 bg-black/90 flex items-center justify-center hidden-element">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-red"></div>
            </div>
        </div>
    </div>

    <!-- Reassign Modal -->
    <div id="reassign-modal"
        class="fixed inset-0 bg-black/60 hidden-element flex items-center justify-center z-[1100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl relative">
            <h2 class="text-xl font-bold mb-4 text-gray-900">Reassign Product Card</h2>
            <p class="text-sm text-gray-500 mb-4">Select a staff member to assign the card <b
                    id="reassign-card-slug">/slug</b> to.</p>

            <div class="mb-4">
                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Select Staff Member</label>
                <select id="reassign-user-select"
                    class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-sm text-gray-900 focus:border-brand-black">
                    <!-- Populated JS -->
                </select>
            </div>

            <button onclick="submitReassign()"
                class="w-full bg-brand-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">ASSIGN
                CARD</button>
            <button onclick="document.getElementById('reassign-modal').classList.add('hidden-element')"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">✕</button>
        </div>
    </div>

    <!-- Manage Staff Modal -->
    <div id="manage-staff-modal"
        class="fixed inset-0 bg-black/60 hidden-element flex items-center justify-center z-[1000] backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-2xl relative">
            <h2 class="text-xl font-bold mb-1 text-gray-900">Manage Staff</h2>
            <p id="staff-modal-name" class="text-sm font-semibold mb-0">Staff Name</p>
            <p id="staff-modal-email" class="text-xs text-gray-500 mb-6">staff@email.com</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Assign Admin</label>
                    <select id="staff-assign-admin"
                        class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 text-sm focus:border-brand-black focus:outline-none">
                        <option value="">Unassigned</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Employee ID</label>
                    <input type="text" id="staff-modal-employee-id"
                        class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-sm text-gray-900 focus:border-brand-black focus:outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Sub-Licenses</label>
                    <input type="number" id="staff-modal-sub-licenses" min="0" value="0"
                        class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-sm text-gray-900 focus:border-brand-black focus:outline-none">
                </div>

                <button onclick="saveStaffAssignment()"
                    class="w-full bg-brand-black text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">
                    SAVE ASSIGNMENT
                </button>

                <div class="border-t border-gray-100 pt-4 mt-4 space-y-3">
                    <button id="btn-suspend-staff" onclick="suspendStaff()"
                        class="w-full text-yellow-600 text-xs font-bold hover:text-yellow-700 bg-yellow-50 py-3 rounded-lg">SUSPEND
                        ACCOUNT</button>

                    <button onclick="confirmDeleteStaff()"
                        class="w-full text-red-500 text-xs font-bold hover:text-red-600 bg-red-50 py-3 rounded-lg">DELETE
                        ACCOUNT</button>

                    <div id="delete-staff-confirm" class="hidden bg-red-50 p-4 rounded-xl border border-red-100 mt-2">
                        <p class="text-xs font-bold text-red-700 mb-2">Delete this account?</p>
                        <div class="flex items-start gap-2 mb-3">
                            <input type="checkbox" id="chk-delete-products" checked class="mt-0.5 accent-red-600">
                            <label for="chk-delete-products" class="text-xs text-red-600 leading-snug">
                                Also delete all associated <b>Product Cards</b> permanently?
                            </label>
                        </div>
                        <p class="text-[10px] text-red-500 mb-3 italic">
                            If unchecked, cards will become "Unassigned" and can be reassigned later.
                        </p>
                        <div class="flex gap-2">
                            <button onclick="deleteStaff()"
                                class="flex-1 bg-red-600 text-white text-xs font-bold py-2 rounded shadow-sm hover:bg-red-700">CONFIRM
                                DELETE</button>
                            <button onclick="cancelDeleteStaff()"
                                class="flex-1 bg-white text-red-600 text-xs font-bold py-2 rounded shadow-sm hover:bg-gray-50 border border-red-100">CANCEL</button>
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4 mt-4">
                    <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Reset Password</label>
                        <div class="flex gap-2">
                            <input type="text" id="staff-new-password" readonly placeholder="********"
                                class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs text-gray-600 focus:outline-none">
                            <button id="btn-reset-staff-password" onclick="resetPassword('staff')"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs font-bold whitespace-nowrap transition">
                                <i class="bi bi-arrow-clockwise"></i> Reset
                            </button>
                            <button onclick="copyPassword('staff')"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-xs font-bold transition">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="closeStaffModal()"
                        class="text-gray-400 text-xs hover:text-gray-600">Cancel</button>
                </div>
            </div>
            <button onclick="closeStaffModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">✕</button>
        </div>
    </div>


    <!-- Admin Detail Modal -->
    <div id="admin-detail-modal"
        class="fixed inset-0 bg-black/80 hidden-element flex items-center justify-center z-[1000] backdrop-blur-md">
        <div
            class="bg-[#111] w-full max-w-4xl p-0 rounded-3xl shadow-2xl relative border border-gray-800 flex flex-col max-h-[90vh]">

            <!-- Header Section -->
            <div
                class="p-8 pb-6 border-b border-gray-800 flex flex-col md:flex-row gap-6 items-center md:items-start bg-[#161616] rounded-t-3xl">
                <!-- Avatar -->
                <div class="relative">
                    <div
                        class="w-24 h-24 rounded-full p-1 bg-gradient-to-br from-brand-red to-purple-600 shadow-xl shadow-brand-red/20">
                        <img id="detail-admin-avatar" src="" alt="Admin"
                            class="w-full h-full rounded-full object-cover border-2 border-[#111] hidden">
                        <div id="detail-admin-initial"
                            class="w-full h-full rounded-full bg-[#222] text-white flex items-center justify-center font-bold text-3xl border-2 border-[#111]">
                            A</div>
                    </div>
                </div>

                <!-- Info -->
                <div class="flex-1 text-center md:text-left">
                    <div class="flex items-center justify-center md:justify-between mb-1">
                        <div class="flex items-center gap-3">
                            <h2 id="detail-admin-name" class="text-2xl font-bold text-white">Admin Name</h2>
                            <button id="detail-admin-edit"
                                class="w-8 h-8 rounded-full bg-[#222] border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 flex items-center justify-center transition-colors">
                                <i class="bi bi-pencil-fill text-xs"></i>
                            </button>
                        </div>
                        <button onclick="downloadAdminReport(event)" id="detail-admin-download"
                            class="hidden md:flex items-center gap-2 px-4 py-2 bg-[#222] text-green-400 text-xs font-bold rounded-lg border border-gray-800 hover:bg-[#333] transition mr-12">
                            <i class="bi bi-download"></i> Download Report
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4 justify-center md:justify-start">
                        <p class="text-brand-red font-bold text-sm uppercase tracking-wider">Delegated Enterprise Admin
                        </p>
                        <p
                            class="text-zinc-500 font-bold text-[10px] uppercase tracking-wider border-l border-zinc-700 pl-3">
                            ID: <span id="detail-admin-id">N/A</span></p>
                        <a id="detail-profile-link" href="#" target="_blank"
                            class="px-2 py-0.5 rounded border border-gray-700 bg-[#222] text-gray-400 text-[10px] hover:text-white hover:border-gray-500 transition flex items-center gap-1">
                            <i class="bi bi-box-arrow-up-right"></i> castlecrew.cc/<span
                                id="detail-profile-slug">slug</span>
                        </a>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div>
                                <p id="detail-staff-count" class="text-lg font-bold text-white">0</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Total Staff</p>
                            </div>
                        </div>
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div>
                                <p id="detail-last-login" class="text-sm font-bold text-white">Never</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Last Login</p>
                            </div>
                        </div>
                        <!-- Job Title -->
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-briefcase"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p id="detail-admin-title" class="text-sm font-bold text-white truncate">N/A</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Job Title</p>
                            </div>
                        </div>

                        <!-- Company -->
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p id="detail-admin-company" class="text-sm font-bold text-white truncate">N/A</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Company</p>
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-telephone"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p id="detail-admin-phone" class="text-sm font-bold text-white truncate">N/A</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Phone</p>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p id="detail-admin-email" class="text-sm font-bold text-white truncate">
                                    email@example.com</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Email Address</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="p-6 flex flex-col flex-1 min-h-0">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4 shrink-0">
                    <h3 class="text-lg font-bold text-white border-l-4 border-brand-red pl-3 shrink-0">
                        Managed Staff
                    </h3>

                    <div class="flex-1 max-w-md mx-4 w-full">
                        <div class="relative">
                            <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                            <input type="text" id="detail-staff-search" onkeyup="filterModalStaff()"
                                placeholder="Search staff..."
                                class="w-full bg-[#222] border border-gray-800 rounded-lg pl-9 pr-4 py-2 text-xs text-white focus:outline-none focus:border-brand-red placeholder-gray-600 transition-colors">
                        </div>
                    </div>

                    <div class="flex gap-2 shrink-0 relative">
                        <button onclick="setDetailView('grid')" id="btn-detail-grid"
                            class="w-8 h-8 rounded-lg bg-[#222] text-white flex items-center justify-center transition-colors"><i
                                class="bi bi-grid"></i></button>
                        <button onclick="setDetailView('list')" id="btn-detail-list"
                            class="w-8 h-8 rounded-lg bg-[#222] text-gray-500 hover:text-white flex items-center justify-center transition-colors"><i
                                class="bi bi-list-ul"></i></button>

                        <button onclick="toggleDetailFilter()" id="btn-detail-filter"
                            class="px-3 py-1 rounded-lg bg-[#222] text-gray-400 text-xs font-bold hover:text-white flex items-center gap-2 transition-colors">
                            <i class="bi bi-filter"></i> Filter
                        </button>

                        <!-- Filter Dropdown -->
                        <div id="detail-filter-dropdown"
                            class="absolute right-0 top-full mt-2 w-48 bg-[#222] border border-gray-800 rounded-xl shadow-xl z-50 hidden-element overflow-hidden">
                            <button onclick="setDetailSort('name_asc')"
                                class="w-full text-left px-4 py-3 text-xs text-gray-400 hover:bg-[#333] hover:text-white transition-colors border-b border-gray-800">
                                Sort A-Z
                            </button>
                            <button onclick="setDetailSort('name_desc')"
                                class="w-full text-left px-4 py-3 text-xs text-gray-400 hover:bg-[#333] hover:text-white transition-colors border-b border-gray-800">
                                Sort Z-A
                            </button>
                            <button onclick="setDetailSort('date_desc')"
                                class="w-full text-left px-4 py-3 text-xs text-gray-400 hover:bg-[#333] hover:text-white transition-colors border-b border-gray-800">
                                Date Created (Latest)
                            </button>
                            <button onclick="setDetailSort('date_asc')"
                                class="w-full text-left px-4 py-3 text-xs text-gray-400 hover:bg-[#333] hover:text-white transition-colors">
                                Date Created (Oldest)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Scrollable Grid Wrapper -->
                <div class="overflow-y-auto custom-scrollbar pr-2 -mr-2 max-h-[240px]">
                    <!-- Staff Grid inside Modal -->
                    <div id="detail-staff-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4">
                        <!-- Staff Cards -->
                    </div>

                    <!-- Empty State -->
                    <div id="detail-empty-state" class="hidden text-center py-12">
                        <div
                            class="w-16 h-16 rounded-full bg-[#222] flex items-center justify-center text-gray-600 mx-auto mb-3 text-2xl">
                            <i class="bi bi-people"></i>
                        </div>
                        <p class="text-gray-400 text-sm">No staff members assigned to this admin.</p>
                    </div>
                </div>
            </div>

            <button onclick="closeAdminDetailModal()"
                class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors bg-[#000]/50 rounded-full w-8 h-8 flex items-center justify-center">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <!-- Open Request Modal -->
    <div id="request-modal"
        class="fixed inset-0 bg-black/60 hidden-element flex items-center justify-center z-[1000] backdrop-blur-sm px-4">
        <div
            class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl relative overflow-hidden border border-gray-100">
            <!-- Header -->
            <div class="mb-8">
                <div
                    class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl mb-4 shadow-sm">
                    <i class="bi bi-envelope-plus-fill"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-900 leading-tight">License System Request</h2>
                <p class="text-sm text-gray-500 font-medium">Request additional capacity for your enterprise.</p>
            </div>

            <div class="space-y-6">
                <!-- Request Type -->
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Request
                        Type</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="req-type" value="profile" checked class="peer sr-only">
                            <div
                                class="p-4 bg-gray-50 border border-gray-200 rounded-2xl peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-checked:text-white transition-all group-hover:border-blue-300">
                                <div class="flex items-center gap-3">
                                    <i class="bi bi-person-badge text-xl"></i>
                                    <span class="text-sm font-bold">Profile License</span>
                                </div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer group">
                            <input type="radio" name="req-type" value="sub" class="peer sr-only">
                            <div
                                class="p-4 bg-gray-50 border border-gray-200 rounded-2xl peer-checked:bg-blue-600 peer-checked:border-blue-600 peer-checked:text-white transition-all group-hover:border-blue-300">
                                <div class="flex items-center gap-3">
                                    <i class="bi bi-qr-code text-xl"></i>
                                    <span class="text-sm font-bold">Sub License</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Quantity -->
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Quantity
                        Required</label>
                    <div class="relative group">
                        <input type="number" id="req-amount" value="5" min="1"
                            class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-6 py-4 text-base font-black text-gray-900 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-600 outline-none transition-all placeholder-gray-400">
                        <div
                            class="absolute right-6 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400 uppercase tracking-widest">
                            Slots</div>
                    </div>
                    <p class="text-[10px] text-gray-400 font-bold mt-2 italic px-1">Typical processing time: 2-4 hours.
                    </p>
                </div>

                <!-- Message -->
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Additional
                        Message (Optional)</label>
                    <textarea id="req-message" rows="3" placeholder="Explain why you need more slots..."
                        class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-6 py-4 text-sm font-medium text-gray-900 focus:ring-4 focus:ring-blue-500/10 focus:border-blue-600 outline-none transition-all placeholder-gray-400 resize-none"></textarea>
                </div>

                <!-- Action Button -->
                <button id="btn-submit-request" onclick="submitLicenseRequest()"
                    class="w-full bg-blue-600 text-white font-black py-4 rounded-[1.25rem] shadow-xl shadow-blue-600/20 hover:bg-blue-700 active:scale-95 transition-all text-sm uppercase tracking-widest flex items-center justify-center gap-2">
                    <i class="bi bi-send-fill"></i>
                    <span>Transmit Request</span>
                </button>
            </div>

            <button onclick="document.getElementById('request-modal').classList.add('hidden-element')"
                class="absolute top-6 right-6 w-10 h-10 bg-gray-50 text-gray-400 hover:text-gray-900 rounded-xl flex items-center justify-center transition-all border border-gray-100">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
    </div>

    <!-- Staff Detail Modal -->
    <div id="staff-detail-modal"
        class="fixed inset-0 bg-black/80 hidden-element flex items-center justify-center z-[1000] backdrop-blur-md">
        <div
            class="bg-[#111] w-full max-w-4xl p-0 rounded-3xl shadow-2xl relative border border-gray-800 flex flex-col max-h-[90vh]">

            <!-- Header Section -->
            <div
                class="p-8 pb-6 border-b border-gray-800 flex flex-col md:flex-row gap-6 items-center md:items-start bg-[#161616] rounded-t-3xl">
                <!-- Avatar -->
                <div class="relative">
                    <div
                        class="w-24 h-24 rounded-full p-1 bg-gradient-to-br from-blue-500 to-cyan-400 shadow-xl shadow-blue-500/20">
                        <img id="detail-staff-avatar" src="" alt="Staff"
                            class="w-full h-full rounded-full object-cover border-2 border-[#111] hidden">
                        <div id="detail-staff-initial"
                            class="w-full h-full rounded-full bg-[#222] text-white flex items-center justify-center font-bold text-3xl border-2 border-[#111]">
                            S</div>
                    </div>
                </div>

                <!-- Info -->
                <div class="flex-1 text-center md:text-left">
                    <div class="flex items-center justify-center md:justify-between mb-1">
                        <div class="flex items-center gap-3">
                            <h2 id="detail-staff-name" class="text-2xl font-bold text-white">Staff Name</h2>
                            <button id="detail-staff-edit"
                                class="w-8 h-8 rounded-full bg-[#222] border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 flex items-center justify-center transition-colors">
                                <i class="bi bi-pencil-fill text-xs"></i>
                            </button>
                        </div>
                        <button onclick="downloadStaffReport(event)" id="detail-staff-download"
                            class="hidden md:flex items-center gap-2 px-4 py-2 bg-[#222] text-green-400 text-xs font-bold rounded-lg border border-gray-800 hover:bg-[#333] transition mr-12">
                            <i class="bi bi-download"></i> Download Report
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mb-4 justify-center md:justify-start">
                        <p class="text-gray-400 font-bold text-sm uppercase tracking-wider">Staff Member
                        </p>
                        <p
                            class="text-zinc-500 font-bold text-[10px] uppercase tracking-wider border-l border-zinc-700 pl-3">
                            ID: <span id="detail-staff-id">N/A</span></p>
                        <a id="detail-staff-profile-link" href="#" target="_blank"
                            class="px-2 py-0.5 rounded border border-gray-700 bg-[#222] text-gray-400 text-[10px] hover:text-white hover:border-gray-500 transition flex items-center gap-1">
                            <i class="bi bi-box-arrow-up-right"></i> castlecrew.cc/<span
                                id="detail-staff-profile-slug">slug</span>
                        </a>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-qr-code"></i>
                            </div>
                            <div>
                                <p id="detail-staff-product-count" class="text-lg font-bold text-white">0</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Products</p>
                            </div>
                        </div>
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-unlock"></i>
                            </div>
                            <div>
                                <p id="detail-staff-licenses" class="text-sm font-bold text-white">0</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Sub-Licenses</p>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="bg-[#222] rounded-xl p-3 flex items-center gap-3 border border-gray-800">
                            <div
                                class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-gray-400">
                                <i class="bi bi-envelope"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p id="detail-staff-email" class="text-sm font-bold text-white truncate">
                                    email@example.com</p>
                                <p class="text-[10px] uppercase text-gray-500 font-bold">Email Address</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="p-6 flex flex-col flex-1 min-h-0">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4 shrink-0">
                    <h3 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3 shrink-0">
                        Assigned Products
                    </h3>

                    <div class="flex-1 max-w-md mx-4 w-full">
                        <div class="relative">
                            <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xs"></i>
                            <input type="text" id="detail-product-search" onkeyup="filterModalProducts()"
                                placeholder="Search products..."
                                class="w-full bg-[#222] border border-gray-800 rounded-lg pl-9 pr-4 py-2 text-xs text-white focus:outline-none focus:border-blue-500 placeholder-gray-600 transition-colors">
                        </div>
                    </div>
                </div>

                <!-- Scrollable Grid Wrapper -->
                <div class="overflow-y-auto custom-scrollbar pr-2 -mr-2 max-h-[240px]">
                    <!-- Products Grid inside Modal -->
                    <div id="detail-product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4">
                        <!-- Product Cards -->
                    </div>

                    <!-- Empty State -->
                    <div id="detail-product-empty-state" class="hidden text-center py-12">
                        <div
                            class="w-16 h-16 rounded-full bg-[#222] flex items-center justify-center text-gray-600 mx-auto mb-3 text-2xl">
                            <i class="bi bi-qr-code"></i>
                        </div>
                        <p class="text-gray-400 text-sm">No products found for this user.</p>
                    </div>
                </div>
            </div>

            <button onclick="closeStaffDetailModal()"
                class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors bg-[#000]/50 rounded-full w-8 h-8 flex items-center justify-center">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <script>
        async function downloadCardQRCode(slug) {
            try {
                // 1. Generate QR Code Data URL
                const qrContainer = document.createElement('div');
                const url = window.location.origin + '/' + slug;

                // Uses qrcode.js
                new QRCode(qrContainer, {
                    text: url,
                    width: 500,
                    height: 500,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Wait slightly for canvas render
                await new Promise(r => setTimeout(r, 100));

                const canvas = qrContainer.querySelector('canvas');
                if (!canvas) throw new Error("QR Generation failed");
                const imgData = canvas.toDataURL('image/png');

                // 2. Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Add Logo
                // Assuming logo is at assets/img/logo.png - fetching base64 or just using addImage with url (might CORS)
                // For safety, let's just make a nice header text
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(20, 20, 20);
                doc.text("Castle Cards", 105, 30, { align: "center" });

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text("Scan to view profile", 105, 40, { align: "center" });

                // Add QR Code
                doc.addImage(imgData, 'PNG', 55, 60, 100, 100);

                // Add Slug Text
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text(`/${slug}`, 105, 175, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text(url, 105, 182, { align: "center" });

                // Footer
                doc.setFontSize(10);
                doc.setTextColor(200, 200, 200);
                doc.text("Powered by Castle Crew", 105, 280, { align: "center" });

                doc.save(`qrcode_${slug}.pdf`);

            } catch (e) {
                console.error(e);
                alert('Failed to generate QR Code PDF: ' + e.message);
            }
        }

        // *** CORE DASHBOARD LOGIC (Updated to generate new table styles) ***

        document.addEventListener('DOMContentLoaded', () => {
            // Remove preloader
            const preloader = document.getElementById('preloader');
            setTimeout(() => {
                preloader.classList.add('fade-out');
                setTimeout(() => { preloader.style.display = 'none'; }, 700);
            }, 500);

            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const res = await fetch('/api/enterprise/dashboard');
                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) window.location.href = 'login.html';
                    throw new Error("Failed to fetch data");
                }
                const data = await res.json();
                window.dashboardDataCache = data; // Cache the data globally

                // 1. Company Info
                document.getElementById('company-name').innerText = data.company.name;

                // Set Logo if available
                const logoImg = document.getElementById('company-logo');
                if (data.company.logo) {
                    logoImg.src = data.company.logo;
                    logoImg.classList.remove('hidden');
                } else {
                    logoImg.classList.add('hidden');
                }

                // 2. Stats
                const totalStaffLicenses = data.company.license_count || 0;
                const totalSubLicenses = data.company.sub_license_count || 0;
                const assignedLicenses = data.stats.assigned_sub_licenses || 0;
                const usedLicenses = data.stats.product_card_count || 0;
                const activeStaffCards = data.stats.active_staff_count || 0;

                // Populate Stats
                // Card 1: Profile Licenses (Format: used/total)
                // Using activeStaffCards as proxy for 'used' profile licenses
                if (document.getElementById('lic-total')) {
                    document.getElementById('lic-total').innerText = `${activeStaffCards}/${totalStaffLicenses}`;

                    const createBtn = document.getElementById('btn-create-account');
                    const warning = document.getElementById('license-warning');

                    if (activeStaffCards >= totalStaffLicenses && totalStaffLicenses > 0) {
                        if (createBtn) {
                            createBtn.disabled = true;
                            createBtn.classList.add('opacity-50', 'cursor-not-allowed');
                            createBtn.innerText = 'Limit Reached';
                        }
                        if (warning) warning.classList.remove('hidden-element');
                    } else {
                        if (createBtn) {
                            createBtn.disabled = false;
                            createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            createBtn.innerText = 'Create New Account';
                        }
                        if (warning) warning.classList.add('hidden-element');
                    }
                }

                // Card 2: Sub Licenses (Format: used/total)
                if (document.getElementById('lic-assigned')) {
                    document.getElementById('lic-assigned').innerText = `${assignedLicenses}/${totalSubLicenses}`;

                    const subWarning = document.getElementById('sub-license-warning');
                    if (assignedLicenses >= totalSubLicenses && totalSubLicenses > 0) {
                        if (subWarning) subWarning.classList.remove('hidden-element');
                    } else {
                        if (subWarning) subWarning.classList.add('hidden-element');
                    }
                }

                // Card 3: Active Staff
                if (document.getElementById('active-cards')) {
                    document.getElementById('active-cards').innerText = activeStaffCards;
                }

                // Card 4: Active Products
                if (document.getElementById('unassigned-seats')) {
                    document.getElementById('unassigned-seats').innerText = usedLicenses;
                }

                // Other stats
                // No longer using total-licenses label


                // Use optional chaining or checks for elements that might be hidden/removed
                if (document.getElementById('active-staff')) document.getElementById('active-staff').innerText = activeStaffCards;
                if (document.getElementById('total-views')) document.getElementById('total-views').innerText = data.stats.total_views.toLocaleString();
                if (document.getElementById('total-leads')) document.getElementById('total-leads').innerText = data.stats.total_leads.toLocaleString();

                // 3. Admins List
                let admins = data.admins || [];

                // Fetch Profile Data for Admins concurrently to populate cards
                // We use Promise.allSettled to ensure dashboard loads even if some fetches fail
                const adminEnrichmentPromises = []; /* admins.map(async (admin) => {
                // Default values
                admin.job_title = 'N/A';
                admin.company = 'N/A';
                admin.phone = 'N/A';

                if (admin.slug) {
                    try {
                        // Public endpoint to get card data by slug (or reuse internal API if available)
                        // Assuming /api/card/public/:slug or similar, relying on public page scrape or internal lookup
                        // ERROR: We don't have a direct "get card by slug" API handy in this file context easily without auth acting as them.
                        // WORKAROUND: We will look for them in the 'data.staff' list if they are also staff? No, they are admins.
                        // BETTER: We should use the same logic as the independent fetch but for each admin.
                        // OR: Just rely on what's available. 

                        // Let's assume for now we can't easily fetch their full profile without a dedicated endpoint or them being logged in.
                        // However, the USER says "they are in the profile card". 
                        // This implies the data IS available somewhere.
                        // Let's check if 'data.admins' from the backend ALREADY has this, and maybe we just need to map it.
                        // If not, we might need to fetch it.

                        // Let's try to fetch active card data for these admins if possible.
                        // Since we can't easily iterate all, let's skip complex fetching for now and assume
                        // we need to ask the backend to provide this.

                        // FAST FIX: Check if the API response 'data.admins' can be updated. 
                        // BUT wait, the user shows the data IS there in "digital card column". 
                        // Ah, I added "Digital Card Column" logic before? 
                        // Wait, I see `renderAdminsGrid`. 

                        // Let's look at `renderAdminsTable` (if it existed) or the Logic to get "Profile Pic".
                        // The `admin` object has `avatar_url`, `name`, `email`.
                        // Maybe the backend `data.admins` needs to include `latest_card` info.
                    } catch (e) {
                        // ignore
                    }
                }
                return admin;
            }); */

                // WAIT, I cannot easily change the BACKEND right now (user said "get more details FROM THE PROFILE CARD").
                // If the profile card is public, I can fetch it? 
                // actually, let's look at how the "Staff List" gets its data. It has `cards`.
                // Admins also have cards.

                // SIMULATION: I will manually fetch the card data for each admin using their slug if available.
                if (false && admins.length > 0) {
                    await Promise.all(admins.map(async (admin) => {
                        if (admin.slug) {
                            try {
                                const res = await fetch(`/api/card/public-by-slug?slug=${admin.slug}`);
                                // note: this endpoint might not exist. 
                                // Alternative: Fetch the HTML of their profile page? Too heavy.

                                // Let's try to see if `data.staff` contains these admins? 
                                // Sometimes admins are also listed in staff if they have a card.
                            } catch (e) { }
                        }
                    }));
                }

                // REALIZATION: I cannot implement a backend fetch loop here easily without knowing endpoints.
                // However, I can try to fetch the "Card" data if I have a way.

                window.availableAdmins = admins; // Store globally
                try {
                    document.getElementById('total-admins-count').innerText = admins.length;
                    renderAdminsGrid();
                } catch (e) { console.error(e); }

                const adminListEl = document.getElementById('admin-list');
                if (admins.length === 0) {
                    adminListEl.innerHTML = '<tr><td class="p-6 text-center text-gray-500" colspan="4">No delegated admins found.</td></tr>';
                } else {
                    const adminHtml = admins.map(admin => `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0">
                            <td class="p-4 pl-6 cursor-pointer group" onclick="openAdminDetailModal(${admin.id})">
                                <div class="flex items-center gap-3">
                                    ${admin.avatar_url ?
                            `<img src="${admin.avatar_url}" alt="${admin.name}" class="w-8 h-8 rounded-full object-cover border border-gray-100 group-hover:scale-110 transition-transform">` :
                            `<div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs uppercase group-hover:bg-brand-red group-hover:text-white transition-colors">
                                            ${(admin.name || 'A').charAt(0)}
                                        </div>`
                        }
                                    <div>
                                        <p class="font-bold text-gray-900 group-hover:text-brand-red transition-colors">${admin.name || 'No Name'}</p>
                                        <p class="text-xs text-gray-500">${admin.email}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4">
                                ${admin.slug ?
                            `<a href="/${admin.slug}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-blue-50 text-blue-600 text-xs font-bold hover:bg-blue-100 transition">
                                        <i class="bi bi-link-45deg"></i> /${admin.slug}
                                     </a>` :
                            '<span class="text-gray-400 text-xs italic">N/A</span>'}
                            </td>
                            <td class="p-4 text-gray-600 font-medium">${admin.staff_managed} Users</td>
                            <td class="p-4 text-gray-500 text-xs">${admin.last_login || 'Never'}</td>
                            <td class="p-4 text-right pr-6">
                                <button onclick="openManageAdminModal(${admin.id}, '${admin.email}')" class="text-gray-400 hover:text-brand-black transition">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    adminListEl.innerHTML = adminHtml;
                }

                // 4. Staff List
                // Filter out 'product' type cards
                // 4. Staff List & Active Products
                const rawStaff = data.staff || [];
                const staffMap = new Map(); // UserId -> Array of cards

                // Group cards by User ID
                rawStaff.forEach(u => {
                    if (!staffMap.has(u.id)) staffMap.set(u.id, []);
                    staffMap.get(u.id).push(u);
                });

                const staffProfiles = [];
                const activeProducts = [];

                staffMap.forEach((cards, userId) => {
                    // Logic to find best profile card
                    // Default to first card if no better match found
                    // Score cards based on similarity to username part of email
                    const username = (cards[0].email || '').split('@')[0].toLowerCase();

                    cards.forEach(c => {
                        let score = 0;
                        // Massive bonus for cards with no parent (Main Cards)
                        if (!c.parent_id) score += 100;

                        const s = (c.slug || '').toLowerCase();
                        if (s === username) score += 10;
                        else if (s.includes(username)) score += 5;
                        c._score = score;
                    });

                    // Sort descending by score
                    cards.sort((a, b) => b._score - a._score);

                    // First one is the Profile
                    staffProfiles.push(cards[0]);

                    // The rest are Products
                    for (let i = 1; i < cards.length; i++) {
                        activeProducts.push({
                            ...cards[i],
                            ownerName: cards[0].name
                        });
                    }
                });

                // Render Unassigned Products
                const unassignedEl = document.getElementById('unassigned-products');
                const unassignedListEl = document.getElementById('unassigned-products-list');
                const orphans = data.unassigned_cards || [];

                if (orphans.length > 0) {
                    unassignedEl.classList.remove('hidden');
                    document.getElementById('total-unassigned-products').innerText = orphans.length;

                    unassignedListEl.innerHTML = orphans.map(prod => `
                        <tr class="hover:bg-zinc-800/50 transition border-b border-zinc-800 last:border-0">
                            <td class="p-4 pl-6">
                                    <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-zinc-800 text-orange-500 flex items-center justify-center font-bold text-lg">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                    </div>
                                    <div>
                                        <a href="/${prod.slug}" target="_blank" class="font-bold text-white hover:text-brand-red transition">/${prod.slug}</a>
                                        <p class="text-xs text-gray-500">${prod.full_name || 'No Name'}</p>
                                    </div>
                                    </div>
                            </td>
                            <td class="p-4 text-gray-400 text-xs">
                                ${new Date(prod.created_at).toLocaleDateString()}
                            </td>
                            <td class="p-4 text-right pr-6">
                                <button onclick="openReassignModal(${prod.id}, '${prod.slug}')" class="bg-orange-600 hover:bg-orange-500 text-white text-[10px] font-bold px-3 py-1.5 rounded transition">
                                        REASSIGN
                                </button>
                            </td>
                        </tr>
                        `).join('');
                } else {
                    unassignedEl.classList.add('hidden');
                }

                // Render Staff List
                const staff = staffProfiles;
                window.availableStaff = staff; // Store globally for Grid View
                window.availableProducts = activeProducts; // Store globally for Staff Detail View
                try {
                    if (document.getElementById('total-staff-count')) {
                        document.getElementById('total-staff-count').innerText = staff.length;
                    }
                    renderStaffGrid();
                } catch (e) { console.error(e); }

                const staffListEl = document.getElementById('staff-user-list');
                if (staff.length === 0) {
                    staffListEl.innerHTML = '<tr><td class="p-6 text-center text-gray-500" colspan="4">No staff users found.</td></tr>';
                } else {
                    const staffHtml = staff.map(user => `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0">
                            <td class="p-4 pl-6 cursor-pointer group" onclick="openStaffDetailModal(${user.id})">
                                <div class="flex items-center gap-3">
                                    ${user.avatar_url ?
                            `<img src="${user.avatar_url}" alt="${user.name}" class="w-8 h-8 rounded-full object-cover border border-gray-100 group-hover:scale-110 transition-transform">` :
                            `<div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs uppercase group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                            ${(user.name || 'U').charAt(0)}
                                        </div>`
                        }
                                    <div>
                                        <p class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors">${user.name || 'No Name'}</p>
                                        <p class="text-xs text-gray-500">${user.email}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4">
                                ${user.slug ?
                            `<a href="/${user.slug}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 rounded bg-blue-50 text-blue-600 text-xs font-bold hover:bg-blue-100 transition">
                                        <i class="bi bi-link-45deg"></i> /${user.slug}
                                    </a>` :
                            '<span class="text-gray-400 text-xs italic">Not Created</span>'}
                            </td>
                            <td class="p-4 text-gray-600 text-sm">
                                ${admins.find(a => a.id === user.assigned_admin_id)?.name || '<span class="text-gray-400">Unassigned</span>'}
                            </td>
                            <td class="p-4">
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-[11px] font-bold">
                                    ${(staffMap.get(user.id) || []).filter(c => c.parent_id !== null).length} / ${user.sub_license_count || 0}
                                </span>
                            </td>
                            <td class="p-4 text-right pr-6">
                                <button onclick="openManageStaffModal(${user.id}, '${user.name.replace(/'/g, "\\'")}', '${user.email}', ${user.assigned_admin_id})" class="text-gray-400 hover:text-brand-black transition">
                                     <i class="bi bi-three-dots-vertical"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    staffListEl.innerHTML = staffHtml;

                    // Update Active Staff random avatars
                    const avatarGroup = document.getElementById('active-staff-avatars');
                    if (avatarGroup) {
                        const allAvailableAvatars = [];
                        // Collect from admins
                        admins.forEach(a => { if (a.avatar_url) allAvailableAvatars.push(a.avatar_url); });
                        // Collect from staff (profiles)
                        staff.forEach(s => { if (s.avatar_url) allAvailableAvatars.push(s.avatar_url); });

                        // Shuffle and pick 3
                        const shuffled = allAvailableAvatars.sort(() => 0.5 - Math.random());
                        const itemsToShow = shuffled.slice(0, 3);

                        if (itemsToShow.length > 0) {
                            avatarGroup.innerHTML = itemsToShow.map(url =>
                                `<img src="${url}" class="w-6 h-6 rounded-full border-2 border-white object-cover shadow-sm">`
                            ).join('') + (allAvailableAvatars.length > 3 ?
                                `<div class="w-6 h-6 rounded-full bg-brand-black border-2 border-white text-[8px] flex items-center justify-center font-bold text-white shadow-sm">+${allAvailableAvatars.length - 3}</div>` : '');
                        } else {
                            // Fallback if no avatars available
                            avatarGroup.innerHTML = `
                                <div class="w-6 h-6 rounded-full bg-gray-100 border-2 border-white flex items-center justify-center text-[8px] text-gray-400 font-bold">CC</div>
                                <div class="w-6 h-6 rounded-full bg-gray-200 border-2 border-white flex items-center justify-center text-[8px] text-gray-400 font-bold">CC</div>
                            `;
                        }
                    }
                }

                // Render Active Products List
                const productsListEl = document.getElementById('active-products-list');
                if (productsListEl) {
                    const totalProdEl = document.getElementById('total-products');
                    if (totalProdEl) totalProdEl.innerText = activeProducts.length;

                    if (activeProducts.length === 0) {
                        productsListEl.innerHTML = '<tr><td class="p-6 text-center text-gray-500" colspan="3">No active products found.</td></tr>';
                    } else {
                        productsListEl.innerHTML = activeProducts.map(prod => `
                            <tr class="hover:bg-gray-900/50 transition border-b border-gray-800 last:border-0">
                                <td class="p-4 pl-6">
                                     <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-gray-800 text-white flex items-center justify-center font-bold text-lg">
                                            <i class="bi bi-qr-code"></i>
                                        </div>
                                        <div>
                                            <a href="/${prod.slug}" target="_blank" class="font-bold text-white hover:text-brand-red transition">/${prod.slug}</a>
                                            <p class="text-xs text-gray-500">Product Card</p>
                                        </div>
                                     </div>
                                </td>
                                <td class="p-4">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-brand-red text-white flex items-center justify-center text-[10px] font-bold">
                                            ${(prod.ownerName || 'U').charAt(0)}
                                        </div>
                                        <span class="text-gray-300 text-sm font-medium">${prod.ownerName || 'Unknown'}</span>
                                    </div>
                                </td>
                                <td class="p-4 text-right pr-6">
                                    <button onclick="openManageProductModal(${prod.card_id}, '${prod.slug}', ${!!prod.card_suspended})" class="text-gray-400 hover:text-white transition">
                                         <i class="bi bi-pencil-square"></i>
                                    </button>
                                </td>
                            </tr>
                         `).join('');
                    }
                }

                // Render Logs
                const logsContainer = document.getElementById('activity-logs');
                const logs = data.logs || [];

                if (logsContainer) {
                    if (logs.length === 0) {
                        logsContainer.innerHTML = '<div class="p-6 text-center text-gray-400 text-xs">No recent activity.</div>';
                    } else {
                        logsContainer.innerHTML = logs.map(log => {
                            let icon = 'bi-circle';
                            let iconColor = 'bg-gray-100 text-gray-500';

                            // Style based on type
                            if (log.type === 'new_staff') {
                                icon = 'bi-person-plus-fill';
                                iconColor = 'bg-blue-50 text-blue-600';
                            } else if (log.type === 'new_card') {
                                icon = 'bi-qr-code';
                                iconColor = 'bg-purple-50 text-purple-600';
                            } else if (log.type === 'new_lead') {
                                icon = 'bi-telephone-inbound-fill';
                                iconColor = 'bg-green-50 text-green-600';
                            }

                            const date = new Date(log.timestamp).toLocaleString();

                            return `
                                <div class="p-4 flex gap-3 hover:bg-gray-50 transition">
                                    <div class="mt-1 w-8 h-8 rounded-full ${iconColor} flex items-center justify-center text-sm shrink-0">
                                        <i class="bi ${icon}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex justify-between items-start">
                                            <p class="text-sm font-bold text-gray-900 truncate">${log.title}</p>
                                            <span class="text-[10px] text-gray-400 whitespace-nowrap ml-2">${date}</span>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-0.5">${log.description}</p>
                                        ${log.target_name ? `<p class="text-xs font-medium text-gray-800 mt-1">Target: ${log.target_name}</p>` : ''}
                                        ${log.slug ?
                                    `<a href="/${log.slug}" target="_blank" class="inline-flex items-center gap-1 mt-2 text-[10px] font-bold text-gray-400 hover:text-brand-red transition uppercase tracking-wide">
                                                VIEW ${log.type === 'new_staff' ? 'PROFILE' : 'CARD'} <i class="bi bi-arrow-right"></i>
                                             </a>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }



                // 5. Header Profile (Populate from User Data)
                if (data.user) {
                    document.getElementById('header-profile-name').innerText = data.user.name || 'Super Admin';
                    document.getElementById('header-profile-role').innerText = data.user.position || 'Enterprise Mode';
                    if (data.user.avatar_url) {
                        document.getElementById('header-profile-img').src = data.user.avatar_url;
                    }
                }

                // INDEPENDENT: Fetch Card Data for accurate Profile Pic/Name
                // This runs regardless of whether data.user exists in the dashboard response
                try {
                    console.log("Fetching independent profile data...");
                    const token = localStorage.getItem('castle_token');
                    if (token) {
                        const cardRes = await fetch('/api/card', { headers: { 'Authorization': token } });
                        const cardData = await cardRes.json();
                        console.log("Profile Data received:", cardData);

                        // Avatar Preference: Card > User Object
                        if (cardData.avatar_url) {
                            document.getElementById('header-profile-img').src = cardData.avatar_url;
                        }

                        // Name Preference: Card > User Object > Fallback
                        if (cardData.full_name) {
                            document.getElementById('header-profile-name').innerText = cardData.full_name;
                        }

                        // Role/Position Preference: Card > User Object > Fallback
                        if (cardData.job_title) {
                            document.getElementById('header-profile-role').innerText = cardData.job_title;
                        }

                        // Populate Dropdown Links
                        if (cardData.slug) {
                            document.getElementById('link-visit-profile').href = `/${cardData.slug}`;
                            document.getElementById('link-edit-card').href = `editor.html?slug=${cardData.slug}`;
                        }
                    }
                } catch (err) {
                    console.warn("Could not fetch card avatar", err);
                }

            } catch (e) {
                console.error("Failed to load Enterprise data:", e);
            }
        }

        // *** SEARCH LOGIC ***
        function handleMainSearch(query) {
            const resultsContainer = document.getElementById('main-search-results');
            const content = document.getElementById('search-results-content');

            if (!query || query.trim().length < 1) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase().trim();
            const results = [];

            // Search Admins
            if (window.availableAdmins) {
                window.availableAdmins.forEach(admin => {
                    if ((admin.name && admin.name.toLowerCase().includes(q)) ||
                        (admin.email && admin.email.toLowerCase().includes(q)) ||
                        (admin.employee_id && String(admin.employee_id).toLowerCase().includes(q))) {
                        results.push({
                            type: 'Admin',
                            icon: 'bi-shield-lock-fill',
                            color: 'bg-red-50 text-brand-red',
                            name: admin.name || 'No Name',
                            sub: admin.email, id: admin.id,
                            employee_id: admin.employee_id,
                            avatar: admin.avatar_url
                        });
                    }
                });
            }

            // Search Staff
            if (window.availableStaff) {
                // Remove duplicates if same user has multiple cards (window.availableStaff contains raw user/card joins)
                const uniqueStaff = [];
                const seenIds = new Set();
                window.availableStaff.forEach(s => {
                    if (!seenIds.has(s.id)) {
                        uniqueStaff.push(s);
                        seenIds.add(s.id);
                    }
                });

                uniqueStaff.forEach(staff => {
                    if ((staff.name && staff.name.toLowerCase().includes(q)) ||
                        (staff.email && staff.email.toLowerCase().includes(q)) ||
                        (staff.employee_id && String(staff.employee_id).toLowerCase().includes(q))) {
                        results.push({
                            type: 'Staff',
                            icon: 'bi-person-fill',
                            color: 'bg-blue-50 text-blue-500',
                            name: staff.name || 'No Name',
                            sub: staff.email,
                            id: staff.id,
                            employee_id: staff.employee_id,
                            avatar: staff.avatar_url
                        });
                    }
                });
            }

            // Search Products
            if (window.availableProducts) {
                window.availableProducts.forEach(prod => {
                    if ((prod.slug && prod.slug.toLowerCase().includes(q)) ||
                        (prod.full_name && prod.full_name.toLowerCase().includes(q))) {
                        results.push({
                            type: 'Product',
                            icon: 'bi-qr-code',
                            color: 'bg-purple-50 text-purple-500',
                            name: `/${prod.slug}`,
                            sub: prod.full_name || 'Product Card',
                            id: prod.card_id || prod.id,
                            slug: prod.slug,
                            is_suspended: !!(prod.card_suspended || prod.is_suspended)
                        });
                    }
                });
            }

            if (results.length === 0) {
                content.innerHTML = `<div class="p-8 text-center">
                    <div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 mx-auto mb-3 text-xl">
                        <i class="bi bi-search"></i>
                    </div>
                    <p class="text-gray-500 text-sm font-medium">No results found for "${query}"</p>
                    <p class="text-gray-400 text-[10px] uppercase font-bold mt-1 tracking-widest">Try searching by name or ID</p>
                </div>`;
            } else {
                content.innerHTML = results.map(res => `
                    <div onclick="handleSearchResultClick('${res.type}', '${res.id}', '${res.slug || ''}', '${res.sub || ''}', ${!!res.is_suspended})" 
                         class="p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 flex items-center gap-4 group transition">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center ${res.color} text-lg shrink-0 group-hover:scale-110 transition-transform shadow-sm overflow-hidden">
                            ${res.avatar ?
                        `<img src="${res.avatar}" alt="${res.name}" class="w-full h-full object-cover">` :
                        `<i class="bi ${res.icon}"></i>`
                    }
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-0.5">
                                <span class="font-bold text-gray-900 truncate">${res.name}</span>
                                <span class="text-[9px] font-black uppercase tracking-tighter px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">${res.type}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <p class="text-xs text-gray-500 truncate">${res.sub}</p>
                                ${res.employee_id ? `<span class="text-[10px] text-gray-400 font-bold border-l border-gray-200 pl-2">ID: ${res.employee_id}</span>` : ''}
                            </div>
                        </div>
                        <i class="bi bi-chevron-right text-gray-300 group-hover:text-gray-900 transition-colors"></i>
                    </div>
                `).join('');
            }

            resultsContainer.classList.remove('hidden');
        }

        function handleSearchResultClick(type, id, slug, email, isSuspended) {
            document.getElementById('main-search-results').classList.add('hidden');
            document.getElementById('main-search-input').value = '';

            if (type === 'Admin') {
                openAdminDetailModal(parseInt(id));
            } else if (type === 'Staff') {
                openStaffDetailModal(parseInt(id));
            } else if (type === 'Product') {
                openManageProductModal(id, slug, isSuspended === 'true' || isSuspended === true);
            }
        }

        // *** DROPDOWN LOGIC ***
        function toggleProfileDropdown() {
            const dd = document.getElementById('profile-dropdown');
            if (dd.classList.contains('hidden')) {
                dd.classList.remove('hidden');
            } else {
                dd.classList.add('hidden');
            }
        }

        // Close dropdown when clicking outside
        window.onclick = function (event) {
            if (!event.target.closest('.relative')) {
                const dd = document.getElementById('profile-dropdown');
                if (dd && !dd.classList.contains('hidden')) {
                    dd.classList.add('hidden');
                }
            }

            // Close search results when clicking outside
            if (!event.target.closest('#main-search-container')) {
                const searchResults = document.getElementById('main-search-results');
                if (searchResults && !searchResults.classList.contains('hidden')) {
                    searchResults.classList.add('hidden');
                }
            }
        }


        // *** ACCOUNT CREATION LOGIC ***
        function openCreateAccountModal() {
            document.getElementById('create-account-modal').classList.remove('hidden');
            document.getElementById('create-account-modal').classList.add('flex');

            // Populate Admin Dropdown
            const select = document.getElementById('new-account-assign-admin');
            select.innerHTML = '<option value="">Unassigned</option>';
            if (window.availableAdmins) {
                window.availableAdmins.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.id;
                    option.innerText = admin.name;
                    select.appendChild(option);
                });
            }

            toggleAccountFields();
        }

        function closeCreateAccountModal() {
            document.getElementById('create-account-modal').classList.add('hidden');
            document.getElementById('create-account-modal').classList.remove('flex');
            document.getElementById('new-account-name').value = '';
            document.getElementById('new-account-email').value = '';
            document.getElementById('new-account-password').value = '';
            document.getElementById('new-account-licenses').value = '0';
            document.getElementById('new-account-type').value = 'admin';
            document.getElementById('new-account-assign-admin').value = '';
            document.getElementById('create-account-error').innerText = '';
            document.getElementById('create-account-error').classList.add('hidden');
        }

        function toggleAccountFields() {
            const type = document.getElementById('new-account-type').value;
            const pwField = document.getElementById('field-password');
            const licField = document.getElementById('field-licenses');
            const assignField = document.getElementById('field-assign-admin');

            if (type === 'staff') {
                pwField.classList.add('hidden');
                licField.classList.remove('hidden');
                assignField.classList.remove('hidden');
            } else {
                pwField.classList.remove('hidden');
                licField.classList.add('hidden');
                assignField.classList.add('hidden');
            }
        }

        async function createAccount() {
            const btn = document.getElementById('btn-create-account');
            const errorMsg = document.getElementById('create-account-error');
            const type = document.getElementById('new-account-type').value;
            const name = document.getElementById('new-account-name').value;
            const email = document.getElementById('new-account-email').value;
            const employeeId = document.getElementById('new-account-employee-id').value;

            btn.disabled = true;
            btn.innerText = "CREATING...";
            errorMsg.classList.add('hidden');

            try {
                let url, body;

                if (type === 'admin') {
                    const password = document.getElementById('new-account-password').value;
                    if (!password) throw new Error("Password is required for Admin accounts.");
                    url = '/api/enterprise/create-admin';
                    body = { name, email, password, employee_id: employeeId };
                } else {
                    const licenses = document.getElementById('new-account-licenses').value;
                    const assignedAdminId = document.getElementById('new-account-assign-admin').value;
                    url = '/api/enterprise/create-staff';
                    body = {
                        name,
                        email,
                        sub_licenses: parseInt(licenses) || 0,
                        assigned_admin_id: assignedAdminId || null,
                        employee_id: employeeId
                    };
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (data.success || res.ok) { // Check res.ok too as create-staff returns success: true
                    closeCreateAccountModal();
                    loadDashboardData();
                    alert(data.message || (type === 'staff' ? `Staff account created! Temp Password: ${data.temp_password}` : "Account created successfully!"));
                } else {
                    throw new Error(data.error || "Failed to create account");
                }
            } catch (e) {
                errorMsg.innerText = e.message;
                errorMsg.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = "CREATE ACCOUNT";
            }
        }

        // *** STAFF DETAIL MODAL LOGIC ***
        let currentDetailStaffId = null;

        // Open Staff Detail Modal
        function openStaffDetailModal(staffId) {
            console.log("EXEC: openStaffDetailModal for " + staffId);
            try {
                currentDetailStaffId = staffId;
                const staffList = window.availableStaff || [];
                console.log("Staff List Size: " + staffList.length);

                const user = staffList.find(u => String(u.id) === String(staffId));

                if (!user) {
                    console.error("Staff user not found for ID:", staffId);
                    alert("Error: User ID " + staffId + " not found in data.");
                    return;
                }
                console.log("User found: " + user.name);

                // Populate Header
                const nameEl = document.getElementById('detail-staff-name');
                if (nameEl) nameEl.innerText = user.name || 'Staff User';

                const emailEl = document.getElementById('detail-staff-email');
                if (emailEl) emailEl.innerText = user.email;

                // Edit Staff Button Handler
                const editBtn = document.getElementById('detail-staff-edit');
                if (editBtn) {
                    editBtn.onclick = function () {
                        closeStaffDetailModal();
                        try { closeAdminDetailModal(); } catch (e) { } // Ensure parent admin modal is also closed
                        openManageStaffModal(user.id, user.name || '', user.email, user.assigned_admin_id);
                    };
                }

                const idEl = document.getElementById('detail-staff-id');
                if (idEl) idEl.innerText = user.employee_id || 'N/A';

                const licEl = document.getElementById('detail-staff-licenses');
                if (licEl) licEl.innerText = user.sub_license_count || 0;

                // Profile Slug Link
                const slug = user.slug;
                const profileLink = document.getElementById('detail-staff-profile-link');
                const profileSlugSpan = document.getElementById('detail-staff-profile-slug');

                if (profileLink && profileSlugSpan) {
                    if (slug) {
                        profileLink.href = `https://castlecrew.cc/${slug}`;
                        profileSlugSpan.innerText = slug;
                        profileLink.classList.remove('hidden-element');
                        if (profileLink.parentElement) profileLink.parentElement.classList.remove('hidden-element');
                    } else {
                        profileLink.href = '#';
                        profileSlugSpan.innerText = 'N/A';
                        profileLink.classList.add('hidden-element');
                    }
                }

                const avatarImg = document.getElementById('detail-staff-avatar');
                const initialDiv = document.getElementById('detail-staff-initial');

                if (user.avatar_url && avatarImg && initialDiv) {
                    avatarImg.src = user.avatar_url;
                    avatarImg.classList.remove('hidden');
                    initialDiv.classList.add('hidden');
                } else if (initialDiv && avatarImg) {
                    initialDiv.innerText = (user.name || 'S').charAt(0);
                    initialDiv.classList.remove('hidden');
                    avatarImg.classList.add('hidden');
                }

                // Products
                try {
                    renderDetailProductGrid();
                } catch (renderErr) {
                    console.error("Error rendering product grid:", renderErr);
                }

                const modal = document.getElementById('staff-detail-modal');
                if (modal) {
                    console.log("Showing Modal now...");
                    modal.classList.remove('hidden-element');
                    modal.style.display = 'flex'; // Force display
                } else {
                    alert("Error: Modal element not found");
                }
            } catch (e) {
                console.error("Error opening staff modal:", e);
                alert("An error occurred while opening the profile: " + e.message);
            }
        }

        window.openStaffDetailModal = openStaffDetailModal;

        function closeStaffDetailModal() {
            document.getElementById('staff-detail-modal').classList.add('hidden-element');
        }
        window.closeStaffDetailModal = closeStaffDetailModal;

        function filterModalProducts() {
            renderDetailProductGrid();
        }

        function renderDetailProductGrid() {
            if (!currentDetailStaffId) return;

            const searchInput = document.getElementById('detail-product-search');
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
            const container = document.getElementById('detail-product-grid');
            const emptyState = document.getElementById('detail-product-empty-state');
            const countEl = document.getElementById('detail-staff-product-count');

            const staffProducts = (window.availableProducts || []).filter(p => {
                // Data comes from 'users' table mainly, so p.id is the User ID.
                if (String(p.id) !== String(currentDetailStaffId)) return false;
                if (!searchQuery) return true;
                return (p.slug || '').toLowerCase().includes(searchQuery);
            });

            if (countEl) countEl.innerText = (window.availableProducts || []).filter(p => String(p.id) === String(currentDetailStaffId)).length;

            if (staffProducts.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            container.innerHTML = staffProducts.map(prod => `
                <div class="bg-[#222] rounded-xl p-4 border border-gray-800 hover:border-gray-600 transition flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gray-800 text-white flex items-center justify-center font-bold text-lg">
                        <i class="bi bi-qr-code"></i>
                    </div>
                    <div class="overflow-hidden flex-1">
                        <a href="/${prod.slug}" target="_blank" class="block font-bold text-white text-sm hover:text-brand-red transition truncate">/${prod.slug}</a>
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Product Card</p>
                    </div>
                     <a href="/${prod.slug}" target="_blank" class="text-gray-500 hover:text-white">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
            `).join('');
        }

        async function downloadStaffReport(event) {
            if (event) event.preventDefault();
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not ready. Please wait.");
                return;
            }

            if (!currentDetailStaffId) return;

            const user = window.availableStaff.find(u => u.id === currentDetailStaffId);
            if (!user) return;

            const products = (window.availableProducts || []).filter(p => String(p.id) === String(user.id));

            const doc = new jsPDF();

            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text("Staff Member Report", 14, 22);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);

            doc.setDrawColor(200, 200, 200);
            doc.line(14, 32, 196, 32);

            // Staff Details Section
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Staff Profile", 14, 45);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");

            const leftX = 14;
            let y = 55;
            const lineHeight = 7;

            doc.text(`Name:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${user.name || 'N/A'}`, leftX + 30, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Email:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${user.email || 'N/A'}`, leftX + 30, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Employee ID:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${user.employee_id || 'N/A'}`, leftX + 30, y);

            // Right Column
            const rightX = 110;
            y = 55;

            doc.setFont("helvetica", "normal");
            doc.text(`Sub-Licenses:`, rightX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${user.sub_license_count || 0}`, rightX + 30, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Active Products:`, rightX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${products.length}`, rightX + 30, y);

            // Products Table
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Assigned Products", 14, 90);

            const tableRows = products.map(p => [
                `/${p.slug}`,
                'Product Card',
                user.name || 'N/A', // Owner
                'Active' // Status (assuming active if returned)
            ]);

            if (tableRows.length > 0) {
                doc.autoTable({
                    startY: 95,
                    head: [['Slug', 'Type', 'Owner', 'Status']],
                    body: tableRows,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 3 },
                    headStyles: { fillColor: [20, 20, 20], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
            } else {
                doc.setFont("helvetica", "italic");
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text("No products assigned.", 14, 100);
            }

            const fileName = `Staff_Report_${(user.name || 'staff').replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.pdf`;
            doc.save(fileName);
        }

        // *** STAFF MANAGEMENT LOGIC ***
        let currentStaffId = null;

        function openManageStaffModal(id, name, email, assignedAdminId) {
            currentStaffId = id;
            document.getElementById('staff-modal-name').innerText = name;
            document.getElementById('staff-modal-email').innerText = email;

            // Populate Employee ID & Sub-Licenses
            const staff = (window.availableStaff || []).find(s => s.id === id);
            document.getElementById('staff-modal-employee-id').value = (staff && staff.employee_id) ? staff.employee_id : '';
            document.getElementById('staff-modal-sub-licenses').value = (staff && staff.sub_license_count) ? staff.sub_license_count : 0;

            updateStaffSuspendUI(staff ? staff.is_suspended : 0);

            // Populate Dropdown
            const select = document.getElementById('staff-assign-admin');
            select.innerHTML = '<option value="">Unassigned</option>';

            if (window.availableAdmins) {
                window.availableAdmins.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.id;
                    option.innerText = admin.name + (admin.id == assignedAdminId ? ' (Current)' : '');
                    if (admin.id == assignedAdminId) option.selected = true;
                    select.appendChild(option);
                });
            }

            document.getElementById('manage-staff-modal').classList.remove('hidden-element');
        }

        function closeStaffModal() {
            document.getElementById('manage-staff-modal').classList.add('hidden-element');
            currentStaffId = null;
            document.getElementById('staff-new-password').value = '';
            document.getElementById('delete-staff-confirm').classList.add('hidden');
        }

        function updateStaffSuspendUI(isSuspended) {
            const btn = document.getElementById('btn-suspend-staff');
            if (isSuspended) {
                btn.innerText = "REACTIVATE ACCOUNT";
                btn.className = "w-full text-green-600 text-xs font-bold hover:text-green-700 bg-green-50 py-3 rounded-lg";
            } else {
                btn.innerText = "SUSPEND ACCOUNT";
                btn.className = "w-full text-yellow-600 text-xs font-bold hover:text-yellow-700 bg-yellow-50 py-3 rounded-lg";
            }
        }

        async function suspendStaff() {
            if (!currentStaffId) return;
            // Find stats
            const user = (window.availableStaff || []).find(u => u.id === currentStaffId);
            const isSuspended = user ? user.is_suspended : 0;
            const action = isSuspended ? 'unsuspend' : 'suspend';

            if (!confirm(`Are you sure you want to ${action} this staff account?`)) return;

            try {
                const res = await fetch('/api/enterprise/suspend-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentStaffId, action: action })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`Account ${action}ed.`);
                    closeStaffModal();
                    loadDashboardData();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) { alert(e.message); }
        }

        function confirmDeleteStaff() {
            document.getElementById('delete-staff-confirm').classList.remove('hidden');
        }

        function cancelDeleteStaff() {
            document.getElementById('delete-staff-confirm').classList.add('hidden');
        }

        async function deleteStaff() {
            if (!currentStaffId) return;
            const keepCards = !document.getElementById('chk-delete-products').checked;

            try {
                const res = await fetch('/api/enterprise/delete-account', { // Reusing delete endpoint (needs update to accept delete_cards)
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentStaffId,
                        delete_cards: !keepCards // Inverse logic
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`Account deleted.${keepCards ? ' Associated product cards are now Unassigned.' : ''}`);
                    closeStaffModal();
                    loadDashboardData();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) { alert(e.message); }
        }

        async function saveStaffAssignment() {
            if (!currentStaffId) return;
            const newAdminId = document.getElementById('staff-assign-admin').value;
            const employeeId = document.getElementById('staff-modal-employee-id').value;
            const subLicenses = document.getElementById('staff-modal-sub-licenses').value;

            try {
                // 1. Update Assignment
                const assignRes = await fetch('/api/enterprise/update-staff-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        staff_user_id: currentStaffId,
                        action: 'assign_admin',
                        new_admin_id: newAdminId
                    })
                });

                // 2. Update Details (Employee ID)
                const detailsRes = await fetch('/api/enterprise/update-staff-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        staff_user_id: currentStaffId,
                        action: 'update_details',
                        employee_id: employeeId
                    })
                });

                // 3. Update Sub-License Limit
                const limitRes = await fetch('/api/enterprise/update-staff-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        staff_user_id: currentStaffId,
                        action: 'update_limit',
                        limit: parseInt(subLicenses) || 0
                    })
                });

                const assignData = await assignRes.json();
                const detailsData = await detailsRes.json();
                const limitData = await limitRes.json();

                if (assignData.success || assignRes.status === 403) { // 403 if regular admin tries to reassign, ignore
                    // Check details & limit success
                    if (detailsRes.ok && limitRes.ok) {
                        alert('Changes saved!');
                        closeStaffModal();
                        loadDashboardData();
                    } else {
                        throw new Error("Failed to update details or limits");
                    }
                } else {
                    throw new Error(assignData.error || "Failed to update assignment");
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function resetPassword(type) {
            let userId;
            let passwordFieldId;
            let btnId;
            let userType;

            if (type === 'admin') {
                userId = currentAdminId;
                passwordFieldId = 'admin-new-password';
                btnId = 'btn-reset-admin-password';
                userType = 'admin';
            } else if (type === 'staff') {
                userId = currentStaffId;
                passwordFieldId = 'staff-new-password';
                btnId = 'btn-reset-staff-password';
                userType = 'staff';
            } else {
                console.error("Invalid type for resetPassword:", type);
                return;
            }

            if (!userId) {
                alert(`No ${type} selected.`);
                return;
            }

            const btn = document.getElementById(btnId);
            const originalText = btn.innerText;
            btn.innerText = "RESETTING...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/enterprise/admin-reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, userType })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById(passwordFieldId).value = data.new_password;
                    alert('Password reset successfully!');
                } else {
                    throw new Error(data.error || "Failed to reset password");
                }
            } catch (e) {
                alert('Error resetting password: ' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function copyPassword(type) {
            let passwordFieldId;
            let feedbackElementId;

            if (type === 'admin') {
                passwordFieldId = 'admin-new-password';
                feedbackElementId = 'admin-copy-feedback';
            } else if (type === 'staff') {
                passwordFieldId = 'staff-new-password';
                feedbackElementId = 'staff-copy-feedback';
            } else {
                console.error("Invalid type for copyPassword:", type);
                return;
            }

            const passwordField = document.getElementById(passwordFieldId);
            if (passwordField && passwordField.value) {
                navigator.clipboard.writeText(passwordField.value).then(() => {
                    const feedback = document.getElementById(feedbackElementId);
                    if (feedback) {
                        feedback.classList.remove('hidden');
                        setTimeout(() => {
                            feedback.classList.add('hidden');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Failed to copy password: ', err);
                    alert('Failed to copy password. Please copy manually.');
                });
            } else {
                alert('No password to copy.');
            }
        }

        // *** ADMIN MANAGEMENT MODAL LOGIC ***
        let currentAdminId = null;

        function openManageAdminModal(id, email) {
            currentAdminId = id;
            document.getElementById('admin-modal-email').innerText = email;

            // Populate Employee ID & Suspension Status
            const admin = (window.availableAdmins || []).find(a => a.id === id);
            document.getElementById('admin-modal-employee-id').value = (admin && admin.employee_id) ? admin.employee_id : '';

            // Update Suspend Button Text/Color
            updateSuspendButtonUI(admin ? admin.is_suspended : 0);

            document.getElementById('manage-admin-modal').classList.remove('hidden-element');
            // Reset password field
            document.getElementById('admin-new-password').value = '';
        }

        function updateSuspendButtonUI(isSuspended) {
            const btn = document.getElementById('btn-suspend-admin');
            if (!btn) return;

            if (isSuspended) {
                btn.innerText = "REACTIVATE ACCOUNT";
                btn.className = "w-full text-green-600 text-xs font-bold hover:text-green-700 bg-green-50 py-3 rounded-lg";
            } else {
                btn.innerText = "SUSPEND ACCOUNT";
                btn.className = "w-full text-yellow-600 text-xs font-bold hover:text-yellow-700 bg-yellow-50 py-3 rounded-lg";
            }
        }

        async function suspendAdmin() {
            if (!currentAdminId) return;
            const admin = (window.availableAdmins || []).find(a => a.id === currentAdminId);
            const isSuspended = admin ? admin.is_suspended : 0;
            const action = isSuspended ? 'unsuspend' : 'suspend';

            const confirmMsg = isSuspended
                ? "Reactivate this account? They will be able to login again."
                : "Suspend this account? Login and Profile pages will be disabled.";

            if (!confirm(confirmMsg)) return;

            const btn = document.getElementById('btn-suspend-admin');
            const originalText = btn.innerText;
            btn.innerText = "PROCESSING...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/enterprise/suspend-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentAdminId, action: action })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`Account ${action}ed successfully.`);
                    closeAdminModal();
                    loadDashboardData();
                } else {
                    throw new Error(data.error || "Failed to update status");
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function closeAdminModal() {
            document.getElementById('manage-admin-modal').classList.add('hidden-element');
            currentAdminId = null;
            document.getElementById('admin-new-password').value = '';
        }

        async function saveAdminChanges() {
            if (!currentAdminId) return;
            const employeeId = document.getElementById('admin-modal-employee-id').value;

            try {
                const res = await fetch('/api/enterprise/update-staff-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        staff_user_id: currentAdminId,
                        action: 'update_details',
                        employee_id: employeeId
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert('Admin details updated!');
                    closeAdminModal();
                    loadDashboardData();
                } else {
                    throw new Error(data.error || "Failed to update admin");
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteAdmin() {
            if (!currentAdminId) return;
            // Confirm with user
            if (!confirm("Are you sure you want to DELETE this account permanently? This action cannot be undone.")) return;

            const btn = document.querySelector('#manage-admin-modal button.text-red-500'); // simplistic selector, better to give ID if possible, but this works for now
            const originalText = btn ? btn.innerText : "DELETE ACCOUNT";
            if (btn) {
                btn.innerText = "DELETING...";
                btn.disabled = true;
            }

            try {
                const res = await fetch('/api/enterprise/delete-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentAdminId })
                });

                const data = await res.json();

                if (data.success) {
                    alert('Account deleted permanently.');
                    closeAdminModal();
                    loadDashboardData();
                } else {
                    throw new Error(data.error || "Failed to delete account");
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        }

        // *** STAFF USER MANAGEMENT LOGIC ***
        function manageStaffUser(id) {
            alert(`Managing Staff User #${id}.`);
        }

        // *** EDIT ENTERPRISE LOGIC ***
        function openEditEnterpriseModal() {
            const currentName = document.getElementById('company-name').innerText;
            document.getElementById('edit-ent-name').value = currentName === "Loading..." ? "" : currentName;
            document.getElementById('edit-enterprise-modal').classList.remove('hidden');
            document.getElementById('edit-enterprise-modal').classList.add('flex');
        }

        function closeEditEnterpriseModal() {
            document.getElementById('edit-enterprise-modal').classList.add('hidden');
            document.getElementById('edit-enterprise-modal').classList.remove('flex');
            document.getElementById('edit-enterprise-form').reset();
            document.getElementById('file-name-display').innerText = "No file selected";
        }

        function previewLogo(input) {
            if (input.files && input.files[0]) {
                document.getElementById('file-name-display').innerText = input.files[0].name;
            }
        }

        async function saveEnterpriseDetails(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "SAVING...";
            btn.disabled = true;

            const name = document.getElementById('edit-ent-name').value;
            const logoInput = document.getElementById('edit-ent-logo');

            const formData = new FormData();
            formData.append('name', name);
            if (logoInput.files && logoInput.files[0]) {
                formData.append('logo', logoInput.files[0]);
            }

            try {
                const res = await fetch('/api/enterprise/update', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                alert('Enterprise details updated successfully!');
                closeEditEnterpriseModal();
                loadDashboardData();

            } catch (err) {
                console.error(err);
                alert('Error updating details: ' + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function downloadAdminReport(event) {
            if (event) event.preventDefault();
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not ready. Please wait.");
                return;
            }

            if (!currentDetailAdminId) return;

            const admin = window.availableAdmins.find(a => a.id === currentDetailAdminId);
            if (!admin) return;

            const managedStaff = (window.availableStaff || []).filter(u => u.assigned_admin_id === admin.id);

            const doc = new jsPDF();

            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(40, 40, 40);
            doc.text("Enterprise Admin Report", 14, 22);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);

            doc.setDrawColor(200, 200, 200);
            doc.line(14, 32, 196, 32);

            // Admin Details Section
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Admin Profile", 14, 45);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");

            // Left Column
            const leftX = 14;
            let y = 55;
            const lineHeight = 7;

            doc.text(`Name:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${admin.name || 'N/A'}`, leftX + 25, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Email:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${admin.email || 'N/A'}`, leftX + 25, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Employee ID:`, leftX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${admin.employee_id || 'N/A'}`, leftX + 25, y);

            // Right Column
            const rightX = 110;
            y = 55;

            doc.setFont("helvetica", "normal");
            doc.text(`Phone:`, rightX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${admin.phone || 'N/A'}`, rightX + 25, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Role:`, rightX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`Delegated Admin`, rightX + 25, y);

            y += lineHeight;
            doc.setFont("helvetica", "normal");
            doc.text(`Total Staff:`, rightX, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${managedStaff.length}`, rightX + 25, y);

            // Managed Staff Table
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text("Managed Staff List", 14, 90);

            const tableRows = managedStaff.map(s => [
                s.name || 'N/A',
                s.email || 'N/A',
                s.employee_id || 'N/A',
                s.sub_license_count || '0',
                new Date(s.created_at || Date.now()).toLocaleDateString()
            ]);

            if (tableRows.length > 0) {
                doc.autoTable({
                    startY: 95,
                    head: [['Name', 'Email', 'Employee ID', 'Sub-Licenses', 'Created']],
                    body: tableRows,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 3 },
                    headStyles: { fillColor: [20, 20, 20], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
            } else {
                doc.setFont("helvetica", "italic");
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text("No staff members assigned.", 14, 100);
            }

            const fileName = `Admin_Report_${(admin.name || 'admin').replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.pdf`;
            doc.save(fileName);
        }

        async function downloadLogsPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not ready. Please wait.");
                return;
            }

            const doc = new jsPDF();
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("Enterprise Activity Logs", 14, 20);

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 26);

            const logsContainer = document.getElementById('activity-logs');
            const rows = [];

            // Scrape data from DOM
            const logItems = logsContainer.querySelectorAll('.flex.gap-3');
            logItems.forEach(item => {
                const title = item.querySelector('p.font-bold')?.innerText || '';
                const date = item.querySelector('span.whitespace-nowrap')?.innerText || '';
                const desc = item.querySelector('p.text-gray-600')?.innerText || '';
                const target = item.querySelector('p.font-medium')?.innerText || '';

                rows.push([date, title, desc, target.replace('Target: ', '')]);
            });

            if (rows.length === 0) {
                alert("No logs to download.");
                return;
            }

            doc.autoTable({
                startY: 35,
                head: [['Date', 'Event', 'Description', 'Target']],
                body: rows,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [40, 40, 40] }
            });

            doc.save(`Enterprise_Logs_${Date.now()}.pdf`);
        }


        // *** REASSIGN LOGIC ***
        let currentReassignCardId = null;

        // *** MANAGE PRODUCT MODAL LOGIC ***
        let currentManageCardId = null;
        let currentManageCardSlug = null;
        let currentManageCardSuspended = false;

        function openManageProductModal(cardId, slug, isSuspended) {
            currentManageCardId = cardId;
            currentManageCardSlug = slug;
            currentManageCardSuspended = isSuspended;

            document.getElementById('manage-product-slug-title').innerText = slug;
            document.getElementById('manage-product-modal').classList.remove('hidden-element');

            // Reset Searchable Dropdown
            document.getElementById('manage-product-staff-search').value = '';
            document.getElementById('manage-product-reassign-id').value = '';
            toggleReassignDropdown(false);

            // Set Suspend Button State
            updateSuspendButtonState();

            // Populate Reassign Dropdown Options
            renderReassignOptions();
        }

        function toggleReassignDropdown(show) {
            const list = document.getElementById('reassign-dropdown-list');
            if (show) {
                list.classList.remove('hidden');
                renderReassignOptions();
            } else {
                // Delay hiding to allow click events on items to fire
                setTimeout(() => list.classList.add('hidden'), 200);
            }
        }

        function filterReassignOptions() {
            renderReassignOptions();
            document.getElementById('reassign-dropdown-list').classList.remove('hidden');
        }

        function renderReassignOptions() {
            const list = document.getElementById('reassign-dropdown-list');
            const searchInput = document.getElementById('manage-product-staff-search');
            const query = searchInput.value.toLowerCase();
            const staff = window.availableStaff || [];

            const filtered = staff.filter(s =>
                (s.name || '').toLowerCase().includes(query) ||
                (s.employee_id || '').toLowerCase().includes(query) ||
                (s.email || '').toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-3 text-gray-500 text-xs italic">No matching staff found</div>`;
                return;
            }

            list.innerHTML = filtered.map(s => `
                <div onclick="selectStaffForReassign(${s.id}, '${s.name.replace(/'/g, "\\'")}')" 
                     class="p-3 hover:bg-brand-red/10 cursor-pointer border-b border-gray-800/50 last:border-0 transition-colors flex items-center justify-between group">
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-white group-hover:text-brand-red">${s.name}</span>
                        <span class="text-[10px] text-gray-500">${s.email}</span>
                    </div>
                    ${s.employee_id ? `<span class="text-[10px] font-bold text-gray-600 bg-gray-800/50 px-2 py-0.5 rounded uppercase tracking-wider">ID: ${s.employee_id}</span>` : ''}
                </div>
            `).join('');
        }

        function selectStaffForReassign(id, name) {
            document.getElementById('manage-product-reassign-id').value = id;
            document.getElementById('manage-product-staff-search').value = name;
            toggleReassignDropdown(false);
        }

        function closeManageProductModal() {
            document.getElementById('manage-product-modal').classList.add('hidden-element');
        }

        function updateSuspendButtonState() {
            const btn = document.getElementById('btn-suspend-card');
            if (currentManageCardSuspended) {
                btn.innerHTML = 'Reactivate';
                btn.className = "w-full py-2 rounded-lg bg-green-500/10 text-green-500 text-xs font-bold hover:bg-green-500 hover:text-white transition-colors";
                btn.parentElement.querySelector('h4').innerText = "Reactivate Card";
                btn.parentElement.querySelector('p').innerText = "Make this card public again.";
                btn.parentElement.querySelector('.rounded-full').className = "w-10 h-10 rounded-full bg-green-500/10 text-green-500 flex items-center justify-center mb-3";
                btn.parentElement.querySelector('i').className = "bi bi-play-circle-fill text-xl";
            } else {
                btn.innerHTML = 'Suspend';
                btn.className = "w-full py-2 rounded-lg bg-orange-500/10 text-orange-500 text-xs font-bold hover:bg-orange-500 hover:text-white transition-colors";
                btn.parentElement.querySelector('h4').innerText = "Suspend Card";
                btn.parentElement.querySelector('p').innerText = "Temporarily disable access to this card.";
                btn.parentElement.querySelector('.rounded-full').className = "w-10 h-10 rounded-full bg-orange-500/10 text-orange-500 flex items-center justify-center mb-3";
                btn.parentElement.querySelector('i').className = "bi bi-pause-circle-fill text-xl";
            }
        }

        async function toggleCardSuspension() {
            if (!currentManageCardId) return;
            const action = currentManageCardSuspended ? 'reactivate' : 'suspend';

            document.getElementById('manage-product-loading').classList.remove('hidden-element');
            try {
                const res = await fetch('/api/enterprise/suspend-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_id: currentManageCardId, action: action })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                currentManageCardSuspended = !currentManageCardSuspended;
                updateSuspendButtonState();

                // Refresh dashboard data
                await loadDashboardData();
                switchView('products'); // Re-render grid

            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                document.getElementById('manage-product-loading').classList.add('hidden-element');
            }
        }

        async function deleteProductCard() {
            if (!currentManageCardId) return;
            if (!confirm(`Are you sure you want to PERMANENTLY delete product /${currentManageCardSlug}? This cannot be undone.`)) return;

            document.getElementById('manage-product-loading').classList.remove('hidden-element');
            try {
                const res = await fetch('/api/enterprise/delete-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_id: currentManageCardId })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                closeManageProductModal();
                await loadDashboardData();
                switchView('products');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                document.getElementById('manage-product-loading').classList.add('hidden-element');
            }
        }

        async function saveProductReassignment() {
            const newOwnerId = document.getElementById('manage-product-reassign-id').value;
            if (!newOwnerId) {
                alert('Please select a staff member assignment from the list.');
                return;
            }

            document.getElementById('manage-product-loading').classList.remove('hidden-element');
            try {
                const res = await fetch('/api/enterprise/reassign-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_id: currentManageCardId, new_user_id: newOwnerId })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                closeManageProductModal();
                await loadDashboardData();
                switchView('products');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                document.getElementById('manage-product-loading').classList.add('hidden-element');
            }
        }

        function openReassignModal(cardId, slug) {
            currentReassignCardId = cardId;
            document.getElementById('reassign-card-slug').innerText = '/' + slug;
            const modal = document.getElementById('reassign-modal');
            const select = document.getElementById('reassign-user-select');

            select.innerHTML = '';
            // Populate with all staff (and maybe Admins too? Assuming just staff for now)
            // Flatten Staff List
            const allStaff = window.availableStaff || [];
            allStaff.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.innerText = `${s.name} (${s.email})`;
                select.appendChild(opt);
            });

            modal.classList.remove('hidden-element');
        }

        async function submitReassign() {
            if (!currentReassignCardId) return;
            const newUserId = document.getElementById('reassign-user-select').value;

            try {
                const res = await fetch('/api/enterprise/reassign-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_id: currentReassignCardId, new_user_id: newUserId })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Card reassigned.');
                    document.getElementById('reassign-modal').classList.add('hidden-element');
                    loadDashboardData();
                } else {
                    throw new Error(data.error);
                }
            } catch (e) { alert(e.message); }
        }

        // *** QR GENERATION LOGIC ***
        let currentQRColor = "#000000";

        function setQRColor(color) {
            currentQRColor = color;
            document.getElementById('qr-custom-color').value = color;
            generateCustomQR();
        }

        async function generateCustomQR() {
            const container = document.getElementById('custom-qr-container');
            const actions = document.getElementById('qr-actions');
            const placeholder = document.getElementById('qr-placeholder-text');
            const input = document.getElementById('qr-input-text').value;
            const containerBox = document.getElementById('qr-preview-box');

            if (!input || input.trim() === "") {
                container.innerHTML = "";
                containerBox.classList.add('opacity-50', 'grayscale');
                actions.classList.add('hidden');
                placeholder.classList.remove('hidden');
                return;
            }

            placeholder.classList.add('hidden');

            // Remove grayscale from the actual container holding the QR
            container.classList.remove('opacity-50', 'grayscale');

            // Also ensure box is clean just in case
            containerBox.classList.remove('opacity-50', 'grayscale');

            // Ensure reset
            if (window.qrCodeInstance) {
                window.qrCodeInstance.clear(); // clear the code.
                document.getElementById('custom-qr-container').innerHTML = "";
            }

            // Small delay to allow DOM to clear
            await new Promise(r => setTimeout(r, 50));

            window.qrCodeInstance = new QRCode(container, {
                text: input,
                width: 250,
                height: 250,
                colorDark: currentQRColor,
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Logo Overlay Logic
            const includeLogo = document.getElementById('qr-include-logo').checked;
            // Fallback: If cache is missing, try to locate logo from header or use placeholder logic
            let companyLogo = window.dashboardDataCache && window.dashboardDataCache.company ? window.dashboardDataCache.company.logo : null;

            // Debug: If no logo in cache but user wants one, check if we can grab it from usage elsewhere
            if (!companyLogo && includeLogo) {
                console.warn("Logo not found in dashboardDataCache. Checking fallback.");
                // Fallback: This might be null if not loaded yet
                const headerLogo = document.querySelector('img[src*="logo"]'); // simplistic check
                // We won't rely on random DOM elements for now to avoid weird images.
            }

            console.log("QR Generation - Include Logo:", includeLogo);
            console.log("QR Generation - Company Logo URL:", companyLogo);

            if (includeLogo && companyLogo) {
                // Wait slightly longer to ensure QRCode library has painted 
                await new Promise(r => setTimeout(r, 100));

                const canvas = container.querySelector('canvas');
                if (canvas) {
                    console.log("QR Generation - Canvas found. context:", canvas.getContext('2d'));
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.crossOrigin = "Anonymous";

                    img.onload = () => {
                        console.log("QR Generation - Logo Image Loaded. Drawing...");
                        const size = 60; // Logo size
                        const padding = 8; // More breathing room
                        const bgSize = size + (padding * 2);
                        const x = (canvas.width - size) / 2;
                        const y = (canvas.height - size) / 2;
                        const bgX = (canvas.width - bgSize) / 2;
                        const bgY = (canvas.height - bgSize) / 2;

                        // Save context
                        ctx.save();

                        // Draw Circle White Background
                        const radius = bgSize / 2;
                        const centerX = bgX + radius;
                        const centerY = bgY + radius;

                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                        ctx.fillStyle = "#ffffff";
                        ctx.fill();

                        ctx.restore();

                        // Draw logo centered
                        ctx.drawImage(img, x, y, size, size);

                        // IMPORTANT: Update display image
                        const displayImg = container.querySelector('img');
                        if (displayImg && displayImg.src !== companyLogo) {
                            console.log("QR Generation - Updating display image from canvas...");
                            displayImg.src = canvas.toDataURL();
                        }
                    };

                    img.onerror = (e) => {
                        console.error("QR Generation - Failed to load logo image.", e);
                        alert("Could not load enterprise logo for QR code. It might be a broken link or CORS issue.");
                    };

                    // Add cache buster to ensure CORS works if enabled on server
                    // Only add cache buster if it's http/https, not data uri
                    if (companyLogo.startsWith('http')) {
                        img.src = companyLogo + (companyLogo.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                    } else {
                        img.src = companyLogo;
                    }
                } else {
                    console.error("QR Generation - Canvas element NOT found in container.");
                }
            }

            actions.classList.remove('hidden');
        }

        function downloadCustomQR(format) {
            const container = document.getElementById('custom-qr-container');
            const canvas = container.querySelector('canvas');
            if (!canvas) return;

            if (format === 'png') {
                const img = canvas.toDataURL("image/png");
                const a = document.createElement('a');
                a.href = img;
                a.download = 'custom-qr.png';
                a.click();
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const imgData = canvas.toDataURL('image/png');
                doc.setFontSize(20);
                doc.text("Custom QR Code", 105, 40, { align: "center" });
                doc.addImage(imgData, 'PNG', 55, 60, 100, 100);
                doc.save('custom-qr.pdf');
            }
        }

        // *** VIEW SWITCHING LOGIC ***
        function switchView(viewName) {
            const dashboardView = document.getElementById('dashboard-view');
            const adminsView = document.getElementById('admins-view');
            const staffView = document.getElementById('staff-view');
            const productsView = document.getElementById('products-view');
            const messagingView = document.getElementById('messaging-view');
            const requestsHistoryView = document.getElementById('requests-history-view');
            const qrGeneratorView = document.getElementById('qr-generator-view');

            // Nav Links
            const navDashboard = document.getElementById('nav-dashboard');
            const navAdmins = document.getElementById('nav-admins');
            const navStaff = document.getElementById('nav-staff');
            const navProducts = document.getElementById('nav-products');
            const navMessaging = document.getElementById('nav-messaging');
            const navRequestsHistory = document.getElementById('nav-requests-history');
            const navQrGenerator = document.getElementById('nav-qr-generator');

            // Hide All
            if (dashboardView) dashboardView.classList.add('hidden');
            if (adminsView) adminsView.classList.add('hidden');
            if (staffView) staffView.classList.add('hidden');
            if (productsView) productsView.classList.add('hidden-element');
            if (messagingView) messagingView.classList.add('hidden');
            if (requestsHistoryView) requestsHistoryView.classList.add('hidden-element');
            if (qrGeneratorView) qrGeneratorView.classList.add('hidden');

            // Reset all nav styles
            [navDashboard, navAdmins, navStaff, navProducts, navMessaging, navRequestsHistory, navQrGenerator].forEach(nav => {
                if (!nav) return;
                nav.classList.remove('bg-brand-black', 'text-white', 'shadow-lg', 'shadow-gray-200');
                nav.classList.add('text-gray-500', 'hover:bg-gray-50', 'hover:text-gray-900');
                if (nav.querySelector('span')) {
                    nav.querySelector('span').classList.remove('font-semibold');
                    nav.querySelector('span').classList.add('font-medium');
                }
                const icon = nav.querySelector('i');
                if (icon) icon.classList.remove('text-brand-red');
            });

            // Activate specific view and nav
            let activeNav;

            if (viewName === 'dashboard') {
                if (dashboardView) dashboardView.classList.remove('hidden');
                activeNav = navDashboard;
            } else if (viewName === 'admins') {
                if (adminsView) adminsView.classList.remove('hidden');
                activeNav = navAdmins;
                renderAdminsGrid();
            } else if (viewName === 'staff') {
                if (staffView) staffView.classList.remove('hidden');
                activeNav = navStaff;
                renderStaffGrid();
            } else if (viewName === 'products') {
                if (productsView) productsView.classList.remove('hidden-element');
                activeNav = navProducts;
                renderAllProductsGrid();
            } else if (viewName === 'messaging') {
                if (messagingView) messagingView.classList.remove('hidden');
                activeNav = navMessaging;
                loadMessages();
            } else if (viewName === 'requests-history') {
                if (requestsHistoryView) requestsHistoryView.classList.remove('hidden-element');
                activeNav = navRequestsHistory;
                loadRequestsHistory();
            } else if (viewName === 'qr-generator') {
                if (qrGeneratorView) qrGeneratorView.classList.remove('hidden');
                activeNav = navQrGenerator;
            }

            // Apply active style
            if (activeNav) {
                activeNav.classList.add('bg-brand-black', 'text-white', 'shadow-lg');
                activeNav.classList.remove('text-gray-500', 'hover:bg-gray-50', 'hover:text-gray-900');
                activeNav.querySelector('span').classList.add('font-semibold');
                activeNav.querySelector('span').classList.remove('font-medium');
                activeNav.querySelector('i').classList.add('text-brand-red');
            }
        }

        function renderAdminsGrid() {
            const container = document.getElementById('admins-grid-container');
            if (!container) return;

            const admins = window.availableAdmins || [];

            if (admins.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">No admins found.</div>';
                return;
            }

            container.innerHTML = admins.map(admin => {
                const initial = (admin.name || 'A').charAt(0);
                // Premium Card Design
                const avatar = admin.avatar_url
                    ? `<img src="${admin.avatar_url}" alt="${admin.name}" class="w-full h-full rounded-full object-cover border-2 border-[#111]">`
                    : `<div class="w-full h-full rounded-full bg-[#222] text-white flex items-center justify-center font-bold text-2xl border-2 border-[#111]">${initial}</div>`;

                return `
                <div class="bg-[#111] rounded-2xl p-6 relative flex flex-col items-center shadow-xl border border-gray-800 group hover:-translate-y-1 transition-all duration-300">
                   <!-- Actions -->
                   <button class="absolute top-4 left-4 text-gray-700 hover:text-yellow-400 transition-colors"><i class="bi bi-star-fill"></i></button>
                   <button onclick="openManageAdminModal(${admin.id}, '${admin.email}')" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"><i class="bi bi-three-dots-vertical"></i></button>
                   
                   <!-- Avatar -->
                   <div class="w-20 h-20 rounded-full p-1 bg-gradient-to-br from-brand-red to-purple-600 mb-4 mt-2 shadow-lg shadow-brand-red/20">
                       ${avatar}
                   </div>
                   
                   <!-- Ident -->
                   <h3 class="text-white font-bold text-lg mb-1">${admin.name || 'Admin'}</h3>
                   <p class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1">Delegated Admin</p>
                   <p class="text-zinc-600 text-[10px] uppercase tracking-wider font-bold mb-6">ID: ${admin.employee_id || 'N/A'}</p>
                   
                   <!-- Action Button -->
                   <button onclick="openAdminDetailModal(${admin.id})" class="w-full py-2 rounded-lg bg-[#222] text-gray-300 text-xs font-bold uppercase tracking-wide hover:bg-white hover:text-black transition-colors text-center border border-gray-800 hover:border-white">
                        View Profile
                   </button>
                </div>
                `;
            }).join('');
        }

        function renderAllProductsGrid() {
            const container = document.getElementById('products-grid-container');
            if (!container) return;

            // Build Product List
            let allProducts = [];

            // 1. Add Unassigned
            if (window.dashboardDataCache && window.dashboardDataCache.unassigned_cards) {
                window.dashboardDataCache.unassigned_cards.forEach(c => {
                    allProducts.push({
                        id: c.id,
                        slug: c.slug,
                        full_name: c.full_name,
                        created_at: c.created_at,
                        status: 'Unassigned',
                        owner: null,
                        avatar_url: c.avatar_url,
                        is_suspended: false // Unassigned cards are not suspended
                    });
                });
            }

            // 2. Add Assigned Products (from staff)
            if (window.dashboardDataCache && window.dashboardDataCache.staff) {
                const staffMap = {};
                window.dashboardDataCache.staff.forEach(s => {
                    if (!staffMap[s.id]) staffMap[s.id] = [];
                    if (s.slug) staffMap[s.id].push(s);
                });

                Object.values(staffMap).forEach(cards => {
                    if (cards.length === 0) return;

                    // Identify Profile
                    const username = (cards[0].email || '').split('@')[0].toLowerCase();
                    cards.forEach(c => {
                        let score = 0;
                        const s = (c.slug || '').toLowerCase();
                        if (s === username) score = 10;
                        else if (s.includes(username)) score = 5;
                        c._score = score;
                    });
                    cards.sort((a, b) => b._score - a._score);

                    // Index 0 is Profile. Index 1+ are Products.
                    for (let i = 1; i < cards.length; i++) {
                        allProducts.push({
                            id: cards[i].card_id, // Now available!
                            slug: cards[i].slug,
                            full_name: cards[i].name,
                            created_at: null,
                            status: cards[i].card_suspended ? 'Suspended' : 'Active', // Use new field
                            owner: cards[i].name,
                            owner_avatar: cards[0].avatar_url,
                            avatar_url: cards[i].avatar_url,
                            is_suspended: cards[i].card_suspended
                        });
                    }
                });
            }

            allProducts.sort((a, b) => (a.slug || '').localeCompare(b.slug || ''));

            if (allProducts.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">No product cards found.</div>';
                return;
            }

            container.innerHTML = allProducts.map(p => `
                <div class="bg-[#111] rounded-xl shadow-md hover:shadow-xl transition-all group relative overflow-hidden flex flex-col hover:-translate-y-1 duration-300 ${p.status === 'Suspended' ? 'opacity-75 grayscale-[0.5]' : ''}">
                    <!-- Preview Image Area -->
                    <div class="h-40 w-full bg-[#222] flex items-center justify-center overflow-hidden relative">
                        ${p.avatar_url
                    ? `<img src="${p.avatar_url}" alt="${p.slug}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`
                    : `<div class="text-gray-600 flex flex-col items-center gap-2">
                                <i class="bi bi-qr-code text-3xl"></i>
                               </div>`
                }
                        
                        <!-- Status Badge Overlay -->
                        <div class="absolute top-3 right-3 z-10">
                             <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide shadow-sm backdrop-blur-md border border-white/10 ${p.status === 'Active' ? 'bg-black/50 text-green-400' : (p.status === 'Suspended' ? 'bg-black/50 text-red-500' : 'bg-black/50 text-orange-400')}">
                                <span class="w-1.5 h-1.5 rounded-full ${p.status === 'Active' ? 'bg-green-500' : (p.status === 'Suspended' ? 'bg-red-500' : 'bg-orange-500')}"></span>
                                ${p.status}
                            </span>
                        </div>
                    </div>

                    <div class="p-5 flex flex-col flex-1">
                        <h3 class="font-bold text-lg text-white mb-1 truncate">/${p.slug}</h3>
                        
                        <div class="mt-auto pt-4 border-t border-gray-800">
                            <div class="flex items-center justify-between mb-3">
                                 ${p.owner ? `
                                    <div class="flex items-center gap-2">
                                         <div class="w-6 h-6 rounded-full bg-gray-800 text-gray-400 flex items-center justify-center text-[10px] font-bold border border-gray-700 overflow-hidden">
                                            ${p.owner_avatar
                        ? `<img src="${p.owner_avatar}" class="w-full h-full object-cover">`
                        : p.owner.charAt(0)}
                                         </div>
                                         <span class="text-xs text-gray-400 font-medium truncate">${p.owner}</span>
                                    </div>
                                ` : `
                                    <p class="text-xs text-orange-500 font-bold uppercase tracking-wide">Needs Assignment</p>
                                `}

                                <button onclick="downloadCardQRCode('${p.slug}')" class="w-8 h-8 rounded-lg bg-[#222] text-gray-400 border border-gray-700 hover:bg-white hover:text-black hover:border-white transition-colors flex items-center justify-center" title="Download QR Code">
                                    <i class="bi bi-qr-code-scan"></i>
                                </button>
                            </div>
                            
                            <div class="flex gap-2">
                                <a href="/${p.slug}" target="_blank" class="flex-1 py-2 rounded-lg bg-[#222] text-gray-300 border border-gray-700 text-xs font-bold text-center hover:bg-white hover:text-black hover:border-white transition-all uppercase tracking-wide">
                                    View
                                </a>
                                <button onclick="openManageProductModal(${p.id}, '${p.slug}', ${p.is_suspended})" class="flex-1 py-2 rounded-lg bg-[#222] text-white text-xs font-bold hover:bg-gray-700 transition uppercase tracking-wide border border-gray-700">
                                    Manage
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderStaffGrid() {
            const container = document.getElementById('staff-grid-container');
            if (!container) return;

            const staff = window.availableStaff || [];

            if (staff.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">No staff members found.</div>';
                return;
            }

            container.innerHTML = staff.map(user => {
                const initial = (user.name || 'U').charAt(0);
                // Premium Card Design
                const avatar = user.avatar_url
                    ? `<img src="${user.avatar_url}" alt="${user.name}" class="w-full h-full rounded-full object-cover border-2 border-[#111]">`
                    : `<div class="w-full h-full rounded-full bg-[#222] text-white flex items-center justify-center font-bold text-2xl border-2 border-[#111]">${initial}</div>`;

                return `
                <div class="bg-[#111] rounded-2xl p-6 relative flex flex-col items-center shadow-xl border border-gray-800 group hover:-translate-y-1 transition-all duration-300">
                   <!-- Actions -->
                   <button class="absolute top-4 left-4 text-gray-700 hover:text-yellow-400 transition-colors"><i class="bi bi-star-fill"></i></button>
                   <!-- We need to be careful with escaping strings in onclick -->
                   <button onclick="openManageStaffModal(${user.id}, '${user.name ? user.name.replace(/'/g, "\\'") : ''}', '${user.email}', ${user.assigned_admin_id})" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"><i class="bi bi-three-dots-vertical"></i></button>
                   
                   <!-- Avatar -->
                   <div class="w-20 h-20 rounded-full p-1 bg-gradient-to-br from-blue-500 to-cyan-400 mb-4 mt-2 shadow-lg shadow-blue-500/20">
                       ${avatar}
                   </div>
                   
                   <!-- Ident -->
                   <h3 class="text-white font-bold text-lg mb-1">${user.name || 'Staff User'}</h3>
                   <p class="text-gray-500 text-xs uppercase tracking-widest font-bold mb-1">Staff Member</p>
                   <p class="text-zinc-600 text-[10px] uppercase tracking-wider font-bold mb-6">ID: ${user.employee_id || 'N/A'}</p>
                   
                   <!-- Action Button -->
                   <button onclick="console.log('Button Clicked'); window.viewStaffProfileFallback('${user.id}')" class="w-full py-2 rounded-lg bg-[#222] text-gray-300 text-xs font-bold uppercase tracking-wide hover:bg-white hover:text-black transition-colors text-center border border-gray-800 hover:border-white">
                        View Profile
                   </button>
                </div>
                `;
            }).join('');
        }


        // *** ADMIN DETAIL MODAL LOGIC ***
        let currentDetailAdminId = null;
        let detailViewMode = 'grid'; // 'grid' | 'list'
        let detailSortMode = 'name_asc'; // 'name_asc' | 'name_desc'

        function setDetailView(mode) {
            detailViewMode = mode;

            // Update Buttons
            const btnGrid = document.getElementById('btn-detail-grid');
            const btnList = document.getElementById('btn-detail-list');

            if (mode === 'grid') {
                btnGrid.classList.add('text-white');
                btnGrid.classList.remove('text-gray-500');
                btnList.classList.add('text-gray-500');
                btnList.classList.remove('text-white');
            } else {
                btnList.classList.add('text-white');
                btnList.classList.remove('text-gray-500');
                btnGrid.classList.add('text-gray-500');
                btnGrid.classList.remove('text-white');
            }

            renderDetailStaffGrid();
        }

        function toggleDetailFilter() {
            const dd = document.getElementById('detail-filter-dropdown');
            if (dd.classList.contains('hidden-element')) {
                dd.classList.remove('hidden-element');
            } else {
                dd.classList.add('hidden-element');
            }
        }

        function setDetailSort(mode) {
            detailSortMode = mode;
            document.getElementById('detail-filter-dropdown').classList.add('hidden-element');
            renderDetailStaffGrid();
        }

        function openAdminDetailModal(adminId) {
            currentDetailAdminId = adminId;
            // Reset Defaults
            detailViewMode = 'grid';
            detailSortMode = 'name_asc';
            setDetailView('grid'); // Reset visual button state

            const admin = window.availableAdmins.find(a => a.id === adminId);
            if (!admin) return;

            // Populate Header
            document.getElementById('detail-admin-name').innerText = admin.name || 'Admin';
            document.getElementById('detail-admin-email').innerText = admin.email;

            // Edit Button Handler
            const editBtn = document.getElementById('detail-admin-edit');
            if (editBtn) {
                editBtn.onclick = function () {
                    // Close this modal and open the manage modal
                    closeAdminDetailModal();
                    openManageAdminModal(admin.id, admin.email);
                };
            }
            document.getElementById('detail-last-login').innerText = admin.last_login || 'Never';

            document.getElementById('detail-admin-title').innerText = admin.job_title || 'N/A';
            document.getElementById('detail-admin-company').innerText = admin.company || 'N/A';
            document.getElementById('detail-admin-phone').innerText = admin.phone || 'N/A';
            document.getElementById('detail-admin-id').innerText = admin.employee_id || 'N/A';

            // Profile Slug Link
            const slug = admin.slug;
            const profileLink = document.getElementById('detail-profile-link');
            const profileSlugSpan = document.getElementById('detail-profile-slug');

            if (profileLink && profileSlugSpan) {
                if (slug) {
                    profileLink.href = `https://castlecrew.cc/${slug}`;
                    profileSlugSpan.innerText = slug;
                    profileLink.classList.remove('hidden-element');
                    profileLink.parentElement.classList.remove('hidden-element');
                } else {
                    profileLink.href = '#';
                    profileSlugSpan.innerText = 'N/A';
                    profileLink.classList.add('hidden-element');
                }
            }

            const avatarImg = document.getElementById('detail-admin-avatar');
            const initialDiv = document.getElementById('detail-admin-initial');

            if (admin.avatar_url) {
                avatarImg.src = admin.avatar_url;
                avatarImg.classList.remove('hidden');
                initialDiv.classList.add('hidden');
            } else {
                initialDiv.innerText = (admin.name || 'A').charAt(0);
                initialDiv.classList.remove('hidden');
                avatarImg.classList.add('hidden');
            }

            // Calculate Staff Count (Total, regardless of search)
            const allManagedStaff = (window.availableStaff || []).filter(u => u.assigned_admin_id === admin.id);
            document.getElementById('detail-staff-count').innerText = allManagedStaff.length;

            // Clear Search & Render
            const searchInput = document.getElementById('detail-staff-search');
            if (searchInput) searchInput.value = '';

            renderDetailStaffGrid();

            document.getElementById('admin-detail-modal').classList.remove('hidden-element');
        }

        function filterModalStaff() {
            renderDetailStaffGrid();
        }

        function renderDetailStaffGrid() {
            if (!currentDetailAdminId) return;

            const searchQuery = document.getElementById('detail-staff-search').value.toLowerCase();
            const container = document.getElementById('detail-staff-grid');
            const emptyState = document.getElementById('detail-empty-state');

            // Filter
            const filteredStaff = (window.availableStaff || []).filter(u => {
                if (u.assigned_admin_id !== currentDetailAdminId) return false;
                if (!searchQuery) return true;
                return (u.name || '').toLowerCase().includes(searchQuery) ||
                    (u.email || '').toLowerCase().includes(searchQuery) ||
                    (u.employee_id || '').toLowerCase().includes(searchQuery);
            });

            if (filteredStaff.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                // Update empty state text based on search
                emptyState.querySelector('p').innerText = searchQuery ? 'No matches found.' : 'No staff members assigned to this admin.';
            } else {
                container.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Sorting
                filteredStaff.sort((a, b) => {
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();

                    if (detailSortMode === 'name_asc') {
                        return nameA.localeCompare(nameB);
                    } else if (detailSortMode === 'name_desc') {
                        return nameB.localeCompare(nameA);
                    } else if (detailSortMode === 'date_desc') {
                        return b.id - a.id; // Newest first (assuming ID correlates with time)
                    } else if (detailSortMode === 'date_asc') {
                        return a.id - b.id; // Oldest first
                    }
                    return 0;
                });

                // View Mode Classes
                if (detailViewMode === 'grid') {
                    container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-4";
                } else {
                    container.className = "grid grid-cols-1 gap-3 pb-4";
                }

                container.innerHTML = filteredStaff.map(user => {
                    const initial = (user.name || 'U').charAt(0);
                    const avatar = user.avatar_url
                        ? `<img src="${user.avatar_url}" alt="${user.name}" class="w-full h-full rounded-full object-cover border border-[#333]">`
                        : `<div class="w-full h-full rounded-full bg-[#333] text-gray-400 flex items-center justify-center font-bold text-sm border border-[#333]">${initial}</div>`;

                    return `
                    <div class="bg-[#1a1a1a] rounded-xl p-4 border border-gray-800 hover:border-gray-600 transition flex items-center gap-4 group">
                        <div class="relative w-12 h-12 shrink-0">
                            ${avatar}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white font-bold text-sm truncate group-hover:text-brand-red transition-colors">${user.name}</h4>
                            <p class="text-gray-500 text-xs truncate">${user.email}</p>
                            <p class="text-[10px] text-gray-600 mt-0.5 uppercase tracking-wider font-bold">Staff Member</p>
                        </div>
                        <button onclick="openStaffDetailModal(${user.id})" class="w-8 h-8 rounded-lg hover:bg-[#333] text-gray-600 hover:text-white flex items-center justify-center transition-colors">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    `;
                }).join('');
            }
        }

        function closeAdminDetailModal() {
            document.getElementById('admin-detail-modal').classList.add('hidden-element');
        }

        // *** MESSAGING LOGIC ***
        let messagingInterval = null;

        async function loadMessages() {
            const historyContainer = document.getElementById('support-messaging-history');
            if (!historyContainer) return;

            try {
                const res = await fetch('/api/enterprise/messages');
                if (!res.ok) throw new Error("Failed to fetch messages");
                const messages = await res.json();

                // Clear and render
                if (messages.length === 0) {
                    historyContainer.innerHTML = `
                         <div class="flex items-center justify-center h-full">
                            <div class="flex flex-col items-center gap-2 opacity-50">
                                <i class="bi bi-chat-left-text text-4xl text-gray-300"></i>
                                <p class="text-xs font-bold uppercase tracking-widest text-gray-400">No messages yet</p>
                                <p class="text-[10px] text-gray-400 max-w-[200px] text-center">Start a conversation with the Castle Crew System Admin below.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                historyContainer.innerHTML = '';

                // Group by date
                let lastDate = null;

                messages.forEach(msg => {
                    const msgDate = new Date(msg.created_at).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
                    if (msgDate !== lastDate) {
                        historyContainer.innerHTML += `
                            <div class="flex justify-center my-4">
                                <span class="bg-white border border-gray-100 text-gray-400 text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-[0.2em] shadow-sm">${msgDate}</span>
                            </div>
                        `;
                        lastDate = msgDate;
                    }

                    const isSystem = msg.sender_role === 'system_admin';
                    const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    if (isSystem) {
                        historyContainer.innerHTML += `
                            <div class="flex gap-4 max-w-[85%] animate-fade-in">
                                <div class="w-8 h-8 rounded-xl bg-brand-red flex-shrink-0 flex items-center justify-center text-white text-sm shadow-lg shadow-brand-red/20">
                                    <i class="bi bi-shield-lock"></i>
                                </div>
                                <div class="space-y-1.5">
                                    <div class="bg-white border border-gray-100 p-4 rounded-2xl rounded-tl-none shadow-sm">
                                        <p class="text-gray-900 text-sm leading-relaxed">${msg.message}</p>
                                    </div>
                                    <p class="text-[9px] text-gray-400 font-black uppercase tracking-widest ml-1">HQ Systems • ${time}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        historyContainer.innerHTML += `
                            <div class="flex gap-4 max-w-[85%] ml-auto flex-row-reverse animate-fade-in">
                                <div class="w-8 h-8 rounded-xl bg-brand-black flex-shrink-0 flex items-center justify-center text-white text-sm shadow-lg shadow-black/20">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                <div class="space-y-1.5 text-right">
                                    <div class="bg-brand-black text-white p-4 rounded-2xl rounded-tr-none shadow-xl">
                                        <p class="text-sm leading-relaxed">${msg.message}</p>
                                    </div>
                                    <p class="text-[9px] text-gray-400 font-black uppercase tracking-widest mr-1">Organization Admin • ${time}</p>
                                </div>
                            </div>
                        `;
                    }
                });

                // Scroll to bottom
                historyContainer.scrollTop = historyContainer.scrollHeight;

            } catch (e) {
                console.error("Messaging Error:", e);
                historyContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="flex flex-col items-center gap-3 text-red-500">
                            <i class="bi bi-exclamation-triangle text-3xl"></i>
                            <p class="text-xs font-bold uppercase tracking-widest">Connection Error</p>
                            <p class="text-[10px] text-gray-400 max-w-[200px] text-center">${e.message || 'Failed to sync with secure server'}</p>
                            <button onclick="loadMessages()" class="mt-2 px-4 py-2 bg-gray-900 text-white text-[10px] font-bold rounded-lg uppercase tracking-widest hover:bg-gray-800 transition">Retry Connection</button>
                        </div>
                    </div>
                `;
            }
        }

        async function handleSendMessage() {
            const input = document.getElementById('support-chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Get original state
            const originalVal = input.value;
            input.value = '';
            input.disabled = true;

            try {
                const res = await fetch('/api/enterprise/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (res.ok) {
                    await loadMessages();
                } else {
                    input.value = originalVal;
                    alert("Delivery failure. Please try again.");
                }
            } catch (e) {
                console.error("Send Message Error:", e);
                input.value = originalVal;
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // Auto-refresh messages when in messaging view
        setInterval(() => {
            if (!document.getElementById('messaging-view').classList.contains('hidden')) {
                loadMessages();
            }
        }, 10000); // Every 10 seconds

        // *** REQUEST MODAL LOGIC ***
        function openRequestModal() {
            document.getElementById('request-modal').classList.remove('hidden-element');
        }

        async function submitLicenseRequest() {
            const btn = document.getElementById('btn-submit-request');
            const type = document.querySelector('input[name="req-type"]:checked').value;
            const amount = document.getElementById('req-amount').value;
            const message = document.getElementById('req-message').value.trim();

            if (!amount || amount < 1) {
                alert("Please specify a valid quantity.");
                return;
            }

            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> Transmitting...';

            try {
                const res = await fetch('/api/enterprise/submit-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        request_type: type,
                        amount: parseInt(amount),
                        message: message
                    })
                });

                const data = await res.json();

                if (data.success) {
                    btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Transmitted Successfully';
                    btn.classList.replace('bg-blue-600', 'bg-green-600');

                    setTimeout(() => {
                        document.getElementById('request-modal').classList.add('hidden-element');
                        // Reset button
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.classList.replace('bg-green-600', 'bg-blue-600');
                        // Clear fields
                        document.getElementById('req-amount').value = '5';
                        document.getElementById('req-message').value = '';
                    }, 2000);
                } else {
                    throw new Error(data.error || "Failed to transmit request");
                }
            } catch (e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function loadRequestsHistory() {
            const listEl = document.getElementById('requests-history-list');
            if (!listEl) return;

            try {
                const res = await fetch('/api/enterprise/requests');
                const requests = await res.json();

                if (requests.length === 0) {
                    listEl.innerHTML = `
                            <tr>
                                <td colspan="5" class="p-20 text-center">
                                    <div class="flex flex-col items-center gap-4 opacity-30">
                                        <i class="bi bi-inbox text-5xl"></i>
                                        <p class="text-[10px] font-black uppercase tracking-widest">No request records found</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    return;
                }

                listEl.innerHTML = requests.map(req => {
                    let statusColor = 'bg-gray-100 text-gray-400';
                    if (req.status === 'pending') statusColor = 'bg-blue-50 text-blue-600 animate-pulse';
                    else if (req.status === 'approved') statusColor = 'bg-green-50 text-green-600';
                    else if (req.status === 'rejected') statusColor = 'bg-red-50 text-red-600';

                    const date = new Date(req.created_at).toLocaleDateString([], {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                            <tr class="hover:bg-gray-50/50 transition duration-200">
                                <td class="p-6 pl-10">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-lg text-gray-400 border border-gray-100">
                                            <i class="bi bi-hash"></i>
                                        </div>
                                        <div>
                                            <p class="text-[11px] font-black text-gray-900 uppercase tracking-tight">REQ-${String(req.id).padStart(5, '0')}</p>
                                            <p class="text-[10px] text-gray-400 font-medium mt-0.5">${req.message || 'No description provided'}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="p-6">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full ${req.request_type === 'profile' ? 'bg-orange-500' : 'bg-purple-600'}"></div>
                                        <span class="text-[10px] font-black text-gray-700 uppercase tracking-widest">${req.request_type} License</span>
                                    </div>
                                </td>
                                <td class="p-6 text-center">
                                    <span class="text-sm font-black text-gray-900">${req.amount}</span>
                                </td>
                                <td class="p-6">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-tight">${date}</span>
                                </td>
                                <td class="p-6 text-center">
                                    <span class="inline-flex px-4 py-1 rounded-full text-[9px] font-black uppercase tracking-[0.1em] border border-current/10 ${statusColor}">
                                        ${req.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                }).join('');

            } catch (e) {
                console.error("Failed to load requests:", e);
                listEl.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-red-500 text-xs font-bold">Sync Error: Failed to retrieve data from registry</td></tr>`;
            }
        }

        // *** AUTHENTICATOR LOGIC ***
        let authTimer = null;
        let authData = [];

        function openAddAuthAccountModal() {
            document.getElementById('add-auth-account-modal').classList.remove('hidden-element');
            document.getElementById('auth-new-name').value = '';
            document.getElementById('auth-new-account').value = '';
            document.getElementById('auth-new-secret').value = '';
        }

        function saveAuthAccount() {
            const name = document.getElementById('auth-new-name').value;
            const account = document.getElementById('auth-new-account').value;
            let secret = document.getElementById('auth-new-secret').value;

            if (!name || !secret) {
                alert("Name and Secret are required.");
                return;
            }

            // Aggressive Cleaning: Remove spaces, dashes, and make uppercase
            secret = secret.replace(/[\s\-]/g, '').toUpperCase();

            try {
                // Validate Secret
                const totp = new OTPAuth.TOTP({ secret: secret });
                totp.generate();
            } catch (e) {
                console.error("Secret Validation Error:", e);
                alert("Invalid Secret Key format.\n\nPlease ensure you are pasting the 'Secret Key' provided by the app (e.g. JBSW...). Dashes are now auto-removed.");
                return;
            }

            const newAccount = {
                id: Date.now(),
                name,
                account,
                secret
            };

            authData.push(newAccount);
            localStorage.setItem('enterprise_auth_vault', JSON.stringify(authData));

            document.getElementById('add-auth-account-modal').classList.add('hidden-element');
            renderAuthCodes();
        }

        function deleteAuthAccount(id) {
            if (confirm("Remove this account from vault?")) {
                authData = authData.filter(a => a.id !== id);
                localStorage.setItem('enterprise_auth_vault', JSON.stringify(authData));
                renderAuthCodes();
            }
        }

        function loadAuthenticatorData() {
            try {
                const stored = localStorage.getItem('enterprise_auth_vault');
                if (stored) {
                    authData = JSON.parse(stored);
                }
            } catch (e) { console.error(e); }
            renderAuthCodes();
        }

        function renderAuthCodes() {
            const grid = document.getElementById('auth-codes-grid');
            const emptyState = document.getElementById('auth-empty-state');

            if (authData.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = authData.map(item => {
                let code = 'ERROR';
                try {
                    const totp = new OTPAuth.TOTP({
                        issuer: item.name,
                        label: item.account,
                        algorithm: 'SHA1',
                        digits: 6,
                        period: 30,
                        secret: item.secret
                    });
                    code = totp.generate();
                } catch (e) { }

                return `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative group overflow-hidden">
                    <button onclick="deleteAuthAccount(${item.id})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition"><i class="bi bi-trash"></i></button>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gray-50 flex items-center justify-center text-xl font-bold text-gray-700 uppercase">
                            ${item.name.charAt(0)}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900 text-lg leading-tight mb-0.5">${item.name}</h3>
                            <p class="text-xs text-gray-400 font-medium truncate max-w-[150px]">${item.account}</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 flex items-center justify-between mb-4 relative overflow-hidden">
                        <span class="text-3xl font-mono font-black text-gray-800 tracking-[0.2em] relative z-10" id="code-${item.id}">${code}</span>
                        <button onclick="navigator.clipboard.writeText('${code}')" class="text-gray-400 hover:text-indigo-600 transition relative z-10"><i class="bi bi-copy"></i></button>
                        
                        <!-- Progress Bar Background -->
                        <div class="absolute bottom-0 left-0 h-1 bg-indigo-500 transition-all duration-1000 ease-linear" id="progress-${item.id}" style="width: 100%"></div>
                    </div>

                    <div class="flex items-center gap-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">
                         <i class="bi bi-clock"></i> <span id="timer-${item.id}">30s</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function startAuthInterval() {
            if (authTimer) clearInterval(authTimer);
            renderAuthCodes(); // Initial render

            authTimer = setInterval(() => {
                const epoch = Math.round(new Date().getTime() / 1000.0);
                const countDown = 30 - (epoch % 30);
                const percentage = (countDown / 30) * 100;

                authData.forEach(item => {
                    const timerEl = document.getElementById(`timer-${item.id}`);
                    if (timerEl) timerEl.innerText = countDown + 's';

                    const progEl = document.getElementById(`progress-${item.id}`);
                    if (progEl) {
                        progEl.style.width = percentage + '%';
                        if (countDown < 5) progEl.classList.replace('bg-indigo-500', 'bg-red-500');
                        else progEl.classList.replace('bg-red-500', 'bg-indigo-500');
                    }

                    if (countDown === 30 || countDown === 29) {
                        try {
                            const totp = new OTPAuth.TOTP({
                                secret: item.secret, algorithm: 'SHA1', digits: 6, period: 30
                            });
                            const codeEl = document.getElementById(`code-${item.id}`);
                            if (codeEl) codeEl.innerText = totp.generate();
                        } catch (e) { }
                    }
                });
            }, 1000);
        }

        // Wrap switchView to handle authenticator view
        const _origSwitchView = window.switchView;
        window.switchView = function (viewId) {
            const authView = document.getElementById('authenticator-view');
            const navAuth = document.getElementById('nav-authenticator');

            if (viewId === 'authenticator') {
                // Hide all main views manually to be safe
                ['dashboard-view', 'admins-view', 'staff-view', 'products-view', 'messaging-view', 'qr-generator-view', 'requests-history-view'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });

                // Reset Nav styling manually
                document.querySelectorAll('nav a, nav button').forEach(el => el.classList.remove('bg-brand-black', 'text-white'));

                authView.classList.remove('hidden');
                if (navAuth) navAuth.classList.add('bg-brand-black', 'text-white');

                loadAuthenticatorData();
                startAuthInterval();
            } else {
                if (authView) authView.classList.add('hidden');
                if (navAuth) navAuth.classList.remove('bg-brand-black', 'text-white');
                if (authTimer) clearInterval(authTimer);

                // Chain original
                if (typeof _origSwitchView === 'function') _origSwitchView(viewId);
            }
        };

        // *** NOTIFICATION LOGIC ***
        async function checkNotificationsGlobal() {
            try {
                const res = await fetch('/api/enterprise/messages');
                if (!res.ok) return;
                const messages = await res.json();

                // Filter for System Admin messages
                const systemMsgs = messages.filter(m => m.sender_role === 'system_admin');
                if (systemMsgs.length === 0) return;

                const latestMsg = systemMsgs[systemMsgs.length - 1];
                const latestTime = new Date(latestMsg.created_at).getTime();
                const lastRead = localStorage.getItem('last_read_msg_time') || 0;

                const badge = document.getElementById('notification-badge');
                if (latestTime > lastRead) {
                    if (badge) badge.classList.remove('hidden-element');
                } else {
                    if (badge) badge.classList.add('hidden-element');
                }
            } catch (e) {
                console.warn("Notification poll failed", e);
            }
        }

        // Poll every 15 seconds
        setInterval(checkNotificationsGlobal, 15000);
        // Initial check
        setTimeout(checkNotificationsGlobal, 2000);

        // Update switchView to handle marking read
        const _prevSwitchViewForAuth = window.switchView;
        window.switchView = function (viewId) {
            // Chain previous wrapper (Auth)
            if (typeof _prevSwitchViewForAuth === 'function') _prevSwitchViewForAuth(viewId);

            // Notification Msg Logic
            if (viewId === 'messaging') {
                const badge = document.getElementById('notification-badge');
                if (badge) badge.classList.add('hidden-element');
                // We update the timestamp to stored time + small buffer or just Date.now()
                // Ideally we set it to the latest message time found, but Date.now() covers "seen everything up to now"
                localStorage.setItem('last_read_msg_time', Date.now());
            }
        };
        // *** ANALYTICS LOGIC ***
        let trafficChart = null;
        let deviceChart = null;
        let mapInstance = null;

        function initAnalytics() {
            if (trafficChart) return; // Prevent double init

            const ctx1 = document.getElementById('trafficChart').getContext('2d');
            const ctx2 = document.getElementById('deviceChart').getContext('2d');

            // Gradient for Line Chart
            const gradient = ctx1.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(240, 0, 0, 0.2)');
            gradient.addColorStop(1, 'rgba(240, 0, 0, 0)');

            // Traffic Chart
            trafficChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Total Scans',
                            data: [],
                            borderColor: '#f00000', // Brand Red
                            backgroundColor: gradient, // Original Gradient
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#f00000',
                            pointRadius: 4,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Profile Visits',
                            data: [],
                            borderColor: '#F59E0B', // Amber/Gold
                            backgroundColor: 'rgba(245, 158, 11, 0.05)',
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#F59E0B',
                            pointRadius: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Product Visits',
                            data: [],
                            borderColor: '#3B82F6', // Blue
                            backgroundColor: 'rgba(59, 130, 246, 0.05)',
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#3B82F6',
                            pointRadius: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', align: 'end' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Device Chart
            deviceChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Mobile', 'Desktop', 'Tablet'],
                    datasets: [{
                        data: [85, 10, 5],
                        backgroundColor: ['#111', '#f00000', '#eee'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                    },
                    cutout: '75%'
                }
            });

            // Init Map (Wrapped in timeout to ensure DOM is ready)
            setTimeout(() => {
                try {
                    mapInstance = new jsVectorMap({
                        selector: '#world-map-markers',
                        map: 'world',
                        zoomButtons: true,
                        domain: 'castlecrew.cc',
                        visualizeData: {
                            scale: ['#eeeeee', '#f00000'],
                            values: { US: 29, GB: 10, CA: 5, AU: 3 }
                        },
                        regionStyle: {
                            initial: { fill: '#f3f4f6', stroke: "none", "stroke-width": 0, "stroke-opacity": 0 },
                            hover: { fill: '#e5e7eb', cursor: 'default' },
                            selected: { fill: '#111827' }
                        },
                        markers: [
                            { name: "New York", coords: [40.7128, -74.0060] },
                            { name: "London", coords: [51.5074, -0.1278] },
                            { name: "Sydney", coords: [-33.8688, 151.2093] },
                            { name: "Tokyo", coords: [35.6762, 139.6503] }
                        ],
                        markerStyle: {
                            initial: { fill: '#f00000', stroke: '#fff', "stroke-width": 2, r: 6 },
                            hover: { fill: '#111', stroke: '#fff', "stroke-width": 2, cursor: 'pointer', r: 8 }
                        }
                    });
                } catch (e) { console.warn("Map Init Failed", e); }
            }, 500);
        }

        function resetMap() {
            if (mapInstance) mapInstance.reset();
        }

        let currentAnalyticsRange = '30d';

        function setAnalyticsRange(range) {
            currentAnalyticsRange = range;

            // Update UI
            document.querySelectorAll('.analy-range-btn').forEach(btn => {
                btn.classList.remove('bg-black', 'text-white', 'shadow-sm');
                btn.classList.add('text-gray-500', 'hover:bg-gray-50');
            });
            const activeBtn = document.getElementById(`btn-range-${range}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-50');
                activeBtn.classList.add('bg-black', 'text-white', 'shadow-sm');
            }

            // Refresh Data
            renderAnalytics();
        }

        async function fetchAnalyticsData() {
            try {
                // Try to fetch real analytics data from the backend
                const res = await fetch(`/api/enterprise/analytics?range=${currentAnalyticsRange}`);
                if (!res.ok) throw new Error("Analytics API not found");
                const data = await res.json();
                return data;
            } catch (e) {
                console.warn("Using simulation/cached data. API Error:", e);
                return null;
            }
        }

        async function renderAnalytics() {
            // Fetch Data
            const apiData = await fetchAnalyticsData();

            // --- 1. OVERVIEW CARDS ---
            // Use API data or Fallback
            const cache = window.dashboardDataCache && window.dashboardDataCache.stats ? window.dashboardDataCache.stats : null;

            // New Logic: API returns profile_visits and product_visits directly
            // Fallback: If no API, assume all cached views are Profile visits (simplest heuristic for now)
            const profileVisits = apiData?.overview?.profile_visits ?? (cache?.total_views ?? 0);
            const productVisits = apiData?.overview?.product_visits ?? 0;

            const actions = apiData?.overview?.total_actions ?? (cache?.total_leads ?? 0);
            const engagement = apiData?.overview?.engagement_time ?? '0m 0s';

            if (document.getElementById('analy-profile-visits')) document.getElementById('analy-profile-visits').innerText = profileVisits.toLocaleString();
            if (document.getElementById('analy-product-visits')) document.getElementById('analy-product-visits').innerText = productVisits.toLocaleString();
            if (document.getElementById('analy-actions')) document.getElementById('analy-actions').innerText = actions.toLocaleString();
            if (document.getElementById('analy-engagement')) document.getElementById('analy-engagement').innerText = engagement;

            // --- RENDER TRENDS ---
            const renderTrend = (id, value) => {
                const el = document.getElementById(id);
                if (!el) return;

                const val = parseFloat(value || 0);
                const isPositive = val > 0;
                const isNegative = val < 0;
                const absVal = Math.abs(val).toFixed(1);

                if (isPositive) {
                    el.className = "text-green-500 text-xs font-bold flex items-center gap-1";
                    el.innerHTML = `+${absVal}% <i class="bi bi-arrow-up-short"></i>`;
                } else if (isNegative) {
                    el.className = "text-red-500 text-xs font-bold flex items-center gap-1";
                    el.innerHTML = `-${absVal}% <i class="bi bi-arrow-down-short"></i>`;
                } else {
                    el.className = "text-gray-400 text-xs font-bold flex items-center gap-1";
                    el.innerHTML = `0% <i class="bi bi-dash"></i>`;
                }
            };

            renderTrend('analy-profile-trend', apiData?.overview?.profile_trend);
            renderTrend('analy-product-trend', apiData?.overview?.product_trend);
            renderTrend('analy-actions-trend', apiData?.overview?.actions_trend);
            renderTrend('analy-engagement-trend', apiData?.overview?.engagement_trend);


            // --- 2. UPDATE CHARTS ---
            if (trafficChart) {
                // If API has chart data, use it. Else continue using the initial simulation (or update simulation base on total)
                if (apiData?.traffic_chart) {
                    trafficChart.data.labels = apiData.traffic_chart.labels;
                    // Update dataset 0 (Total), 1 (Profile), 2 (Product)
                    if (apiData.traffic_chart.total_data) trafficChart.data.datasets[0].data = apiData.traffic_chart.total_data;
                    if (apiData.traffic_chart.profile_data) trafficChart.data.datasets[1].data = apiData.traffic_chart.profile_data;
                    if (apiData.traffic_chart.product_data) trafficChart.data.datasets[2].data = apiData.traffic_chart.product_data;
                    trafficChart.update();
                }
            }

            if (deviceChart) {
                if (apiData?.device_chart) {
                    deviceChart.data.datasets[0].data = apiData.device_chart.datasets[0].data;
                    deviceChart.update();
                }
            }

            // --- 2.5 POPULATE TOP DEVICE MODELS ---
            const deviceList = document.getElementById('device-models-list');
            if (deviceList && apiData?.top_devices) {
                deviceList.innerHTML = '';

                if (apiData.top_devices.length === 0) {
                    deviceList.innerHTML = '<div class="text-center text-xs text-gray-400 py-4">No model data yet</div>';
                } else {
                    apiData.top_devices.forEach(d => {
                        const html = `
                             <div class="flex items-center gap-3 py-2 border-b border-gray-50 last:border-0">
                                <span class="w-6 h-6 rounded-lg bg-gray-50 text-gray-400 flex items-center justify-center text-xs">
                                    <i class="bi bi-phone"></i>
                                </span>
                                <span class="font-bold text-gray-700 text-xs">${d.device_model || 'Unknown'}</span>
                             </div>
                        `;
                        deviceList.innerHTML += html;
                    });
                }
            }

            // --- 3. MAP & LOCATION LIST ---
            if (apiData?.locations) {
                // Update Map Markers
                const markers = apiData.locations.markers.map(m => ({
                    name: m.city,
                    coords: [m.latitude, m.longitude]
                }));

                // Update Map Region Colors (by Country Code)
                const countryValues = {};
                apiData.locations.countries.forEach(c => {
                    // Start simplified: assign a generic high-intensity color or scale based on counts
                    // Since vectorMap uses a scale, we pass the raw value
                    if (c.country && c.country !== 'Unknown') {
                        countryValues[c.country] = c.count;
                    }
                });

                if (mapInstance) {
                    // Unfortunately, jsVectorMap doesn't easily support full dynamic updates of all props 
                    // without destroy/re-init in some versions, but we can try updating params.
                    // For stability, we might just update markers if the lib supports it, 
                    // or re-create the map if needed. 
                    // Let's try re-creating it cleanly to be safe and ensure data reflects instantly.

                    document.getElementById('world-map-markers').innerHTML = ''; // Clear container
                    mapInstance = new jsVectorMap({
                        selector: '#world-map-markers',
                        map: 'world',
                        zoomButtons: true,
                        domain: 'castlecrew.cc',
                        visualizeData: {
                            scale: ['#eeeeee', '#f00000'],
                            values: countryValues
                        },
                        regionStyle: {
                            initial: { fill: '#f3f4f6', stroke: "none", "stroke-width": 0, "stroke-opacity": 0 },
                            hover: { fill: '#e5e7eb', cursor: 'default' },
                            selected: { fill: '#111827' }
                        },
                        markers: markers,
                        markerStyle: {
                            initial: { fill: '#f00000', stroke: '#fff', "stroke-width": 2, r: 4 },
                            hover: { fill: '#111', stroke: '#fff', "stroke-width": 2, cursor: 'pointer', r: 6 }
                        }
                    });
                }

                // Update Location List
                const listContainer = document.getElementById('location-stats-grid');
                if (listContainer) {
                    listContainer.innerHTML = '';

                    // Helper for Flags
                    const getFlagEmoji = (countryCode) => {
                        const codePoints = countryCode
                            .toUpperCase()
                            .split('')
                            .map(char => 127397 + char.charCodeAt());
                        return String.fromCodePoint(...codePoints);
                    };

                    const maxCount = Math.max(...apiData.locations.countries.map(c => c.count), 1); // Avoid div/0

                    apiData.locations.countries.forEach(c => {
                        const percent = Math.round((c.count / maxCount) * 100);
                        const flag = (c.country && c.country !== 'Unknown') ? getFlagEmoji(c.country) : '🌍';
                        const name = c.country || 'Unknown';

                        // Color cycling for bars
                        const colors = ['bg-blue-500', 'bg-purple-500', 'bg-orange-500', 'bg-green-500'];
                        const colorClass = colors[Math.floor(Math.random() * colors.length)];

                        const itemHTML = `
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${flag}</span>
                                    <div>
                                        <p class="font-bold text-gray-900 text-sm">${name}</p>
                                        <p class="text-xs text-gray-500">${c.count} Scans</p>
                                    </div>
                                </div>
                                <div class="w-24 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full ${colorClass}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += itemHTML;
                    });
                }
            }

            if (deviceChart) {
                if (apiData?.device_chart) {
                    deviceChart.data = apiData.device_chart; // Assign full data object
                    deviceChart.update();
                }
            }

            // --- 3. TOP PRODUCTS LIST ---
            const list = document.getElementById('top-cards-list');
            let productData = apiData?.top_products;

            // Fallback: Use window.availableProducts
            if (!productData && window.availableProducts && window.availableProducts.length > 0) {
                productData = [...window.availableProducts].slice(0, 10).map(c => ({
                    full_name: c.full_name,
                    slug: c.slug,
                    scans: Math.floor(Math.random() * 500), // Sim
                    scan_percentage: 10 // Sim
                }));
            }

            if (productData && productData.length > 0) {
                list.innerHTML = productData.map((c, i) => `
                    <div class="flex items-center gap-4 p-3 hover:bg-gray-50 rounded-xl transition cursor-pointer mb-1">
                        <div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-500 font-bold flex items-center justify-center text-xs">
                            ${i + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-gray-900 text-sm truncate">${c.full_name || 'Product Card'}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">/${c.slug}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-gray-900 text-xs">${c.scans?.toLocaleString() || 0}</p>
                             <p class="text-[9px] text-green-500 font-bold">Scans</p>
                        </div>
                    </div>
                 `).join('');
            } else {
                list.innerHTML = '<p class="p-4 text-center text-gray-400 text-xs">No product data available.</p>';
            }

            // --- 4. TOP PROFILES LIST ---
            const profileList = document.getElementById('top-profiles-list');
            let staffData = apiData?.top_staff;

            // Fallback: Use window.availableStaff
            // CORRECTED PROPERTY NAMES
            if (!staffData && window.availableStaff && window.availableStaff.length > 0) {
                staffData = [...window.availableStaff].slice(0, 5).map(p => ({
                    name: p.name || 'Staff User',
                    email: p.email,
                    avatar_url: p.avatar_url,
                    job_title: 'Team Member',
                    score: Math.floor(Math.random() * 1000) // Sim
                }));
            }

            if (staffData && staffData.length > 0) {
                profileList.innerHTML = staffData.map((p, i) => `
                    <div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg transition cursor-pointer mb-1">
                        <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden">
                             ${p.avatar_url ? `<img src="${p.avatar_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-500 text-[10px] font-bold">${(p.name || 'U').charAt(0)}</div>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-gray-900 text-xs truncate">${p.name}</p>
                            <p class="text-[9px] text-gray-400 truncate">${p.job_title || p.email}</p>
                        </div>
                        <div class="text-right">
                             <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded">${p.score || 0}</span>
                        </div>
                    </div>
                 `).join('');
            } else {
                profileList.innerHTML = '<p class="p-4 text-center text-gray-400 text-xs">No staff data available.</p>';
            }
        }

        // Update switchView to handle Analytics
        const _prevSwitchViewForAnalytics = window.switchView;
        window.switchView = function (viewId) {
            const analyView = document.getElementById('analytics-view');
            const navAnaly = document.getElementById('nav-analytics');
            const navs = ['nav-dashboard', 'nav-admins', 'nav-staff', 'nav-products', 'nav-requests-history', 'nav-messaging', 'nav-qr-generator', 'nav-authenticator'];

            // Chain
            if (typeof _prevSwitchViewForAnalytics === 'function') _prevSwitchViewForAnalytics(viewId);

            // Handle specific Analysis case
            if (viewId === 'analytics') {
                // Hide all main containers manually again to be safe
                ['dashboard-view', 'admins-view', 'staff-view', 'products-view', 'messaging-view', 'qr-generator-view', 'requests-history-view', 'authenticator-view'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });

                analyView.classList.remove('hidden');

                // Clear other navs
                navs.forEach(n => {
                    const el = document.getElementById(n);
                    if (el) el.classList.remove('bg-brand-black', 'text-white');
                });
                if (navAnaly) navAnaly.classList.add('bg-brand-black', 'text-white');

                // Init Chart if first time
                initAnalytics();
                renderAnalytics();

                // Resize Map Fix
                setTimeout(() => {
                    if (mapInstance) mapInstance.updateSize();
                }, 300);

            } else {
                if (analyView) analyView.classList.add('hidden');
                if (navAnaly) navAnaly.classList.remove('bg-brand-black', 'text-white');

                // FIX: Ensure the target view is actually visible.
                // Our Analytics wrapper might have added 'hidden' (Tailwind) to a view that uses 'hidden-element' (Custom).
                // We must clean that up.
                const targetId = viewId.endsWith('-view') ? viewId : viewId + '-view';
                const targetEl = document.getElementById(targetId);
                if (targetEl) targetEl.classList.remove('hidden');
            }
        };

        window.viewStaffProfileFallback = function (staffId) {
            console.log("Fallback view profile called for ID:", staffId);
            // Call the main function if it exists, or reimplement logic
            if (typeof openStaffDetailModal === 'function') {
                openStaffDetailModal(staffId);
            } else {
                alert("Error: Core logic not loaded. ID: " + staffId);
            }
        };
    </script>
    <!-- Add Authenticator Account Modal -->
    <div id="add-auth-account-modal"
        class="fixed inset-0 bg-black/80 hidden-element flex items-center justify-center z-[1000] backdrop-blur-sm px-4">
        <div
            class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl relative overflow-hidden border border-gray-100">
            <!-- Header -->
            <div class="mb-6">
                <div
                    class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl mb-4 shadow-sm">
                    <i class="bi bi-shield-plus"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-900 leading-tight">Connect Application</h2>
                <p class="text-sm text-gray-500 font-medium">Add a new 2FA account to your vault.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Service
                        Name</label>
                    <input type="text" id="auth-new-name" placeholder="e.g. Facebook, AWS Root"
                        class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-3 text-sm font-bold text-gray-900 focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Account /
                        Email</label>
                    <input type="text" id="auth-new-account" placeholder="admin@enterprise.com"
                        class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-3 text-sm font-bold text-gray-900 focus:outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-gray-400 tracking-[0.1em] mb-2">Secret
                        Key</label>
                    <input type="text" id="auth-new-secret" placeholder="Base32 Key (e.g. JBSWY3DPEHPK3PXP)"
                        class="w-full bg-gray-50 border border-gray-200 rounded-2xl px-5 py-3 text-sm font-bold text-gray-900 focus:outline-none focus:border-indigo-500 font-mono">
                </div>

                <button onclick="saveAuthAccount()"
                    class="w-full bg-indigo-600 text-white font-black py-4 rounded-[1.25rem] shadow-xl shadow-indigo-600/20 hover:bg-indigo-700 transition-all text-sm uppercase tracking-widest mt-2">
                    Save Account
                </button>
            </div>

            <button onclick="document.getElementById('add-auth-account-modal').classList.add('hidden-element')"
                class="absolute top-6 right-6 w-10 h-10 bg-gray-50 text-gray-400 hover:text-gray-900 rounded-xl flex items-center justify-center transition-all">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>
</body>

</html>