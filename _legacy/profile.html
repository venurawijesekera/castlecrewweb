<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Castle Cards</title>
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- QR & PDF Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brand: { red: '#f00000', black: '#0a0a0a', dark: '#121212', sidebar: '#0f0f0f' } }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: white;
        }

        /* Preloader Styles (NEW) */
        #preloader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Glow animation for preloader logo (NEW) */
        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.5;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite ease-in-out;
        }

        .hidden-element {
            display: none !important;
        }
    </style>
</head>

<body class="flex flex-col md:flex-row min-h-screen md:h-screen md:overflow-hidden bg-brand-sidebar">

    <div id="preloader"
        class="fixed inset-0 z-[9999] bg-[#050505] flex items-center justify-center transition-opacity duration-700 ease-out">
        <div class="flex flex-col items-center gap-6">
            <div class="relative w-16 h-16 flex items-center justify-center">
                <div class="absolute inset-0 bg-brand-red opacity-50 blur-xl rounded-full animate-pulse-glow"></div>
                <img src="assets/img/logo.png" alt="Castle Cards Logo" class="relative w-12 h-12 z-10" />
            </div>
            <div class="font-black text-xl tracking-[0.2em] text-white animate-pulse">
                MY PROFILE
            </div>
        </div>
    </div>

    <aside class="w-64 bg-brand-sidebar border-r border-gray-900 hidden md:flex flex-col justify-between p-6 z-20">
        <div>
            <div class="flex items-center gap-2 mb-10 text-xl font-bold tracking-tight">
                <div class="w-3 h-3 bg-brand-red rotate-45"></div> CASTLE CREW
            </div>
            <nav class="space-y-2">
                <a href="index.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-house-door-fill"></i> Home Page
                </a>

                <!-- Admin Panel Link (Hidden by default) -->
                <a href="enterprise_super_admin_dashboard.html" id="admin-panel-link"
                    class="hidden items-center gap-3 px-4 py-3 bg-brand-red/10 text-brand-red rounded-lg text-sm font-bold animate-pulse">
                    <i class="bi bi-shield-lock-fill"></i> Admin Panel
                </a>

                <a href="profile.html" id="nav-link-profile"
                    class="flex items-center gap-3 px-4 py-3 bg-brand-red/10 text-brand-red rounded-lg text-sm font-bold">
                    <i class="bi bi-person-circle"></i> Profile
                </a>

                <!-- Products Link -->
                <a href="profile.html?view=products" id="nav-link-products"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-box-seam-fill"></i> Products
                </a>

                <a href="product_leads.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-inboxes-fill"></i> Product Leads
                </a>

                <a href="leads.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-people-fill"></i> Connections
                </a>
                <a href="dashboard.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-grid-fill"></i> Templates
                </a>
                <a href="analytics.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-bar-chart-fill"></i> Analytics
                </a>
                <a href="settings.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition">
                    <i class="bi bi-gear-fill"></i> Settings
                </a>
            </nav>
        </div>
        <div class="pt-6 border-t border-gray-800">
            <button onclick="logout()"
                class="flex items-center gap-2 text-gray-500 hover:text-white text-xs font-bold uppercase">
                <i class="bi bi-box-arrow-left"></i> Sign Out
            </button>
        </div>
    </aside>

    <main class="flex-1 relative">
        <div
            class="md:hidden p-4 flex justify-between items-center border-b border-gray-800 bg-brand-black sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button onclick="toggleMenu()" class="text-white text-2xl focus:outline-none">
                    <i class="bi bi-list"></i>
                </button>
                <div class="font-bold tracking-tight">CASTLE CREW</div>
            </div>
            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs">👤</div>
        </div>

        <div class="p-6 md:p-12 pb-32 md:pb-12 max-w-4xl mx-auto h-full md:overflow-y-auto">

            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-8 border-b border-gray-800">
                <div>
                    <h1 class="text-3xl font-black uppercase mb-1">My <span class="text-brand-red">Profile</span></h1>
                    <p class="text-gray-400 text-sm">Manage your account and card settings.</p>
                </div>
                <div class="mt-4 md:mt-0 text-right">
                    <div id="plan-badge"
                        class="inline-block bg-gray-800 text-white text-xs font-bold px-3 py-1 rounded uppercase tracking-wider">
                        Loading...</div>
                    <div id="member-since" class="mt-2 text-xs text-gray-500">Member since ...</div>
                    <div id="company-tag" class="hidden mt-2 text-xs text-blue-400 font-bold"></div>
                </div>
            </div>

            <!-- Products Section (Hidden Default) -->
            <div id="products-section" class="hidden-element">
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-8 border-b border-gray-800">
                    <div>
                        <h1 class="text-3xl font-black uppercase mb-1">My <span class="text-brand-red">Products</span>
                        </h1>
                        <p class="text-gray-400 text-sm">Manage your individual product cards.</p>
                    </div>
                    <div class="mt-4 md:mt-0 text-right">
                        <div id="license-usage" class="text-xl font-bold text-white">0 / 0</div>
                        <div class="text-xs text-gray-500 uppercase tracking-wider">Licenses Used</div>
                    </div>
                </div>

                <!-- Create Button -->
                <div class="mb-8">
                    <button onclick="openCreateProductModal()" id="btn-create-product"
                        class="bg-white text-black font-bold uppercase py-3 px-6 rounded hover:bg-gray-200 transition text-sm">
                        + Create Product Card
                    </button>
                    <p id="quota-warning" class="text-red-500 text-xs mt-2 hidden">License quota reached.</p>
                </div>

                <!-- Products Grid -->
                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be injected here -->
                    <div class="animate-pulse bg-gray-900 h-64 rounded-xl"></div>
                </div>
            </div>

            <!-- Create Product Modal -->
            <div id="create-product-modal"
                class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden-element flex items-center justify-center z-50">
                <div class="bg-[#111] w-full max-w-4xl p-6 rounded-2xl border border-gray-800 shadow-2xl relative">
                    <button onclick="closeCreateProductModal()"
                        class="absolute top-4 right-4 text-gray-500 hover:text-white z-50">✕</button>

                    <!-- STEP 1: TEMPLATE SELECTION -->
                    <div id="step-template">
                        <h2 class="text-xl font-bold mb-2">Select a Template</h2>
                        <p class="text-gray-400 text-sm mb-6">Choose how your product card will look.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Standard -->
                            <div onclick="selectTemplate('signature')" class="cursor-pointer group">
                                <div
                                    class="bg-gray-900 border border-gray-800 rounded-xl h-48 mb-3 overflow-hidden group-hover:border-brand-red transition relative">
                                    <div class="absolute inset-0 flex items-center justify-center text-gray-600"><i
                                            class="bi bi-person-badge text-4xl"></i></div>
                                </div>
                                <h3 class="font-bold text-sm group-hover:text-brand-red">Standard Profile</h3>
                                <p class="text-xs text-gray-500">Classic digital business card.</p>
                            </div>

                            <!-- Car Finance -->
                            <div onclick="selectTemplate('car')" class="cursor-pointer group">
                                <div
                                    class="bg-gray-100 border border-gray-800 rounded-xl h-48 mb-3 overflow-hidden group-hover:border-brand-red transition relative">
                                    <!-- Preview Mockup -->
                                    <div class="absolute inset-0 flex flex-col items-center justify-center p-4">
                                        <div class="w-full h-24 bg-gray-300 rounded mb-2"></div>
                                        <div class="w-2/3 h-2 bg-gray-300 rounded mb-1"></div>
                                        <div class="w-1/2 h-2 bg-gray-300 rounded"></div>
                                    </div>
                                    <div
                                        class="absolute top-2 right-2 bg-black text-white text-[10px] px-2 py-1 rounded font-bold">
                                        NEW</div>
                                </div>
                                <h3 class="font-bold text-sm group-hover:text-brand-red">Car Finance Offer</h3>
                                <p class="text-xs text-gray-500">Image-focused with pricing highlights.</p>
                            </div>

                            <!-- Real Estate -->
                            <div onclick="selectTemplate('realestate')" class="cursor-pointer group">
                                <div
                                    class="bg-gray-900 border border-gray-800 rounded-xl h-48 mb-3 overflow-hidden group-hover:border-brand-red transition relative">
                                    <div class="absolute inset-0 flex items-center justify-center text-gray-600"><i
                                            class="bi bi-house-door text-4xl"></i></div>
                                </div>
                                <h3 class="font-bold text-sm group-hover:text-brand-red">Real Estate</h3>
                                <p class="text-xs text-gray-500">Property listings and broker info.</p>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 2: DETAILS -->
                    <div id="step-details" class="hidden-element">
                        <div class="flex items-center gap-2 mb-6">
                            <button onclick="openCreateProductModal()" class="text-gray-500 hover:text-white"><i
                                    class="bi bi-arrow-left"></i> Back</button>
                            <h2 class="text-xl font-bold ml-auto mr-auto pr-10">Card Details</h2>
                        </div>

                        <form onsubmit="event.preventDefault(); createProductCard();"
                            class="space-y-4 max-w-sm mx-auto">
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Product
                                    Title</label>
                                <input type="text" id="new-product-title" required placeholder="e.g. BMW X5 2024"
                                    class="w-full bg-brand-dark border border-gray-800 rounded px-3 py-2 text-white focus:border-brand-red focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">URL Slug</label>
                                <input type="text" id="new-product-slug" required placeholder="bmw-x5-offer"
                                    class="w-full bg-brand-dark border border-gray-800 rounded px-3 py-2 text-white focus:border-brand-red focus:outline-none">
                                <p class="text-[10px] text-gray-600 mt-1">castlecrew.cc/...</p>
                            </div>
                            <div class="pt-2">
                                <button type="submit" id="btn-submit-product"
                                    class="w-full bg-brand-red text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">
                                    CREATE CARD
                                </button>
                                <p id="create-product-error" class="text-red-500 text-xs mt-2 hidden"></p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Existing Content Wrapper (Add ID to toggle it) -->
            <div id="profile-summary">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">


                    <a href="leads.html"
                        class="bg-brand-dark border border-gray-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-brand-red transition group">
                        <div
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-brand-red group-hover:text-white transition text-gray-400">
                            <i class="bi bi-people-fill text-lg"></i>
                        </div>
                        <span
                            class="text-[10px] font-bold text-gray-400 group-hover:text-white uppercase tracking-wider">Connections</span>
                    </a>

                    <a href="dashboard.html"
                        class="bg-brand-dark border border-gray-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-brand-red transition group">
                        <div
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-brand-red group-hover:text-white transition text-gray-400">
                            <i class="bi bi-grid-fill text-lg"></i>
                        </div>
                        <span
                            class="text-[10px] font-bold text-gray-400 group-hover:text-white uppercase tracking-wider">Templates</span>
                    </a>

                    <a href="analytics.html"
                        class="bg-brand-dark border border-gray-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-brand-red transition group">
                        <div
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-brand-red group-hover:text-white transition text-gray-400">
                            <i class="bi bi-bar-chart-fill text-lg"></i>
                        </div>
                        <span
                            class="text-[10px] font-bold text-gray-400 group-hover:text-white uppercase tracking-wider">Analytics</span>
                    </a>

                    <a href="settings.html"
                        class="bg-brand-dark border border-gray-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:border-brand-red transition group">
                        <div
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center group-hover:bg-brand-red group-hover:text-white transition text-gray-400">
                            <i class="bi bi-gear-fill text-lg"></i>
                        </div>
                        <span
                            class="text-[10px] font-bold text-gray-400 group-hover:text-white uppercase tracking-wider">Settings</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                    <div class="bg-brand-dark border border-gray-800 rounded-2xl p-8 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-50 group-hover:opacity-100 transition">
                            <i class="bi bi-nfc text-6xl text-brand-red/20"></i>
                        </div>

                        <h3 class="text-lg font-bold mb-6">Active Card</h3>

                        <div class="mb-6">
                            <p class="text-gray-500 text-xs uppercase font-bold mb-1">Your Link</p>
                            <a id="profile-link" href="#" target="_blank"
                                class="text-xl font-mono text-brand-red hover:underline">...</a>
                        </div>

                        <div class="mb-8">
                            <p class="text-gray-500 text-xs uppercase font-bold mb-1">Current Theme</p>
                            <p id="profile-theme" class="text-white font-bold capitalize">...</p>
                        </div>

                        <div class="flex gap-3 flex-wrap">
                            <a href="editor.html"
                                class="bg-white text-black px-6 py-3 rounded-lg text-sm font-bold hover:bg-gray-200 transition">Edit
                                Card</a>
                            <button onclick="shareLink()"
                                class="border border-gray-700 px-4 py-3 rounded-lg text-sm font-bold hover:bg-gray-800"><i
                                    class="bi bi-share-fill"></i></button>
                            <button onclick="addToWallet()" id="btn-wallet"
                                class="bg-black border border-gray-700 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-gray-800 flex items-center gap-2">
                                <i class="bi bi-wallet-fill"></i> <span>Google Wallet</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-brand-dark border border-gray-800 rounded-2xl p-8 flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-2">Subscription</h3>
                            <p id="plan-desc" class="text-gray-400 text-sm mb-6">You are currently on the Free Starter
                                plan.
                            </p>
                            <ul id="plan-features" class="space-y-2 text-sm text-gray-300 mb-6"></ul>
                        </div>

                        <a href="pricing.html" id="btn-upgrade"
                            class="block w-full text-center border border-brand-red text-brand-red py-3 rounded-lg text-sm font-bold hover:bg-brand-red hover:text-white transition">
                            UPGRADE PLAN
                        </a>
                    </div>
                </div>
            </div>
    </main>

    <div id="mobile-menu"
        class="fixed inset-0 bg-[#050505]/95 backdrop-blur-xl z-50 hidden flex-col p-6 transition-opacity duration-300">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2 text-xl font-bold tracking-tight">
                <div class="w-3 h-3 bg-brand-red rotate-45"></div> CASTLE CREW
            </div>
            <button onclick="toggleMenu()" class="text-gray-400 text-3xl"><i class="bi bi-x"></i></button>
        </div>
        <nav class="space-y-4 text-lg">
            <a href="index.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition">
                <i class="bi bi-house-door-fill text-xl"></i> Home Page
            </a>
            <a href="profile.html"
                class="flex items-center gap-4 py-2 text-brand-red font-bold border-b border-brand-red/30 transition"><i
                    class="bi bi-person-circle text-xl"></i> Profile</a>
            <a href="profile.html?view=products"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-box-seam-fill text-xl"></i> Products</a>
            <a href="product_leads.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-inboxes-fill text-xl"></i> Product Leads</a>
            <a href="leads.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-people-fill text-xl"></i> Connections</a>
            <a href="dashboard.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-grid-fill text-xl"></i> Templates</a>
            <a href="analytics.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-bar-chart-fill text-xl"></i> Analytics</a>

            <!-- Admin Panel Link (Mobile) -->
            <a href="#" id="mobile-admin-panel-link"
                class="hidden flex items-center gap-4 py-2 text-blue-500 hover:text-blue-400 border-b border-blue-900/30 transition font-bold"><i
                    class="bi bi-shield-lock-fill text-xl"></i> Admin Panel</a>
            <a href="settings.html"
                class="flex items-center gap-4 py-2 text-gray-400 hover:text-white border-b border-gray-800 transition"><i
                    class="bi bi-gear-fill text-xl"></i> Settings</a>
        </nav>
        <div class="mt-auto">
            <button onclick="logout()"
                class="flex items-center gap-3 text-gray-500 hover:text-white font-bold uppercase transition"><i
                    class="bi bi-box-arrow-left text-xl"></i> Sign Out</button>
        </div>
    </div>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        }

        async function loadProfile() {
            const token = localStorage.getItem('castle_token');
            if (!token) return window.location.href = 'login.html';

            try {
                // Fetch card data (plan, enterprise context)
                const res = await fetch('/api/card', { headers: { 'Authorization': token } });
                const data = await res.json();



                const plan = data.plan || 'starter';
                const enterpriseId = data.enterprise_id;
                const companyName = data.company_name;

                // 1. Set Member Date
                if (data.created_at) {
                    const date = new Date(data.created_at);
                    document.getElementById('member-since').innerText = `Member since ${date.getFullYear()}`;
                }

                // 2. Set Active Card Details
                if (data.slug) {
                    document.getElementById('profile-link').href = `/${data.slug}`;
                    document.getElementById('profile-link').innerText = `castlecrew.cc/${data.slug}`;
                } else {
                    document.getElementById('profile-link').href = '#';
                    document.getElementById('profile-link').innerText = "Link Not Set";
                    document.getElementById('profile-link').classList.add('opacity-50', 'pointer-events-none');
                }

                // Show Admin Panel if Super Admin or Delegated Admin
                // DEBUG: checking why role validation fails
                // console.log("Debug Role:", data.role, "Enterprise:", data.enterprise_id);

                if (data.role === 'super_admin') {
                    const adminLink = document.getElementById('admin-panel-link');
                    const mLink = document.getElementById('mobile-admin-panel-link');
                    const target = 'enterprise_super_admin_dashboard.html';

                    if (adminLink) { adminLink.href = target; adminLink.classList.remove('hidden'); adminLink.classList.add('flex'); }
                    if (mLink) { mLink.href = target; mLink.classList.remove('hidden'); mLink.classList.add('flex'); }

                } else if (data.role === 'admin' && data.enterprise_id) {
                    const adminLink = document.getElementById('admin-panel-link');
                    const mLink = document.getElementById('mobile-admin-panel-link');
                    const target = 'enterprise_admin_dashboard.html';

                    if (adminLink) { adminLink.href = target; adminLink.classList.remove('hidden'); adminLink.classList.add('flex'); }
                    if (mLink) { mLink.href = target; mLink.classList.remove('hidden'); mLink.classList.add('flex'); }

                } else if (data.enterprise_id) {
                    // Fallback Debug: If they have enterprise_id but role is not admin
                    console.warn("User has enterprise_id but role is: " + data.role);
                }

                let themeName = "Castle Signature";
                if (data.template_id === 'realestate') themeName = "Eco Real Estate";
                if (data.template_id === 'creative') themeName = "The Creative";
                document.getElementById('profile-theme').innerText = themeName;

                // 3. Conditional UI for Plan/Subscription
                const planBadge = document.getElementById('plan-badge');
                const planDesc = document.getElementById('plan-desc');
                const planFeatures = document.getElementById('plan-features');
                const btnUpgrade = document.getElementById('btn-upgrade');
                const companyTag = document.getElementById('company-tag');

                if (enterpriseId) {
                    // Enterprise Staff UI
                    if (data.role === 'super_admin') {
                        planBadge.innerText = "ENTERPRISE SUPER ADMIN";
                    } else if (data.role === 'admin') {
                        planBadge.innerText = "ENTERPRISE ADMIN";
                    } else {
                        planBadge.innerText = "ENTERPRISE STAFF";
                    }
                    planBadge.classList.add('bg-blue-600');
                    planBadge.classList.remove('bg-gray-800');

                    planDesc.innerText = `Managed under the ${companyName || 'Enterprise'} license. Full features unlocked.`;
                    planFeatures.innerHTML = `<li class="flex gap-2 text-white"><i class="bi bi-check text-green-500"></i> Corporate License Active</li><li class="flex gap-2 text-white"><i class="bi bi-check text-green-500"></i> All Themes Unlocked</li>`;
                    btnUpgrade.style.display = 'none'; // Hide upgrade button

                    companyTag.innerText = `Managed by ${companyName}`;
                    companyTag.classList.remove('hidden');

                    // Show Products Link for Enterprise Staff (Non-Admins)
                    const prodLink = document.getElementById('nav-products');
                    if (prodLink && data.role !== 'admin' && data.role !== 'super_admin') {
                        prodLink.classList.remove('hidden');
                        prodLink.classList.add('flex');
                    }

                } else if (plan === 'starter') {
                    // Individual Starter UI
                    planBadge.innerText = "STARTER PLAN";
                    planBadge.classList.remove('bg-brand-red');
                    planBadge.classList.add('bg-gray-800');

                    planDesc.innerText = "Basic features active. Upgrade to unlock all themes.";
                    planFeatures.innerHTML = `<li class="flex gap-2"><i class="bi bi-check text-green-500"></i> Castle Signature Theme</li><li class="flex gap-2 text-red-500"><i class="bi bi-x"></i> Premium Themes Locked</li>`;
                    btnUpgrade.style.display = 'block';

                } else {
                    // Individual Pro/Exec UI
                    planBadge.innerText = plan.toUpperCase() + " MEMBER";
                    planBadge.classList.add('bg-brand-red');
                    planBadge.classList.remove('bg-gray-800');

                    planDesc.innerText = "You have full access to all features.";
                    planFeatures.innerHTML = `<li class="flex gap-2 text-white"><i class="bi bi-check text-green-500"></i> All Themes Unlocked</li>`;
                    btnUpgrade.style.display = 'none';
                }

            } catch (e) { console.error(e); }
        }

        function logout() { localStorage.removeItem('castle_token'); window.location.href = 'index.html'; }
        function shareLink() { navigator.clipboard.writeText(document.getElementById('profile-link').href); alert("Copied!"); }

        // --- PRODUCTS & TEMPLATES LOGIC ---
        let selectedTemplateId = 'signature';

        function showSection(sectionId) {
            document.getElementById('profile-summary').classList.add('hidden-element');
            document.getElementById('products-section').classList.add('hidden-element');

            if (sectionId === 'profile') {
                document.getElementById('profile-summary').classList.remove('hidden-element');
            } else if (sectionId === 'products') {
                document.getElementById('products-section').classList.remove('hidden-element');
                loadProducts();
            }
        }

        async function loadProducts() {
            const token = localStorage.getItem('castle_token');
            const grid = document.getElementById('products-grid');
            const badge = document.getElementById('license-usage');

            try {
                const res = await fetch('/api/user/products', { headers: { 'Authorization': token } });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                const productCards = data.cards.filter(c => c.parent_id);
                const count = productCards.length;
                badge.innerText = `${count} / ${data.sub_license_count}`;

                let blockCreation = false;
                let warningMsg = "";

                if (count >= data.sub_license_count) {
                    blockCreation = true;
                    warningMsg = "Individual license quota reached.";
                } else if (data.enterprise && data.enterprise.used >= data.enterprise.total) {
                    blockCreation = true;
                    warningMsg = "Enterprise-wide sub-license limit reached. Please contact your admin.";
                }

                if (blockCreation) {
                    const warnEl = document.getElementById('quota-warning');
                    warnEl.innerText = warningMsg;
                    warnEl.classList.remove('hidden');
                    document.getElementById('btn-create-product').disabled = true;
                    document.getElementById('btn-create-product').classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    document.getElementById('quota-warning').classList.add('hidden');
                    document.getElementById('btn-create-product').disabled = false;
                    document.getElementById('btn-create-product').classList.remove('opacity-50', 'cursor-not-allowed');
                }

                // Removed old index-based filter

                if (productCards.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">No product cards created yet.</div>';
                    return;
                }

                grid.innerHTML = productCards.map(card => {
                    let design = {};
                    try { design = JSON.parse(card.design || '{}'); } catch (e) { }
                    const gateMode = design.gate_mode || 'optional'; // Default to optional for existing cards if logic active

                    return `
                    <div class="bg-brand-dark border border-gray-800 rounded-xl p-5 hover:border-gray-600 transition group relative flex flex-col">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="font-bold text-lg truncate pr-4">${card.title || 'Untitled'}</h3>
                            <a href="/${card.slug}" target="_blank" class="text-xs bg-gray-800 px-2 py-1 rounded text-gray-400 hover:text-white"><i class="bi bi-box-arrow-up-right"></i></a>
                        </div>
                        <p class="text-xs text-gray-500 mb-2 font-mono">/${card.slug}</p>
                        
                        <div class="mb-4 flex items-center justify-between bg-black/30 p-2 rounded border border-white/5">
                            <span class="text-[10px] text-gray-400 font-bold uppercase flex items-center gap-1"><i class="bi bi-person-lines-fill"></i> Lead Gate</span>
                            <select onchange="updateGateMode('${card.slug}', this.value)" class="text-[10px] uppercase font-bold bg-brand-dark border border-gray-700 rounded text-white px-2 py-1 outline-none focus:border-brand-red cursor-pointer hover:border-gray-500">
                                <option value="off" ${gateMode === 'off' ? 'selected' : ''}>Off</option>
                                <option value="optional" ${gateMode === 'optional' ? 'selected' : ''}>Optional</option>
                                <option value="mandatory" ${gateMode === 'mandatory' ? 'selected' : ''}>Mandatory</option>
                            </select>
                        </div>

                        <div class="flex gap-2 mt-auto">
                            <button onclick="window.location.href='product_editor.html?slug=${card.slug}'" class="flex-1 bg-white text-black text-xs font-bold py-2 rounded hover:bg-gray-200">EDIT</button>
                            <button onclick="downloadQrPdf('${card.slug}', '${(card.title || 'Product').replace(/'/g, "\\'")}')" class="flex-1 bg-green-600 text-white text-xs font-bold py-2 rounded hover:bg-green-700"><i class="bi bi-qr-code"></i> QR PDF</button>
                            <button onclick="deleteProduct('${card.slug}')" class="px-3 bg-red-900/20 text-red-500 rounded hover:bg-red-900/40"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `}).join('');

            } catch (e) { console.error(e); }
        }

        async function updateGateMode(slug, mode) {
            const token = localStorage.getItem('castle_token');
            try {
                // 1. Fetch current data to preserve other fields
                const resGet = await fetch(`/api/card?slug=${slug}`, { headers: { 'Authorization': token } });
                const cardData = await resGet.json();

                if (!cardData.id) throw new Error("Card not found");

                // Helper to clean fields (Handling Double-Stringification caused by API mismatch)
                const parseField = (val, defaultVal) => {
                    if (val === undefined || val === null) return defaultVal;
                    try {
                        if (typeof val === 'string') {
                            let parsed = JSON.parse(val);
                            // Check for double encoding
                            if (typeof parsed === 'string') {
                                try { parsed = JSON.parse(parsed); } catch (e) { }
                            }
                            return parsed;
                        }
                        return val;
                    } catch (e) { return defaultVal; }
                };

                // 2. sanitize fields
                cardData.design = parseField(cardData.design, {});
                cardData.socials = parseField(cardData.socials, {});
                cardData.phones = parseField(cardData.phones, []);
                cardData.emails = parseField(cardData.emails, []);
                cardData.gallery = parseField(cardData.gallery, []);

                // 3. Update Design
                cardData.design.gate_mode = mode;

                // 3. Save
                const resPost = await fetch('/api/card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(cardData)
                });

                if (!resPost.ok) {
                    const err = await resPost.json();
                    alert("Failed to save setting: " + (err.error || "Unknown"));
                }
            } catch (e) {
                console.error(e);
                alert("Connection error while saving setting.");
            }
        }

        function openCreateProductModal() {
            // Reset state
            selectedTemplateId = 'signature';
            document.getElementById('step-template').classList.remove('hidden-element');
            document.getElementById('step-details').classList.add('hidden-element');
            document.getElementById('new-product-title').value = '';
            document.getElementById('new-product-slug').value = '';
            document.getElementById('create-product-modal').classList.remove('hidden-element');
        }

        function closeCreateProductModal() {
            document.getElementById('create-product-modal').classList.add('hidden-element');
        }

        function selectTemplate(tmpl) {
            selectedTemplateId = tmpl;
            // Highlight selection visually if needed (optional)
            // Move to next step
            document.getElementById('step-template').classList.add('hidden-element');
            document.getElementById('step-details').classList.remove('hidden-element');
        }

        async function createProductCard() {
            const btn = document.getElementById('btn-submit-product');
            const err = document.getElementById('create-product-error');
            const title = document.getElementById('new-product-title').value;
            const slug = document.getElementById('new-product-slug').value.trim();

            btn.innerText = "CREATING...";
            btn.disabled = true;
            err.classList.add('hidden');

            try {
                const token = localStorage.getItem('castle_token');
                const res = await fetch('/api/user/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ title, slug, template_id: selectedTemplateId })
                });
                const data = await res.json();

                if (res.ok) {
                    closeCreateProductModal();
                    alert("Product Card Created!");
                    // Redirect to editor for the new card?
                    // Verify if the API returns the slug or we just use the one we sent.
                    // The API doesn't return the slug in the body, but satisfied with success: true.
                    // Let's redirect to editor to populate it immediately.
                    // Wait, editor needs to know WHICH card to load.
                    // Editor typically loads the MAIN card if no param.
                    // We should pass ?slug=... to editor!
                    window.location.href = `product_editor.html?slug=${slug}`;
                } else {
                    err.innerText = data.error || "Failed to create.";
                    err.classList.remove('hidden');
                }
            } catch (e) {
                err.innerText = "Connection error.";
                err.classList.remove('hidden');
            }
            btn.innerText = "CREATE CARD";
            btn.disabled = false;
        }

        async function deleteProduct(slug) {
            if (!confirm("Are you sure? This cannot be undone.")) return;

            try {
                const token = localStorage.getItem('castle_token');
                const res = await fetch(`/api/user/products?slug=${slug}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': token }
                });

                if (res.ok) {
                    alert("Product deleted!");
                    loadProducts(); // Refresh list
                } else {
                    const data = await res.json();
                    alert("Failed to delete: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                alert("Connection error deleting product.");
            }
        }


        async function addToWallet() {
            const btn = document.getElementById('btn-wallet');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>Loading...</span>';
            btn.disabled = true;

            try {
                const token = localStorage.getItem('castle_token');
                const res = await fetch('/api/create-wallet-pass', {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });

                const data = await res.json();

                if (res.ok && data.saveUrl) {
                    // Open the save URL in a new tab
                    window.open(data.saveUrl, '_blank');
                } else {
                    alert('Failed to create wallet pass: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('An error occurred while connecting to the server.');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function downloadQrPdf(slug, title) {
            try {
                const url = `https://castlecrew.cc/${slug}`;

                // 1. Generate QR Data URL
                // Check if QRCode lib is loaded
                if (typeof QRCode === 'undefined') { alert("Library loading..."); return; }

                const qrDataUrl = await QRCode.toDataURL(url, { width: 500, margin: 2, color: { dark: '#000000', light: '#ffffff' } });

                // 2. Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // 3. Add Content
                // Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(24);
                // Split title if too long
                const splitTitle = doc.splitTextToSize(title.toUpperCase(), 180);
                doc.text(splitTitle, 105, 40, { align: "center" });

                // URL
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100);
                doc.text(url, 105, 55 + (splitTitle.length * 5), { align: "center" });

                // QR Image (Centered)
                // y-pos depends on title length
                const yPos = 65 + (splitTitle.length * 5);
                doc.addImage(qrDataUrl, 'PNG', 55, yPos, 100, 100);

                // Footer
                doc.setTextColor(0);
                doc.setFontSize(10);
                doc.text("SCAN TO VIEW DETAILS", 105, yPos + 110, { align: "center" });

                // 4. Save
                doc.save(`${slug}-qr.pdf`);

            } catch (e) {
                console.error(e);
                alert("Failed to generate PDF. Please try again.");
            }
        }

        // Preloader Logic (NEW)
        document.addEventListener('DOMContentLoaded', () => {
            const preloader = document.getElementById('preloader');
            // Slight delay to ensure the animations are seen
            setTimeout(() => {
                preloader.classList.add('fade-out');
                // Remove from DOM after transition to clean up
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 700);
            }, 800);
        });

        // Check for view param on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('view') === 'products') {
                // Wait for profile to load? Or just switch?
                // showSection relies on DOM elements.
                // We'll set a slight timeout or just call it.
                setTimeout(() => showSection('products'), 500);

                // Highlight Sidebar Logic
                const pLink = document.getElementById('nav-link-profile');
                const prodLink = document.getElementById('nav-link-products');
                if (pLink && prodLink) {
                    pLink.className = "flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg text-sm font-medium transition";
                    prodLink.className = "flex items-center gap-3 px-4 py-3 bg-brand-red/10 text-brand-red rounded-lg text-sm font-bold";
                }
            }
        });

        loadProfile();
    </script>
</body>

</html>